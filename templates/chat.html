<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KBU hub | 채팅</title>
  <link rel="icon" href="{{ url_for("static", filename="images/logo.png") }}">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
   <link rel="stylesheet" href="{{ url_for("static", filename="css/nav.css") }}">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { peach: '#FFC8B2', peachDeep: '#FF9F80', cream: '#FFF7F2', cocoa:'#6B7280', ink:'#1F2937', mint:'#B7F4E6', lemon:'#FFF3A3' },
          boxShadow: { soft:'0 10px 30px rgba(255,159,128,.18)', glow:'0 0 0 0 rgba(255,159,128,.0)', card:'0 10px 24px rgba(17,24,39,.08)' },
          borderRadius: { bubble:'999px', xl2:'1.25rem' }
        }
      }
    }
  </script>
  <style>
    html, body { font-family: Pretendard, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif; }
    .top-grad{ background: radial-gradient(60% 60% at 0% 0%, #FFF0E7 0%, rgba(255,240,231,0) 60%), radial-gradient(60% 60% at 100% 0%, #FFE7DB 0%, rgba(255,231,219,0) 60%); }
    .glass{ background: rgba(255,255,255,.7); backdrop-filter: blur(10px); }
     /* 네비게이션 스타일은 nav.css (CSS Cascade Layers)에서 관리 */
    
    /* 헤더 스타일은 nav.css에서 관리 */
    
    /* 반응형 네비게이션 스타일은 nav.css에서 관리 */
    
    /* 채팅 레이아웃 */
    .chat-layout { 
        display: grid; 
        grid-template-columns: 280px 1fr; 
        gap: 24px; 
        padding: 24px; 
        max-width: 1200px; 
        margin: 0 auto;
        min-height: calc(100vh - 160px);
        align-items: start;
    }
    
    /* 사이드바 컬럼 */
    .sidebar-column {
        display: flex;
        flex-direction: column;
        gap: 16px;
        height: fit-content;
        overflow-y: visible;
        position: sticky;
        top: 100px;
        align-self: flex-start;
    }
    
    /* 사이드바 카드 공통 스타일 */
    .sidebar-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 24px rgba(17, 24, 39, 0.08);
        overflow: hidden;
        transition: all 0.3s ease;
        height: fit-content;
    }
    
    .sidebar-card:hover {
        box-shadow: 0 20px 40px rgba(17, 24, 39, 0.12);
        transform: translateY(-2px);
    }
    
    .sidebar-card-header {
        padding: 20px 20px 12px;
        border-bottom: 1px solid rgba(255, 159, 124, 0.1);
    }
    
    .sidebar-card-title {
        font-size: 16px;
        font-weight: 600;
        color: #1F2937;
        margin: 0;
    }
    
    .sidebar-card-body {
        padding: 16px 20px 20px;
    }
    
    /* 반응형 채팅 레이아웃 */
    @media (max-width: 1024px) {
        .chat-layout {
            grid-template-columns: 280px 1fr;
            gap: 16px;
            padding: 20px;
        }
    }
    
    @media (max-width: 768px) {
        .chat-layout {
            grid-template-columns: 1fr;
            gap: 16px;
            padding: 16px;
            margin-top: 70px;
        }
        
        .sidebar-panel {
            position: relative;
            top: 0;
            max-height: 300px;
            margin-bottom: 20px;
        }
    }
    
    @media (max-width: 640px) {
        .chat-layout {
            padding: 12px;
            margin-top: 65px;
        }
    }
    
    .panel { 
        background: #fff; 
        border-radius: 16px; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
        border: 1px solid rgba(255, 200, 178, 0.2);
        overflow: hidden;
    }
    
    .sidebar-panel {
        height: fit-content;
        max-height: calc(100vh - 330px);
        position: sticky;
        top: 100px;
        overflow-y: auto;
        z-index: 10;
    }
    
    .main-panel {
        height: fit-content;
        min-height: 500px;
    }
    
    .panel-header { 
        padding: 16px 20px; 
        border-bottom: 1px solid #f0f0f0; 
        font-weight: 700; 
        background: linear-gradient(135deg, #FFF7F2, #ffffff);
        font-size: 16px;
    }
    
    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        position: relative;
    }
    
    .header-left {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .header-right {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .participant-count-header {
        font-size: 12px;
        color: #6B7280;
        font-weight: 400;
    }
    
    .panel-body { 
        padding: 16px 20px; 
    }
    
    .sidebar-body {
        padding: 16px 20px;
        max-height: calc(100vh - 350px);
        overflow-y: auto;
    }
    
    /* 사이드바 스타일 */
    .sidebar-section {
        margin-bottom: 24px;
    }
    
    .sidebar-section:last-child {
        margin-bottom: 0;
    }
    
    .sidebar-title {
        font-size: 14px;
        font-weight: 600;
        color: #6B7280;
        margin-bottom: 8px;
        padding: 0 4px;
    }
    
    .room-list { 
        list-style: none; 
        margin: 0; 
        padding: 0; 
    }
    
    .room-list li { 
        padding: 12px 16px; 
        border-radius: 12px; 
        cursor: pointer; 
        margin-bottom: 4px;
        transition: all 0.3s ease;
        font-size: 14px;
        color: #374151;
    }
    
    .room-list li:hover { 
        background: #FFF0E5; 
        transform: translateX(4px);
    }
    
    .room-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }
    
    .room-name {
        font-weight: 600;
        color: #333;
    }
    
    .participant-count {
        font-size: 12px;
        color: #FF8C42;
        background: #FFE4D1;
        padding: 4px 10px;
        border-radius: 16px;
        font-weight: 600;
        margin-left: auto;
    }
    
    .room-name-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .unread-badge {
        background: #dc2626;
        color: white;
        font-size: 11px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 10px;
        min-width: 18px;
        text-align: center;
        line-height: 1.2;
    }
    
    .room-list li.active { 
        background: linear-gradient(135deg, #FF9F80, #FFC8B2);
        color: white;
        box-shadow: 0 4px 12px rgba(255, 159, 128, 0.3);
    }
    
    /* 프로필 카드 */
    .profile-card {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 20px;
        background: linear-gradient(135deg, #FFF7F2, #ffffff);
        border-radius: 16px;
        margin-bottom: 20px;
        border: 1px solid rgba(255, 200, 178, 0.3);
    }
    
    .profile-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #FF9F80, #FFC8B2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: white;
        box-shadow: 0 4px 12px rgba(255, 159, 128, 0.3);
    }
    
    .profile-info {
        flex: 1;
    }
    
    .profile-name {
        font-weight: 700;
        font-size: 18px;
        color: #1F2937;
        margin-bottom: 4px;
    }
    
    .profile-details {
        font-size: 14px;
        color: #6B7280;
        margin-bottom: 2px;
    }
    
    .profile-bio {
        font-size: 13px;
        color: #9CA3AF;
        margin-top: 8px;
        line-height: 1.4;
    }
    
    .profile-actions {
        display: flex;
        gap: 8px;
    }
    
    .btn-edit {
        padding: 8px 12px;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        font-size: 12px;
        color: #6c757d;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .btn-edit:hover {
        background: #e9ecef;
        border-color: #FF9F80;
        color: #495057;
    }
    
    /* 매칭 섹션 */
    .matching-grid {
            display: grid; 
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .matching-card {
            background: #fff; 
        border: 1px solid #f0f0f0;
        border-radius: 16px;
        padding: 32px 24px;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .matching-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 159, 128, 0.02) 0%, rgba(255, 200, 178, 0.05) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .matching-card:hover::before {
        opacity: 1;
    }
    
    .matching-card:hover {
        border-color: #FF9F80;
        box-shadow: 0 8px 24px rgba(255, 159, 128, 0.15);
        transform: translateY(-4px);
    }
    
    .matching-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto 16px;
        background: linear-gradient(135deg, #FF9F80, #FFC8B2);
            border-radius: 12px; 
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        position: relative;
        z-index: 1;
    }
    
    .matching-title {
            font-weight: 700; 
        font-size: 18px;
        margin-bottom: 8px;
        color: #1F2937;
        position: relative;
        z-index: 1;
    }
    
    .matching-desc {
        font-size: 14px;
        color: #6B7280;
        margin-bottom: 24px;
        line-height: 1.5;
        position: relative;
        z-index: 1;
    }
    
    .btn {
        padding: 14px 24px;
        border: none;
        border-radius: 12px;
            cursor: pointer; 
        font-weight: 600;
        font-size: 14px;
            transition: all 0.3s ease;
        width: 100%;
        position: relative;
        z-index: 1;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #FF9F80, #FFC8B2);
        color: white;
        box-shadow: 0 4px 12px rgba(255, 159, 128, 0.3);
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 159, 128, 0.4);
        background: linear-gradient(135deg, #FF8A6B, #FFB89D);
    }
    
    .btn-secondary {
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }
    
    .btn-secondary:hover {
        background: #e9ecef;
        border-color: #adb5bd;
    }
    
    /* 매칭 상태 */
    .matching-status {
        text-align: center;
        padding: 16px;
        display: none;
    }
    
    .matching-spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #FF9F80;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 12px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .matching-text {
        font-weight: 600;
        color: #FF9F80;
        margin-bottom: 8px;
    }
    
    .matching-timer {
        font-size: 14px;
        color: #6B7280;
        margin-bottom: 12px;
    }
    
    /* 채팅 화면 */
        .messages { 
        height: 400px; 
        overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
        gap: 12px;
        padding: 16px;
        background: #fafafa;
        border-radius: 12px;
        margin-bottom: 16px;
        align-items: flex-start;
    }
    
        .msg { 
            max-width: 70%; 
        padding: 12px 16px; 
        border-radius: 16px; 
        background: #fff; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        font-size: 14px;
        line-height: 1.4;
        position: relative;
        display: inline-block;
        word-wrap: break-word;
    }
    
        .msg.me { 
            align-self: flex-end; 
        background: linear-gradient(135deg, #FF9F80, #FFC8B2); 
            color: #fff; 
        }
        
        .msg-wrapper {
            display: flex;
        width: 100%;
            margin-bottom: 8px;
        }
        
        .msg-wrapper.me {
            justify-content: flex-end;
        }
    
    .msg-content {
        margin-bottom: 4px;
    }
    
    .msg-time {
        font-size: 11px;
        opacity: 0.7;
        text-align: right;
        margin-top: 4px;
    }
    
    .msg-nickname {
        font-size: 12px;
        color: #FF9F80;
        font-weight: 600;
        margin-bottom: 4px;
        display: block;
    }
    
    .msg.me .msg-nickname {
        display: none;
    }
    
    .msg.me .msg-time {
        color: rgba(255, 255, 255, 0.8);
    }
    
    .msg:not(.me) .msg-time {
        color: #999;
    }
    
        .composer { 
            display: flex; 
        gap: 12px; 
        padding: 16px;
        background: #f8f9fa;
        border-radius: 12px;
    }
    
        .composer input { 
        flex: 4; 
        padding: 12px 16px; 
        border: 1px solid #e9ecef; 
            border-radius: 10px; 
        font-size: 14px;
        background: white;
        min-width: 0;
    }
    
    .composer .btn {
        flex: 1;
        min-width: 80px;
        white-space: nowrap;
    }
    
    /* 헤더 홈 버튼 */
    .btn-home {
        background: linear-gradient(135deg, #FF9F80, #FFC8B2);
            border: none;
        color: white;
        padding: 8px 12px;
            border-radius: 8px;
        font-size: 13px;
            font-weight: 600;
        cursor: pointer;
            transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 2px 8px rgba(255, 159, 128, 0.3);
    }
    
    .btn-home:hover {
        background: linear-gradient(135deg, #FF8A6B, #FFB89D);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 159, 128, 0.4);
    }
    
    .btn-home svg {
        width: 14px;
        height: 14px;
    }
    
    /* 채팅 옵션 버튼 */
    .btn-options {
        background: transparent;
            border: none;
        color: #6B7280;
        padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-options:hover {
        background: rgba(107, 114, 128, 0.1);
        color: #374151;
    }
    
    /* 채팅 옵션 드롭다운 */
    .chat-options-dropdown {
        position: fixed;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        min-width: 200px;
        z-index: 1000;
        overflow: hidden;
    }
    
    .dropdown-header {
        padding: 12px 16px;
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .dropdown-item {
        padding: 12px 16px;
        font-size: 14px;
        color: #374151;
        cursor: pointer;
        display: flex;
        align-items: center;
            gap: 12px;
        transition: background-color 0.2s ease;
    }
    
    .dropdown-item:hover {
        background: #f3f4f6;
    }
    
    .dropdown-item.danger {
        color: #dc2626;
    }
    
    .dropdown-item.danger:hover {
        background: #fef2f2;
    }
    
    .dropdown-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 4px 0;
    }
    
    /* 모달 스타일 */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
            width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }
    
    .modal-content {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f9fafb;
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #374151;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6B7280;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }
    
    .modal-close:hover {
        background: #e5e7eb;
        color: #374151;
    }
    
    .modal-body {
            padding: 24px; 
        max-height: 60vh;
        overflow-y: auto;
    }
    
    /* 참여자 목록 스타일 */
    .participants-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .participant-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border: 1px solid #e5e7eb;
            border-radius: 12px; 
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
    }
    
    .participant-item:hover {
        border-color: #FF9F80;
        background: #FFF7F2;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 159, 128, 0.2);
    }
    
    .participant-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
            background: linear-gradient(135deg, #FF9F80, #FFC8B2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        margin-right: 12px;
    }
    
    .participant-info {
        flex: 1;
    }
    
    .participant-name {
        font-weight: 600;
        color: #374151;
            margin-bottom: 4px;
    }
    
    .participant-status {
        font-size: 12px;
        color: #6B7280;
    }
    
    /* 참여자 프로필 스타일 */
    .participant-profile {
        text-align: center;
    }
    
    .profile-avatar-large {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #FF9F80, #FFC8B2);
            display: flex; 
        align-items: center;
        justify-content: center;
        font-size: 36px;
        margin: 0 auto 20px;
    }
    
    .profile-details {
        text-align: left;
        margin-top: 20px;
    }
    
    .profile-detail-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .profile-detail-label {
        font-weight: 600;
        color: #6B7280;
    }
    
    .profile-detail-value {
        color: #374151;
    }
    
    /* 랜덤 매칭 프로필 섹션 */
    .random-matching-section {
        margin: 24px 0;
    }
    
    .section-header {
        margin-bottom: 16px;
    }
    
    .section-title {
        font-size: 18px;
        font-weight: 700;
        color: #374151;
            display: flex; 
        align-items: center;
            gap: 8px; 
    }
    
    .profile-carousel {
        position: relative;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .carousel-btn {
        background: #f3f4f6;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #6b7280;
        flex-shrink: 0;
    }
    
    .carousel-btn:hover {
        background: #e5e7eb;
        color: #374151;
        transform: scale(1.05);
    }
    
    .profile-cards-container {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        scroll-behavior: smooth;
        padding: 8px 0;
            flex: 1; 
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    
    .profile-cards-container::-webkit-scrollbar {
        display: none;
    }
    
    .random-profile-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        min-width: 200px;
        max-width: 200px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        text-align: center;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }
    
    .random-profile-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    
    .random-profile-avatar {
        width: 60px;
        height: 60px;
            border-radius: 50%;
        background: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: 600;
        color: #6b7280;
        margin: 0 auto 12px;
    }
    
    .random-profile-name {
        font-size: 16px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 6px;
    }
    
    .random-profile-details {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 8px;
    }
    
    .random-profile-bio {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 16px;
        line-height: 1.4;
        min-height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .random-profile-btn {
        background: linear-gradient(135deg, #FF9F80, #FFC8B2);
        color: white;
        border: none;
        border-radius: 8px;
            padding: 8px 16px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        width: 100%;
        box-shadow: 0 2px 8px rgba(255, 159, 128, 0.3);
    }
    
    .random-profile-btn:hover {
        background: linear-gradient(135deg, #FF8A6B, #FFB89A);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 159, 128, 0.4);
    }
    
    /* 프로필 상세 모달 */
    .profile-detail-content {
        text-align: center;
    }
    
    .profile-detail-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #FFC8B2, #FF9F80);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        font-weight: 600;
        color: white;
        margin: 0 auto 20px;
        box-shadow: 0 8px 22px rgba(255, 159, 128, 0.35);
    }
    
    .profile-detail-name {
        font-size: 24px;
        font-weight: 700;
        color: #1F2937;
        margin-bottom: 8px;
    }
    
    .profile-detail-info {
        font-size: 16px;
        color: #6B7280;
        margin-bottom: 16px;
    }
    
    .profile-detail-bio {
        font-size: 14px;
        color: #374151;
        line-height: 1.6;
        background: #FFF7F2;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 24px;
        border: 1px solid rgba(255, 159, 128, 0.2);
    }
    
    .profile-detail-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }
    
    .profile-detail-btn {
        padding: 12px 24px;
            border: none;
            border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
            cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .profile-detail-btn.primary {
        background: linear-gradient(135deg, #FF9F80, #FF8A6B);
        color: white;
        box-shadow: 0 4px 12px rgba(255, 159, 128, 0.3);
    }
    
    .profile-detail-btn.primary:hover {
        background: linear-gradient(135deg, #FF8A6B, #FF7A5B);
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(255, 159, 128, 0.4);
    }
    
    .profile-detail-btn.secondary {
        background: #FFF7F2;
        color: #6B7280;
        border: 1px solid rgba(255, 159, 128, 0.3);
    }
    
    .profile-detail-btn.secondary:hover {
        background: #FFC8B2;
        color: #374151;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 159, 128, 0.2);
    }
    
    .profile-detail-interests {
        margin-bottom: 20px;
    }
    
    .profile-detail-interests-title {
        font-size: 14px;
            font-weight: 600;
        color: #6B7280;
        margin-bottom: 8px;
        text-align: center;
    }
    
    .profile-detail-interests-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
    }
    
    .profile-detail-interest-tag {
            background: linear-gradient(135deg, #FF9F80, #FFC8B2);
            color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        box-shadow: 0 2px 6px rgba(255, 159, 128, 0.25);
    }
    
    .composer input:focus {
        outline: none;
        border-color: #FF9F80;
        box-shadow: 0 0 0 3px rgba(255, 159, 128, 0.1);
    }
    
    /* 마이프로필 콘텐츠 스타일 */
    .my-profile-content {
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }
    
    .my-profile-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #FF9F7C, #FFC8B2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(255, 159, 124, 0.3);
    }
    
    .my-profile-info {
        flex: 1;
        min-width: 0;
    }
    
    .my-profile-name {
        font-size: 14px;
        font-weight: 600;
        color: #1F2937;
        margin-bottom: 4px;
        line-height: 1.3;
    }
    
    .my-profile-details {
        font-size: 12px;
        color: #6B7280;
        margin-bottom: 6px;
        line-height: 1.3;
    }
    
    .my-profile-bio {
        font-size: 12px;
        color: #6B7280;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .my-profile-actions {
        flex-shrink: 0;
        margin-left: auto;
    }
    
    .my-profile-edit-btn {
        background: linear-gradient(135deg, #FF9F7C, #FF7B54);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(255, 159, 124, 0.3);
    }
    
    .my-profile-edit-btn:hover {
        background: linear-gradient(135deg, #FF7B54, #FF9F7C);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 159, 124, 0.4);
    }

    /* 반응형 */
        @media(max-width: 900px){ 
            .chat-layout{ 
                grid-template-columns: 1fr; 
                padding: 16px;
            } 
        
        .matching-grid {
            grid-template-columns: 1fr;
        }
        
        .sidebar-column {
            gap: 12px;
            position: static;
            top: auto;
        }
        
        .sidebar-card-header {
            padding: 16px 16px 10px;
        }
        
        .sidebar-card-body {
            padding: 12px 16px 16px;
        }
        
        .my-profile-avatar {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }
        
        .my-profile-name {
            font-size: 13px;
        }
        
        .my-profile-details,
        .my-profile-bio {
            font-size: 11px;
        }
        
        .my-profile-edit-btn {
            padding: 4px 8px;
            font-size: 11px;
        }
    }
    
    /* 나간 채팅방은 목록에서 완전히 제거되므로 스타일 불필요 */

    /* 통일된 Footer 스타일 */
    footer {
        border-top: 1px solid rgba(255, 200, 178, 0.5);
        margin-top: 0;
        padding: 0;
    }
    
    footer > div {
        max-width: 72rem;
        margin: 0 auto;
        padding: 1.5rem 1rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
        color: #6B7280;
        text-align: center;
        }
    </style>
</head>
<body class="bg-cream">
  <div class="top-grad h-[160px] w-full absolute inset-0 -z-10 pointer-events-none"></div>

  <header class="fixed top-0 left-0 right-0 z-50 border-b border-peach/40 glass">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4">
      <a href="{{ url_for('index') }}" class="flex items-center gap-2 font-extrabold text-lg">
        <img src="{{ url_for("static", filename="images/logo.png") }}" alt="KBU hub" class="w-9 h-9 rounded-full shadow-[0_8px_18px_rgba(255,159,128,.25)]">
        <span>hub</span>
      </a>
      <nav class="ml-auto hidden md:flex">
        <div id="navPill" class="nav-pill">
          <!-- 네비게이션 아이템은 navigation.js에서 동적으로 생성됩니다 -->
        </div>
      </nav>
      <button id="menuBtn" class="md:hidden ml-auto p-2 rounded-full border border-peach/60">☰</button>
    </div>
    <div id="mobileNav" class="hidden md:hidden px-4 pb-3 border-t border-peach/40 bg-white/70">
      <div class="flex flex-col gap-1 py-2 text-sm">
        <!-- 모바일 네비게이션 아이템은 navigation.js에서 동적으로 생성됩니다 -->
      </div>
    </div>
  </header>

  <main class="chat-layout" style="margin-top: 80px;">
    <!-- 왼쪽 사이드바 -->
    <div class="sidebar-column">
      <!-- 채팅방 목록 카드 -->
      <div class="sidebar-card">
        <div class="sidebar-card-header">
          <h2 class="sidebar-card-title">채팅방 목록</h2>
        </div>
        <div class="sidebar-card-body">
          <div class="sidebar-section">
            <div class="sidebar-title">1:1</div>
            <ul class="room-list" id="dmList">
              <!-- 1:1 채팅방 목록이 여기에 표시됩니다 -->
            </ul>
        </div>
        
          <div class="sidebar-section">
            <div class="sidebar-title">그룹</div>
            <ul class="room-list" id="groupList">
              <!-- 그룹 채팅방 목록이 여기에 표시됩니다 -->
            </ul>
                            </div>
                            
          <div class="sidebar-section">
            <div class="sidebar-title">관심 분야</div>
            <ul class="room-list" id="interestList">
              <!-- 관심사 기반 채팅방이 여기에 표시됩니다 -->
            </ul>
                                </div>
                            </div>
                        </div>

      <!-- 마이프로필 카드 -->
      <div class="sidebar-card">
        <div class="sidebar-card-header">
          <h2 class="sidebar-card-title">마이프로필</h2>
                                </div>
        <div class="sidebar-card-body">
          <div class="profile-card">
            <div class="profile-avatar" id="myProfileAvatar"></div>
            <div class="profile-info">
              <div class="profile-name" id="myProfileName"></div>
              <div class="profile-details" id="myProfileDetails"></div>
              <div class="profile-bio" id="myProfileBio"></div>
            </div>
            <button class="btn btn-sm btn-outline" onclick="location.href='/mypage'">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1">
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              </svg>
              수정
            </button>
          </div>
        </div>
                        </div>
                        </div>

    <!-- 오른쪽 메인 영역 -->
    <section class="panel main-panel">
      <div class="panel-header">
        <div class="header-content">
          <div class="header-left">
            <span id="chatHeader">랜덤 매칭</span>
            <span id="participantCount" class="participant-count-header" style="display:none;"></span>
                                </div>
          <div class="header-right">
            <button id="chatOptions" class="btn-options" style="display:none;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="1"/>
                <circle cx="19" cy="12" r="1"/>
                <circle cx="5" cy="12" r="1"/>
              </svg>
                                </button>
            <button id="backToHome" class="btn-home" style="display:none;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              홈으로
                                </button>
                                </div>
                            </div>
                        </div>

      <!-- 채팅 옵션 드롭다운 -->
      <div id="chatOptionsDropdown" class="chat-options-dropdown" style="display:none;">
        <div class="dropdown-header">채팅 옵션</div>
        <div class="dropdown-item" onclick="showParticipants()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          참여자 보기
                        </div>
        <div class="dropdown-divider"></div>
        <div class="dropdown-item danger" onclick="leaveChatRoom()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16,17 21,12 16,7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
          채팅방 나가기
                            </div>
                </div>
                
      <!-- 참여자 보기 모달 -->
      <div id="participantsModal" class="modal" style="display:none;">
        <div class="modal-content">
          <div class="modal-header">
            <h3>참여자 목록</h3>
            <button class="modal-close" onclick="closeParticipantsModal()">&times;</button>
                                </div>
          <div class="modal-body">
            <div id="participantsList" class="participants-list">
              <!-- 참여자 목록이 여기에 표시됩니다 -->
                            </div>
                        </div>
                            </div>
            </div>
        
      <!-- 참여자 프로필 모달 -->
      <div id="participantProfileModal" class="modal" style="display:none;">
        <div class="modal-content">
          <div class="modal-header">
            <h3>참여자 프로필</h3>
            <button class="modal-close" onclick="closeParticipantProfileModal()">&times;</button>
                </div>
          <div class="modal-body">
            <div id="participantProfileContent" class="participant-profile">
              <!-- 참여자 프로필이 여기에 표시됩니다 -->
                </div>
          </div>
                        </div>
                        </div>

      <!-- 프로필 상세 보기 모달 -->
      <div id="profileDetailModal" class="modal" style="display:none;">
        <div class="modal-content">
          <div class="modal-header">
            <h3>프로필 상세</h3>
            <button class="modal-close" onclick="closeProfileDetailModal()">&times;</button>
                                            </div>
          <div class="modal-body">
            <div id="profileDetailContent" class="profile-detail-content">
              <!-- 프로필 상세 정보가 여기에 표시됩니다 -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                                <div class="panel-body">
        <!-- 기본 화면: 프로필 + 매칭 옵션 -->
                    <div id="chatContent">

          <!-- 랜덤 매칭 프로필 섹션 -->
          <div class="random-matching-section">
            <div class="section-header">
              <span class="section-title">✨ 랜덤 매칭 프로필</span>
                                            </div>
            <div class="profile-carousel">
              <button class="carousel-btn prev-btn" onclick="scrollProfiles(-1)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15,18 9,12 15,6"/>
                </svg>
              </button>
              <div class="profile-cards-container" id="profileCardsContainer">
                <!-- 프로필 카드들이 여기에 동적으로 생성됩니다 -->
                                        </div>
              <button class="carousel-btn next-btn" onclick="scrollProfiles(1)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9,18 15,12 9,6"/>
                </svg>
              </button>
                                    </div>
                                </div>

          <!-- 매칭 옵션 -->
          <div class="matching-grid">
            <div class="matching-card">
              <div class="matching-icon">💬</div>
              <div class="matching-title">랜덤 1:1 대화</div>
              <div class="matching-desc">익명으로 한 명과 연결됩니다.</div>
              <button id="startRandom" class="btn btn-primary">1:1 매칭 시작</button>
              <div id="randomMatchingStatus" class="matching-status">
                                                <div class="matching-spinner"></div>
                <div class="matching-text">매칭 중...</div>
                <div class="matching-timer" id="randomTimer">00:00:00</div>
                <button id="cancelRandom" class="btn btn-secondary">매칭 취소</button>
                                    </div>
                                        </div>
            
            <div class="matching-card">
              <div class="matching-icon">👥</div>
              <div class="matching-title">랜덤 그룹 대화</div>
              <div class="matching-desc">3-6명이 랜덤으로 모여 대화합니다.</div>
              <button id="startGroup" class="btn btn-primary">그룹 매칭 시작</button>
              <div id="groupMatchingStatus" class="matching-status">
                                                <div class="matching-spinner"></div>
                <div class="matching-text">매칭 중...</div>
                <div class="matching-timer" id="groupTimer">00:00:00</div>
                <button id="cancelGroup" class="btn btn-secondary">매칭 취소</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
        <!-- 채팅 화면 -->
                    <div id="chatRoom" style="display:none;">
                        <div class="messages" id="messages">
            <!-- 채팅 메시지들이 여기에 표시됩니다 -->
                        </div>
                        <div class="composer">
                            <input type="text" id="messageInput" placeholder="메시지를 입력하세요...">
                            <button id="sendButton" class="btn btn-primary">전송</button>
                        </div>
                    </div>
                </div>
            </section>
    </main>

  <footer>
    <div>
      © <span id="year"></span> KBU hub · All rights reserved.
        </div>
    </footer>

    <script>
    // 익명 프로필 로드
    async function loadAnonProfile() {
      try {
        // 서버에서 최신 익명 프로필 가져오기
        const response = await fetch('/api/anon-profile');
        const result = await response.json();

        let profile = null;

        if (result.success && result.profile) {
          // 서버에서 받은 프로필을 localStorage에 저장
          localStorage.setItem('anonProfile', JSON.stringify(result.profile));
          profile = result.profile;
          console.log('[익명카드 로드] 서버에서 최신 프로필 가져옴:', profile);
        } else {
          // 서버에 없으면 localStorage에서 가져오기
          profile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
          console.log('[익명카드 로드] localStorage에서 프로필 가져옴:', profile);
        }

        if (profile) {
          // 마이프로필 카드 업데이트
          const myProfileAvatar = document.getElementById('myProfileAvatar');
          if (myProfileAvatar) {
            myProfileAvatar.textContent = profile.avatar || profile.nickname[0] || '익';
          }
          document.getElementById('myProfileName').textContent = profile.nickname || '익명의친구';
          document.getElementById('myProfileDetails').textContent = `${profile.year} · ${profile.gender}`;
          document.getElementById('myProfileBio').textContent = profile.bio || '새로운 친구를 만나고 싶어요!';

          // 관심사 목록 업데이트
          updateInterestList(profile.interests || []);

          // 매칭 버튼 활성화
          document.getElementById('startRandom').textContent = '1:1 매칭 시작';
          document.getElementById('startGroup').textContent = '그룹 매칭 시작';
        } else { 
          // 기본값 설정
          document.getElementById('myProfileName').textContent = '익명 프로필';
          document.getElementById('myProfileDetails').textContent = '프로필 미설정';
          document.getElementById('myProfileBio').textContent = '익명카드를 설정해주세요.';

          // 관심사 목록 업데이트
          updateInterestList([]);

          // 매칭 버튼 활성화
          document.getElementById('startRandom').textContent = '1:1 매칭 시작';
          document.getElementById('startGroup').textContent = '그룹 매칭 시작';
        }
      } catch (e) {
        console.error('프로필 로드 실패:', e);
        // 기본값 설정
        document.getElementById('myProfileName').textContent = '익명 프로필';
        document.getElementById('myProfileDetails').textContent = '프로필 미설정';
        document.getElementById('myProfileBio').textContent = '익명카드를 설정해주세요.';
      }
    }

    // 서버에서 관심사별 참여자 수 가져오기
    async function loadInterestCounts() {
      try {
        const response = await fetch("{{ url_for('get_interest_counts') }}");
        const result = await response.json();
        
        if (result.success && result.interest_counts) {
          // roomParticipants 업데이트
          Object.keys(result.interest_counts).forEach(interest => {
            if (!roomParticipants[interest]) {
              roomParticipants[interest] = {
                count: 0,
                users: [],
                unreadCount: 0
              };
            }
            roomParticipants[interest].count = result.interest_counts[interest];
            
            // 닉네임 목록도 업데이트
            if (result.interest_users && result.interest_users[interest]) {
              roomParticipants[interest].users = result.interest_users[interest];
            }
          });
          
          // UI 업데이트 (현재 로그인한 사용자의 관심사 목록 다시 렌더링)
          const profile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
          if (profile && profile.interests) {
            updateInterestList(profile.interests);
          }
        }
      } catch (error) {
        console.error('관심사 카운트 로드 오류:', error);
      }
    }
    
    // 관심사 목록 업데이트
    function updateInterestList(interests) {
      const interestList = document.getElementById('interestList');
      
      // 관심분야 목록 초기화
      interestList.innerHTML = '';
      
      if (interests.length === 0) {
        const li = document.createElement('li');
        li.textContent = '선택한 관심사가 없습니다.';
        li.style.color = '#999';
        li.style.cursor = 'default';
        interestList.appendChild(li);
        return;
      }
            
      // 관심사별 이모지 매핑
      const interestEmojis = {
        '영화': '🎬',
        '운동': '💪',
        '게임': '🎮',
        '음악': '🎵',
        '카페': '☕',
        '여행': '✈️',
        '스터디': '📚',
        '독서': '📖',
        '맛집': '🍽️'
      };
      
      // 나간 채팅방 목록 확인
      const leftRooms = JSON.parse(localStorage.getItem('leftRooms') || '[]');
      
      interests.forEach(interest => {
        // 나간 채팅방인지 확인 (제외하지 않고 표시)
        const isLeftRoom = leftRooms.includes(interest);
        if (isLeftRoom) {
          console.log(`[관심분야 목록] ${interest}는 나간 방이지만 목록에 표시 (재입장 가능)`);
        }
        
        const li = document.createElement('li');
        const emoji = interestEmojis[interest] || '🎯';
        const participantCount = roomParticipants[interest]?.count || 0;
        
        // 나간 방인 경우 시각적으로 구분
        if (isLeftRoom) {
            li.style.opacity = '0.6';
            li.style.borderLeft = '3px solid #ff6b6b';
        }
        
        // 관심분야 항목 HTML 구조 (채팅방 목록과 동일한 스타일)
        li.innerHTML = `
            <div class="room-info">
                <div class="room-name-wrapper">
                    <span class="room-name">${emoji} ${interest}</span>
                    ${isLeftRoom ? '<span style="color: #ff6b6b; font-size: 12px; margin-left: 5px;">(나간 방)</span>' : ''}
                </div>
                <span class="participant-count">${participantCount}명</span>
            </div>
        `;
        
        // 클릭 이벤트 처리
        li.addEventListener('click', () => {
            // 나간 방인 경우 leftRooms에서 제거 (재입장 허용)
            if (isLeftRoom) {
                let leftRooms = JSON.parse(localStorage.getItem('leftRooms') || '[]');
                const roomIndex = leftRooms.indexOf(interest);
                if (roomIndex > -1) {
                    leftRooms.splice(roomIndex, 1);
                    localStorage.setItem('leftRooms', JSON.stringify(leftRooms));
                    console.log(`[재입장] ${interest} 방을 나간 방 목록에서 제거`);
                    
                    // UI에서 "(나간 방)" 표시 제거
                    li.style.opacity = '1';
                    li.style.borderLeft = 'none';
                    const leftRoomSpan = li.querySelector('span[style*="color: #ff6b6b"]');
                    if (leftRoomSpan) {
                        leftRoomSpan.remove();
                    }
                }
            }
            
            // 관심사 방 입장 시 채팅방 목록에 추가
            const added = addInterestRoom(interest);
            if (added) {
                enterRoom(interest);
            } else {
                console.error(`[입장 실패] ${interest} 방 추가 실패`);
            }
            
            // 모든 채팅방 목록에서 active 클래스 제거 후 현재 방에 추가
            document.querySelectorAll('.room-list li, #dmList li, #interestList li').forEach(item => {
                item.classList.remove('active');
            });
            li.classList.add('active');
        });
        
        interestList.appendChild(li);
      });
      
      // 표시된 관심사 개수 계산 (모든 관심사 표시)
      const displayedCount = interestList.children.length;
      const leftCount = leftRooms.filter(room => interests.includes(room)).length;
      console.log(`[관심분야 목록] 전체 ${interests.length}개 표시 (${leftCount}개는 나간 방, 재입장 가능)`);
    }

    // 관심사 방을 채팅방 목록에 추가
    function addInterestRoom(interest) {
        // 이미 존재하는 방인지 확인
        const existingRoom = chatData.roomList.find(room => room.name === interest);
        if (existingRoom) {
            console.log(`[채팅방 추가] ${interest} 방은 이미 존재합니다`);
            return true;
        }
        
        // roomParticipants 초기화 (없으면)
        if (!roomParticipants[interest]) {
            roomParticipants[interest] = {
                count: 0,
                users: [],
                unreadCount: 0
            };
        }
        
        // 채팅방 데이터에 추가
        if (!chatData.rooms[interest]) {
            chatData.rooms[interest] = [];
        }
        
        // 채팅방 목록에 추가
        chatData.roomList.push({
            name: interest,
            type: 'interest',
            unreadCount: 0,
            participantCount: roomParticipants[interest].count,
            createdAt: new Date().toISOString()
        });
        
        console.log(`[채팅방 추가] ${interest} 방이 추가되었습니다 (총 ${chatData.roomList.length}개)`);
        saveChatData();
        updateRoomListUI();
        return true;
    }

    // 관심분야 방 참여자 수 증가 (제거 - 서버에서 실제 수를 가져옴)
    async function incrementParticipantCount(interest) {
        // 서버에서 최신 참여자 수를 다시 가져옴
        await loadInterestCounts();
    }

    // 관심분야 목록 UI 업데이트
    function updateInterestListUI(interest) {
        const interestList = document.getElementById('interestList');
        const listItems = interestList.querySelectorAll('li');
        
        listItems.forEach(li => {
            const roomNameSpan = li.querySelector('.room-name');
            if (roomNameSpan && roomNameSpan.textContent.includes(interest)) {
                const participantCountSpan = li.querySelector('.participant-count');
                if (participantCountSpan) {
                    const currentCount = roomParticipants[interest]?.count || 0;
                    participantCountSpan.textContent = `${currentCount}명`;
                }
            }
        });
    }

    // 기본 관심분야 방들을 초기화
    function initializeDefaultInterestRooms() {
        // 기본 관심분야 방 초기화 안함 (사용자가 직접 참여)
    }


    // 매칭 관련 변수
        let randomMatching = false;
        let groupMatching = false;
        let randomStartTime = null;
        let groupStartTime = null;
        let randomTimer = null;
        let groupTimer = null;
        
        // 그룹 매칭 대기열 (전역)
        let groupMatchingQueue = {
            male: [], // 남자 대기자 목록
            female: [], // 여자 대기자 목록
            groups: [] // 완성된 그룹 목록
        };
        
        // 채팅 데이터 저장소 (전역)
        let chatData = {
            rooms: {}, // 채팅방별 메시지 저장
            roomList: [] // 채팅방 목록
        };

    // 타이머 포맷팅
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // 채팅 데이터 저장
        function saveChatData() {
            try {
                // 저장만 수행 (필터링은 loadChatData와 leaveChatRoom에서만)
                localStorage.setItem('chatData', JSON.stringify(chatData));
                console.log(`[저장] ${chatData.roomList.length}개 채팅방 저장`);
            } catch (e) {
                console.error('채팅 데이터 저장 실패:', e);
            }
        }

        // 채팅 데이터 로드
        function loadChatData() {
            try {
                const saved = localStorage.getItem('chatData');
                if (saved) {
                    chatData = JSON.parse(saved);
                    
                    // 나간 채팅방 목록 필터링
                    const leftRooms = JSON.parse(localStorage.getItem('leftRooms') || '[]');
                    if (leftRooms.length > 0) {
                        // 나간 방 목록에서 제거
                        chatData.roomList = chatData.roomList.filter(room => !leftRooms.includes(room.name));
                        console.log(`[로드] ${leftRooms.length}개의 나간 채팅방 필터링 완료`);
                        
                        // 필터링된 데이터 저장
                        saveChatData();
                    }
                }
            } catch (e) {
                console.error('채팅 데이터 로드 실패:', e);
                chatData = { rooms: {}, roomList: [] };
            }
        }

        // 채팅방 목록 UI 업데이트
        function updateRoomListUI() {
            // 나간 채팅방 목록 로드
            const leftRooms = JSON.parse(localStorage.getItem('leftRooms') || '[]');
            
            // 1:1 채팅방 목록 업데이트
            const dmList = document.getElementById('dmList');
            dmList.innerHTML = '';
            
            // 그룹 채팅방 목록 업데이트
            const groupList = document.getElementById('groupList');
            groupList.innerHTML = '';
            
            // 관심분야 채팅방 목록은 updateInterestList에서 처리하므로 여기서는 건드리지 않음
            // const interestList = document.getElementById('interestList');
            // interestList.innerHTML = '';
            
            let displayCount = 0;
            let skipCount = 0;
            
            // 나간 방을 제외하고 채팅방 목록 렌더링
            chatData.roomList.forEach(room => {
                // 나간 방은 스킵
                if (leftRooms.includes(room.name)) {
                    console.log(`[UI 스킵] ${room.name}은 나간 방`);
                    skipCount++;
                    return;
                }
                
                if (room.type === 'dm') {
                    createRoomListItem('dmList', room.name, room.unreadCount || 0);
                    displayCount++;
                } else if (room.type === 'group') {
                    createRoomListItem('groupList', room.name, room.unreadCount || 0, room.participantCount || 0);
                    displayCount++;
                } else if (room.type === 'interest') {
                    // 관심분야 방은 별도 처리하지 않음 (updateInterestList에서 처리)
                    console.log(`[UI 스킵] ${room.name} 관심분야 방은 별도 처리`);
                }
            });
            
            console.log(`[UI 업데이트] 전체 ${chatData.roomList.length}개 중 ${displayCount}개 표시, ${skipCount}개 스킵`);
        }

        // 채팅방 목록 아이템 생성
        function createRoomListItem(listId, roomName, unreadCount = 0, participantCount = 0) {
            const list = document.getElementById(listId);
            const li = document.createElement('li');
            const isGroupChat = listId === 'groupList' || listId === 'interestList';
            const isInterestRoom = listId === 'interestList';
            
            // 관심분야 방인 경우 실제 참여자 수 사용
            if (isInterestRoom && roomParticipants[roomName]) {
                participantCount = roomParticipants[roomName].count;
            }
            
            // 관심분야 방인 경우 이모지 추가
            let displayName = roomName;
            if (isInterestRoom) {
                const interestEmojis = {
                    '운동': '💪',
                    '게임': '🎮',
                    '음악': '🎵',
                    '영화': '🎬',
                    '카페': '☕',
                    '여행': '✈️',
                    '스터디': '📚',
                    '독서': '📖',
                    '맛집': '🍽️'
                };
                const emoji = interestEmojis[roomName] || '🎯';
                displayName = `${emoji} ${roomName}`;
            }
            
            li.innerHTML = `
                <div class="room-info">
                    <div class="room-name-wrapper">
                        <span class="room-name">${displayName}</span>
                        ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                    </div>
                    ${isGroupChat ? `<span class="participant-count">${participantCount}명</span>` : ''}
                </div>
            `;
            li.addEventListener('click', () => {
                enterRoom(roomName);
                
                // 모든 채팅방 목록에서 active 클래스 제거 후 현재 방에 추가
                document.querySelectorAll('.room-list li, #dmList li, #interestList li').forEach(item => {
                    item.classList.remove('active');
                });
                li.classList.add('active');
            });
            list.appendChild(li);
        }

        // 1:1 매칭 시작
        async function startRandomMatching() {
            // 프로필 체크
            if (!checkAnonProfile()) {
                return;
            }
            
            randomMatching = true;
            randomStartTime = Date.now();
            document.getElementById('startRandom').style.display = 'none';
            document.getElementById('randomMatchingStatus').style.display = 'block';
            
            randomTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - randomStartTime) / 1000);
                document.getElementById('randomTimer').textContent = formatTime(elapsed);
            }, 1000);

            try {
                // 서버에 매칭 요청
                const response = await fetch('/api/matching/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.matched && result.match_data) {
                        // 즉시 매칭 성공
                        clearInterval(randomTimer);
                        randomMatching = false;
                        document.getElementById('startRandom').style.display = 'block';
                        document.getElementById('randomMatchingStatus').style.display = 'none';
                        
                        // 매칭된 방을 채팅방 목록에 추가
                        await handleMatchedRoom(result.match_data);
                        
                        alert('1:1 매칭이 완료되었습니다!');
                    } else {
                        // 매칭 대기 중 - 주기적으로 매칭 상태 확인
                        checkMatchingStatus();
                    }
                } else {
                    // 매칭 실패 - 기존 방이 있는 경우 처리
                    if (result.existing_room) {
                        clearInterval(randomTimer);
                        randomMatching = false;
                        document.getElementById('startRandom').style.display = 'block';
                        document.getElementById('randomMatchingStatus').style.display = 'none';
                        
                        // 기존 방을 채팅방 목록에 추가 (없는 경우에만)
                        const roomName = result.existing_room.other_nickname;
                        const existingRoom = chatData.roomList.find(room => room.name === roomName);
                        
                        if (!existingRoom) {
                            const newRoom = {
                                name: roomName,
                                type: 'dm',
                                roomId: result.existing_room.room_id,
                                unreadCount: 0,
                                createdAt: new Date().toISOString()
                            };
                            
                            chatData.roomList.push(newRoom);
                            
                            // roomParticipants에 추가
                            roomParticipants[roomName] = {
                                count: 2,
                                users: [roomName],
                                unreadCount: 0
                            };
                            
                            // 채팅방 데이터 초기화
                            if (!chatData.rooms[roomName]) {
                                chatData.rooms[roomName] = [];
                            }
                            
                            saveChatData();
                            updateRoomListUI();
                            
                            console.log(`[기존 방 복원] ${roomName}과의 기존 방을 목록에 추가`);
                        }
                        
                        alert(`${result.message}\n기존 채팅방으로 이동하세요.`);
                    } else {
                        alert(result.message || '매칭 시작에 실패했습니다.');
                        cancelMatching();
                    }
                }
            } catch (error) {
                console.error('매칭 요청 실패:', error);
                alert('매칭 요청에 실패했습니다.');
                cancelMatching();
            }
        }

        // 매칭 상태 확인
        async function checkMatchingStatus() {
            if (!randomMatching) return;
            
            try {
                // 서버에서 사용자의 방 목록 확인
                const response = await fetch('/api/rooms');
                const result = await response.json();
                
                if (result.success) {
                    // 새로 생성된 방이 있는지 확인
                    const currentRooms = chatData.roomList.filter(room => room.type === 'dm').map(room => room.name);
                    const serverRooms = result.rooms.filter(room => room.type === 'dm');
                    
                    for (const serverRoom of serverRooms) {
                        const roomExists = currentRooms.includes(serverRoom.room_name);
                        if (!roomExists) {
                            // 새로운 매칭된 방 발견
                            clearInterval(randomTimer);
                            randomMatching = false;
                            document.getElementById('startRandom').style.display = 'block';
                            document.getElementById('randomMatchingStatus').style.display = 'none';
                            
                            // 방을 채팅방 목록에 추가
                            await handleServerRoom(serverRoom);
                            
                            alert('1:1 매칭이 완료되었습니다!');
                            return;
                        }
                    }
                }
                
                // 매칭이 아직 안 되었으면 2초 후 다시 확인
                setTimeout(checkMatchingStatus, 2000);
            } catch (error) {
                console.error('매칭 상태 확인 실패:', error);
                setTimeout(checkMatchingStatus, 2000);
            }
        }

        // 매칭 취소
        async function cancelMatching() {
            randomMatching = false;
            clearInterval(randomTimer);
            document.getElementById('startRandom').style.display = 'block';
            document.getElementById('randomMatchingStatus').style.display = 'none';
            
            try {
                await fetch('/api/matching/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
            } catch (error) {
                console.error('매칭 취소 실패:', error);
            }
        }

        // 매칭된 방 처리
        async function handleMatchedRoom(matchData) {
            const roomId = matchData.room_id;
            const otherUser = matchData.user1.student_id === getCurrentStudentId() ? matchData.user2 : matchData.user1;
            
            // 채팅방 목록에 추가
            const newRoom = {
                name: otherUser.nickname,
                type: 'dm',
                roomId: roomId,
                unreadCount: 0,
                createdAt: new Date().toISOString()
            };
            
            chatData.roomList.push(newRoom);
            
            // roomParticipants에 추가
            roomParticipants[otherUser.nickname] = {
                count: 2,
                users: [otherUser.nickname],
                unreadCount: 0
            };
            
            // 채팅방 데이터 초기화
            if (!chatData.rooms[otherUser.nickname]) {
                chatData.rooms[otherUser.nickname] = [];
            }
            
            saveChatData();
            updateRoomListUI();
            
            console.log(`[매칭 완료] ${otherUser.nickname}과 매칭됨 (방 ID: ${roomId})`);
        }

        // 서버에서 받은 방 정보 처리
        async function handleServerRoom(serverRoom) {
            const roomName = serverRoom.room_name;
            const roomId = serverRoom.room_id;
            
            // 채팅방 목록에 추가
            const newRoom = {
                name: roomName,
                type: 'dm',
                roomId: roomId,
                unreadCount: 0,
                createdAt: serverRoom.created_at
            };
            
            chatData.roomList.push(newRoom);
            
            // roomParticipants에 추가
            roomParticipants[roomName] = {
                count: 2,
                users: [roomName],
                unreadCount: 0
            };
            
            // 채팅방 데이터 초기화
            if (!chatData.rooms[roomName]) {
                chatData.rooms[roomName] = [];
            }
            
            saveChatData();
            updateRoomListUI();
            
            console.log(`[서버 매칭] ${roomName}과 매칭됨 (방 ID: ${roomId})`);
        }

        // 현재 사용자의 학번 가져오기
        function getCurrentStudentId() {
            const currentUser = sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser');
            if (currentUser) {
                try {
                    const user = JSON.parse(currentUser);
                    return user.student_id;
                } catch (e) {
                    return null;
                }
            }
            return null;
        }

        // 그룹 매칭 시작 (서버 API 사용)
        async function startGroupMatching() {
            // 프로필 체크
            if (!checkAnonProfile()) {
                return;
            }
            
            try {
                // 서버에 그룹 매칭 시작 요청
                const response = await fetch('/api/group-matching/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    groupMatching = true;
                    groupStartTime = Date.now();
                    document.getElementById('startGroup').style.display = 'none';
                    document.getElementById('groupMatchingStatus').style.display = 'block';
                    
                    groupTimer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - groupStartTime) / 1000);
                        document.getElementById('groupTimer').textContent = formatTime(elapsed);
                        updateGroupMatchingStatus();
                    }, 1000);
                    
                    // 매칭 성공 시 즉시 그룹 채팅방으로 이동
                    if (result.matched && result.match_data) {
                        handleGroupMatchingSuccess(result.match_data);
                    }
                    
                    alert(result.message);
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('그룹 매칭 시작 실패:', error);
                alert('그룹 매칭 시작 중 오류가 발생했습니다.');
            }
        }

        // 1:1 매칭 완료 (기존 로컬 방식 - 서버 방식으로 대체됨)
        // function completeRandomMatching(availableProfiles = null) {
        //     // 이 함수는 이제 서버 기반 매칭 시스템으로 대체됨
        //     // handleMatchedRoom() 함수를 사용
        // }

        // 그룹 매칭 상태 업데이트 (서버에서 대기열 정보 가져오기)
        async function updateGroupMatchingStatus() {
            try {
                // 서버에서 그룹 매칭 대기열 정보 가져오기 (임시로 로컬 정보 사용)
                // TODO: 서버 API 추가 시 실제 서버 호출로 변경
                const maleCount = groupMatchingQueue.male.length;
                const femaleCount = groupMatchingQueue.female.length;
                const totalCount = maleCount + femaleCount;
                
                const matchingText = document.querySelector('#groupMatchingStatus .matching-text');
                if (matchingText) {
                    if (totalCount < 3) {
                        matchingText.textContent = `매칭 중... (대기자: 남자 ${maleCount}명, 여자 ${femaleCount}명)`;
                    } else {
                        matchingText.textContent = `비율 맞춤 중... (대기자: 남자 ${maleCount}명, 여자 ${femaleCount}명)`;
                    }
                }
            } catch (error) {
                console.error('그룹 매칭 상태 업데이트 실패:', error);
            }
        }

        // 그룹 매칭 시도 함수는 이제 서버에서 처리됨 (로컬 함수 제거)

        // 그룹 매칭 성공 처리 (서버 응답 처리)
        async function handleGroupMatchingSuccess(matchData) {
            groupMatching = false;
            clearInterval(groupTimer);
            document.getElementById('startGroup').style.display = 'block';
            document.getElementById('groupMatchingStatus').style.display = 'none';
            
            const roomId = matchData.room_id;
            const groupSize = matchData.group_size;
            const members = matchData.members;
            
            // 모든 멤버 정보 수집
            const allMembers = [...members.male, ...members.female];
            
            // 그룹 랜덤 채팅용 참여자 정보 생성
            const groupRoomName = `그룹 ${roomId.split('_')[1]}`;
            roomParticipants[groupRoomName] = {
                count: groupSize,
                users: allMembers.map(member => member.nickname),
                unreadCount: 0,
                roomId: roomId
            };
            
            // 채팅방 데이터에 추가
            if (!chatData.rooms[groupRoomName]) {
                chatData.rooms[groupRoomName] = [];
            }
            
            // 채팅방 목록에 추가
            chatData.roomList.push({
                name: groupRoomName,
                type: 'group',
                unreadCount: 0,
                participantCount: groupSize,
                roomId: roomId,
                createdAt: new Date().toISOString()
            });
            
            saveChatData();
            updateRoomListUI();
            
            // 남녀 비율 정보 표시
            const maleCount = members.male.length;
            const femaleCount = members.female.length;
            alert(`그룹 매칭이 완료되었습니다! (${groupSize}명, 남자 ${maleCount}명, 여자 ${femaleCount}명)`);
            
            // 자동으로 그룹 채팅방에 입장
            setTimeout(() => {
                enterRoom(groupRoomName);
            }, 1000);
        }

        // 매칭 취소
        function cancelRandomMatching() {
            randomMatching = false;
            clearInterval(randomTimer);
      document.getElementById('startRandom').style.display = 'block';
      document.getElementById('randomMatchingStatus').style.display = 'none';
        }

        // 그룹 매칭 취소 (서버 API 사용)
        async function cancelGroupMatching() {
            try {
                const response = await fetch('/api/group-matching/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                groupMatching = false;
                clearInterval(groupTimer);
                document.getElementById('startGroup').style.display = 'block';
                document.getElementById('groupMatchingStatus').style.display = 'none';
                
                if (result.success) {
                    console.log(result.message);
                }
            } catch (error) {
                console.error('그룹 매칭 취소 실패:', error);
                // 오류가 발생해도 UI는 초기화
                groupMatching = false;
                clearInterval(groupTimer);
                document.getElementById('startGroup').style.display = 'block';
                document.getElementById('groupMatchingStatus').style.display = 'none';
            }
        }

    // 채팅방 생성
    function createRoom(listId, roomName) {
      const list = document.getElementById(listId);
      const li = document.createElement('li');
      const participantCount = roomParticipants[roomName]?.count || 0;
      const unreadCount = roomParticipants[roomName]?.unreadCount || 0;
      
      // 1:1 채팅인지 그룹 채팅인지 구분
      const isGroupChat = listId === 'roomList';
      
      li.innerHTML = `
        <div class="room-info">
          <div class="room-name-wrapper">
            <span class="room-name">${roomName}</span>
            ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
          </div>
          ${isGroupChat ? `<span class="participant-count">${participantCount}명</span>` : ''}
        </div>
      `;
      li.addEventListener('click', () => enterRoom(roomName));
      list.appendChild(li);
    }

        // 현재 활성 채팅방
        let currentRoom = null;
        
        // 랜덤 매칭 프로필 데이터
        const randomProfiles = [];
        
        // 채팅방별 참여자 정보 (관심사별 그룹 채팅 - 인원수 제한 없음)
        const roomParticipants = {};

        // 채팅방 입장
        async function enterRoom(roomName) {
            console.log(`[입장] ${roomName} 방에 입장 시도`);
            
            // 나간 방은 이미 목록에서 제외되므로 체크 불필요
            
            currentRoom = roomName;
            document.getElementById('chatHeader').textContent = roomName;
            document.getElementById('chatContent').style.display = 'none';
            document.getElementById('chatRoom').style.display = 'block';
            
            // 방 정보 가져오기
            const roomData = chatData.roomList.find(room => room.name === roomName);
            
            // 1:1 채팅방인 경우 서버에서 메시지 로드, 그 외에는 로컬에서 로드
            if (roomData && roomData.type === 'dm') {
                // 1:1 채팅방: 서버에서 메시지 로드
                await loadRoomMessages(roomName);
                
                // 메시지 폴링 시작
                startMessagePolling();
                console.log(`[입장] ${roomName} 방 입장 완료, 폴링 시작됨`);
            } else {
                // 관심분야 방: 서버에서 메시지 로드
                await loadRoomMessages(roomName);
                
                // 참여자 수 증가
                if (roomData && roomData.type === 'interest') {
                    incrementParticipantCount(roomName);
                }
                
                // 메시지 폴링 시작 (관심분야 방도 실시간 메시지 수신)
                startMessagePolling();
                console.log(`[입장] ${roomName} 방 입장 완료, 폴링 시작됨`);
            }
            
            // 참여자 수 표시 (그룹 채팅방인 경우에만)
            const participantCount = roomParticipants[roomName]?.count || 0;
            const participantCountElement = document.getElementById('participantCount');
            
            if (roomParticipants[roomName]) {
                // 그룹 채팅방
                participantCountElement.textContent = `현재 ${participantCount}명 참여중`;
                participantCountElement.style.display = 'block';
            } else {
                // 1:1 채팅방
                participantCountElement.textContent = `1:1 채팅`;
                participantCountElement.style.display = 'block';
            }
            
            // 버튼들 표시
            document.getElementById('backToHome').style.display = 'inline-flex';
            document.getElementById('chatOptions').style.display = 'inline-flex';
            
            // 읽지 않은 메시지 수 초기화
            if (roomParticipants[roomName]) {
                roomParticipants[roomName].unreadCount = 0;
                updateRoomUnreadCount(roomName);
            }
            
            // 채팅방 목록에서 읽지 않은 메시지 수 초기화
            if (roomData) {
                roomData.unreadCount = 0;
                saveChatData();
                updateRoomListUI();
            }
            
            // 활성 상태 업데이트
            document.querySelectorAll('.room-list li, #dmList li, #interestList li').forEach(li => {
                li.classList.remove('active');
                if (li.textContent.includes(roomName)) {
                    li.classList.add('active');
                }
            });
            
            // 1:1 채팅방인 경우 서버에 입장 알림
            if (roomData && roomData.type === 'dm' && roomData.roomId) {
                try {
                    const response = await fetch(`/api/room/${encodeURIComponent(roomData.roomId)}/enter`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`[입장] ${roomName} 방 입장 완료:`, result.message);
                        
                        if (result.other_user_entered) {
                            console.log('[입장] 상대방이 이미 입장한 상태');
                        } else {
                            console.log('[입장] 첫 번째 입장자');
                        }
                        
                        // 서버에서 받은 메시지 다시 로드 (입장 메시지 포함)
                        await loadRoomMessages(roomName);
                    }
                } catch (error) {
                    console.error('[입장] 서버 입장 알림 실패:', error);
                }
            }
            // 그룹 채팅방인 경우 서버에 입장 알림
            else if (roomData && roomData.type === 'group' && roomData.roomId) {
                try {
                    const response = await fetch(`/api/group/${encodeURIComponent(roomData.roomId)}/enter`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`[그룹 입장] ${roomName} 그룹 입장 완료:`, result.message);
                        
                        // 서버에서 받은 메시지 다시 로드 (입장 메시지 포함)
                        await loadRoomMessages(roomName);
                    }
                } catch (error) {
                    console.error('[그룹 입장] 서버 입장 알림 실패:', error);
                }
            }
        }

        // 채팅방 메시지 로드
        function loadRoomMessages(roomName) {
            const messages = document.getElementById('messages');
            messages.innerHTML = '';
            
            if (chatData.rooms[roomName] && chatData.rooms[roomName].length > 0) {
                // 저장된 메시지 표시
                chatData.rooms[roomName].forEach(messageData => {
                    const messageWrapper = document.createElement('div');
                    
                    // 시스템 메시지인지 확인
                    if (messageData.type === 'leave' || messageData.type === 'enter' || messageData.type === 'wait') {
                        // 시스템 메시지 (나가기, 입장, 대기)
                        messageWrapper.className = 'msg-wrapper system';
                        messageWrapper.style.justifyContent = 'center';
                        messageWrapper.style.margin = '8px 0';
                        
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'msg system';
                        
                        // 메시지 타입에 따른 스타일 설정
                        if (messageData.type === 'enter') {
                            messageDiv.style.background = 'linear-gradient(135deg, #dcfce7, #bbf7d0)';
                            messageDiv.style.color = '#166534';
                            messageDiv.style.border = '1px solid #86efac';
                        } else if (messageData.type === 'wait') {
                            messageDiv.style.background = 'linear-gradient(135deg, #fef3c7, #fde68a)';
                            messageDiv.style.color = '#92400e';
                            messageDiv.style.border = '1px solid #fbbf24';
                        } else {
                            // leave
                            messageDiv.style.background = 'linear-gradient(135deg, #f3f4f6, #e5e7eb)';
                            messageDiv.style.color = '#6b7280';
                            messageDiv.style.border = '1px solid #d1d5db';
                        }
                        
                        messageDiv.style.fontSize = '12px';
                        messageDiv.style.fontStyle = 'italic';
                        messageDiv.style.maxWidth = 'auto';
                        messageDiv.style.padding = '6px 12px';
                        messageDiv.style.borderRadius = '12px';
                        
                        // 시간 표시 (서버에서 온 메시지인 경우)
                        let timeString = messageData.timeString;
                        if (!timeString && messageData.timestamp) {
                            const date = new Date(messageData.timestamp * 1000);
                            timeString = date.toLocaleTimeString('ko-KR', { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                hour12: false 
                            });
                        }
                        
                        messageDiv.innerHTML = `
                            <div class="msg-content">${messageData.content || messageData.text}</div>
                            <div class="msg-time" style="font-size: 10px; margin-top: 2px; opacity: 0.7;">${timeString}</div>
                        `;
                        
                        messageWrapper.appendChild(messageDiv);
                    } else {
                        // 일반 메시지
                        messageWrapper.className = `msg-wrapper ${messageData.isMe ? 'me' : ''}`;
                        
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `msg ${messageData.isMe ? 'me' : ''}`;
                        
                        if (messageData.isMe) {
                            // 내 메시지
                            messageDiv.innerHTML = `
                                <div class="msg-content">${messageData.text}</div>
                                <div class="msg-time">${messageData.timeString}</div>
                            `;
                        } else {
                            // 상대방 메시지
                            messageDiv.innerHTML = `
                                <div class="msg-nickname">${messageData.nickname}</div>
                                <div class="msg-content">${messageData.text}</div>
                                <div class="msg-time">${messageData.timeString}</div>
                            `;
                        }
                        
                        messageWrapper.appendChild(messageDiv);
                    }
                    
                    messages.appendChild(messageWrapper);
                });
            } else {
                // 첫 입장 메시지
                addMessage('채팅방에 입장했습니다.', false);
            }
            
            messages.scrollTop = messages.scrollHeight;
        }

        // 메시지 전송
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message && currentRoom) {
                console.log(`[전송] 채팅방: ${currentRoom}, 메시지: ${message}`);
                
                // 방 정보 가져오기
                const roomData = chatData.roomList.find(room => room.name === currentRoom);
                
                // 1:1 채팅방인 경우 roomId 사용, 그룹채팅방도 roomId 사용, 그 외에는 roomName 사용
                const roomId = (roomData && (roomData.type === 'dm' || roomData.type === 'group') && roomData.roomId) ? roomData.roomId : currentRoom;
                
                console.log(`[전송] 실제 채팅방 ID: ${roomId} (타입: ${roomData?.type || 'unknown'})`);
                
                // 내 메시지를 즉시 표시
                addMessage(message, true);
                messageInput.value = '';
                
                // 서버에 메시지 전송 (1:1 채팅방과 그룹채팅방 모두)
                if (roomData && (roomData.type === 'dm' || roomData.type === 'group')) {
                    try {
                        const anonProfile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
                        const nickname = anonProfile ? anonProfile.nickname : '익명';
                    
                    console.log(`[전송] 닉네임: ${nickname}, 채팅방 ID: ${roomId}`);
                    
                    const response = await fetch(`/api/chat/messages/${encodeURIComponent(roomId)}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            sender_nickname: nickname
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.message_data) {
                        // 내가 보낸 메시지 ID를 해당 채팅방의 추적 목록에 추가 (중복 방지)
                        if (!displayedMessageIds[currentRoom]) {
                            displayedMessageIds[currentRoom] = new Set();
                        }
                        displayedMessageIds[currentRoom].add(result.message_data.id);
                        console.log(`[전송 성공] 메시지 ID: ${result.message_data.id}`);
                    } else {
                        console.error('메시지 전송 실패:', result.message);
                    }
                } catch (error) {
                    console.error('메시지 전송 오류:', error);
                }
            } else {
                console.warn('메시지 또는 현재 채팅방이 없습니다.');
            }
        }

    // 메시지 폴링 인터벌
    let messagePollingInterval = null;
    let displayedMessageIds = {}; // 채팅방별로 이미 표시된 메시지 ID 추적 { roomName: Set(), ... }
    
    // 채팅방 메시지 로드
    async function loadRoomMessages(roomName) {
        console.log(`[로드] ${roomName} 방의 메시지 로드 시작`);
        
        // 방 정보 가져오기
        const roomData = chatData.roomList.find(room => room.name === roomName);
        
        // 1:1 채팅방인 경우 roomId 사용, 그룹채팅방도 roomId 사용, 그 외에는 roomName 사용
        const roomId = (roomData && (roomData.type === 'dm' || roomData.type === 'group') && roomData.roomId) ? roomData.roomId : roomName;
        
        console.log(`[로드] 실제 채팅방 ID: ${roomId} (타입: ${roomData?.type || 'unknown'})`);
        
        try {
            const response = await fetch(`/api/chat/messages/${encodeURIComponent(roomId)}`);
            const result = await response.json();
            
            console.log(`[로드] 서버 응답:`, result);
            
            if (result.success && result.messages) {
                // 메시지 컨테이너 초기화
                document.getElementById('messages').innerHTML = '';
                
                // 해당 채팅방의 메시지 ID 추적 초기화
                if (!displayedMessageIds[roomName]) {
                    displayedMessageIds[roomName] = new Set();
                }
                displayedMessageIds[roomName].clear();
                
                // 현재 사용자의 닉네임 가져오기
                const anonProfile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
                const myNickname = anonProfile ? anonProfile.nickname : '익명';
                
                console.log(`[로드] 내 닉네임: ${myNickname}`);
                
                // 메시지 표시
                result.messages.forEach(msg => {
                    console.log(`[로드] 메시지: ${msg.sender} - ${msg.content.substring(0, 20)}... (타입: ${msg.type || 'text'})`);
                    addMessageFromServer(msg);
                    displayedMessageIds[roomName].add(msg.id);
                });
                
                console.log(`[로드] ${roomName} 방의 메시지 ${result.messages.length}개 로드 완료`);
            }
        } catch (error) {
            console.error('[로드] 메시지 로드 오류:', error);
        }
    }
    
    // 메시지 폴링 시작
    function startMessagePolling() {
        // 기존 폴링 중지
        if (messagePollingInterval) {
            clearInterval(messagePollingInterval);
            console.log('[폴링] 기존 폴링 중지');
        }
        
        console.log(`[폴링] ${currentRoom} 방의 메시지 폴링 시작 (2초마다)`);
        
        // 2초마다 새 메시지 확인
        messagePollingInterval = setInterval(async () => {
            if (currentRoom) {
                try {
                    // 방 정보 가져오기
                    const roomData = chatData.roomList.find(room => room.name === currentRoom);
                    
                    // 1:1 채팅방인 경우 roomId 사용, 그 외에는 roomName 사용
                    const roomId = (roomData && roomData.type === 'dm' && roomData.roomId) ? roomData.roomId : currentRoom;
                    
                    const response = await fetch(`/api/chat/messages/${encodeURIComponent(roomId)}`);
                    const result = await response.json();
                    
                    if (result.success && result.messages) {
                        const anonProfile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
                        const myNickname = anonProfile ? anonProfile.nickname : '익명';
                        
                        // 해당 채팅방의 메시지 ID 추적 Set이 없으면 생성
                        if (!displayedMessageIds[currentRoom]) {
                            displayedMessageIds[currentRoom] = new Set();
                        }
                        
                        // 아직 표시되지 않은 새 메시지만 필터링
                        const newMessages = result.messages.filter(msg => !displayedMessageIds[currentRoom].has(msg.id));
                        
                        if (newMessages.length > 0) {
                            console.log(`[폴링] ${currentRoom} 방에서 ${newMessages.length}개의 새 메시지 발견`);
                            
                            newMessages.forEach(msg => {
                                console.log(`[폴링] 메시지 표시: ${msg.sender} - ${msg.content.substring(0, 20)}... (타입: ${msg.type || 'text'})`);
                                addMessageFromServer(msg);
                                displayedMessageIds[currentRoom].add(msg.id);
                            });
                        }
                    }
                } catch (error) {
                    console.error('[폴링] 메시지 폴링 오류:', error);
                }
            }
        }, 2000);
    }
    
    // 메시지 폴링 중지
    function stopMessagePolling() {
        if (messagePollingInterval) {
            clearInterval(messagePollingInterval);
            messagePollingInterval = null;
            console.log('[폴링] 메시지 폴링 중지');
        }
    }

    // 랜덤 매칭 홈으로 돌아가기
    function backToHome() {
      stopMessagePolling();
      currentRoom = null;
      document.getElementById('chatHeader').textContent = '랜덤 매칭';
      document.getElementById('chatContent').style.display = 'block';
      document.getElementById('chatRoom').style.display = 'none';
      
      // 참여자 수와 버튼들 숨기기
      document.getElementById('participantCount').style.display = 'none';
      document.getElementById('backToHome').style.display = 'none';
      document.getElementById('chatOptions').style.display = 'none';
      document.getElementById('chatOptionsDropdown').style.display = 'none';
      
      // 활성 채팅방 선택 해제
      document.querySelectorAll('.room-list li, #dmList li, #interestList li').forEach(li => {
        li.classList.remove('active');
      });
        }

        // 서버에서 받은 메시지 추가 (시스템 메시지 포함)
        function addMessageFromServer(msg) {
            if (!currentRoom) return;
            
            const messages = document.getElementById('messages');
            const anonProfile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
            const myNickname = anonProfile ? anonProfile.nickname : '익명';
            
            // 시간 문자열 생성
            let timeString = '';
            if (msg.timestamp) {
                const date = new Date(msg.timestamp * 1000);
                timeString = date.toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                });
            }
            
            const messageWrapper = document.createElement('div');
            
            // 시스템 메시지 처리
            if (msg.type === 'wait' || msg.type === 'enter' || msg.type === 'leave') {
                messageWrapper.className = 'msg-wrapper system';
                messageWrapper.style.justifyContent = 'center';
                messageWrapper.style.margin = '8px 0';
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'msg system';
                
                // 메시지 타입에 따른 스타일 설정
                if (msg.type === 'enter') {
                    messageDiv.style.background = 'linear-gradient(135deg, #dcfce7, #bbf7d0)';
                    messageDiv.style.color = '#166534';
                    messageDiv.style.border = '1px solid #86efac';
                } else if (msg.type === 'wait') {
                    messageDiv.style.background = 'linear-gradient(135deg, #fef3c7, #fde68a)';
                    messageDiv.style.color = '#92400e';
                    messageDiv.style.border = '1px solid #fbbf24';
                } else {
                    // leave
                    messageDiv.style.background = 'linear-gradient(135deg, #f3f4f6, #e5e7eb)';
                    messageDiv.style.color = '#6b7280';
                    messageDiv.style.border = '1px solid #d1d5db';
                }
                
                messageDiv.style.fontSize = '12px';
                messageDiv.style.fontStyle = 'italic';
                messageDiv.style.maxWidth = 'auto';
                messageDiv.style.padding = '6px 12px';
                messageDiv.style.borderRadius = '12px';
                
                messageDiv.innerHTML = `
                    <div class="msg-content">${msg.content}</div>
                    <div class="msg-time" style="font-size: 10px; margin-top: 2px; opacity: 0.7;">${timeString}</div>
                `;
                
                messageWrapper.appendChild(messageDiv);
            } else {
                // 일반 메시지
                const isMyMessage = msg.sender === myNickname;
                messageWrapper.className = `msg-wrapper ${isMyMessage ? 'me' : ''}`;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `msg ${isMyMessage ? 'me' : ''}`;
                
                if (isMyMessage) {
                    // 내 메시지
                    messageDiv.innerHTML = `
                        <div class="msg-content">${msg.content}</div>
                        <div class="msg-time">${timeString}</div>
                    `;
                } else {
                    // 상대방 메시지
                    messageDiv.innerHTML = `
                        <div class="msg-nickname">${msg.sender}</div>
                        <div class="msg-content">${msg.content}</div>
                        <div class="msg-time">${timeString}</div>
                    `;
                }
                
                messageWrapper.appendChild(messageDiv);
            }
            
            messages.appendChild(messageWrapper);
            messages.scrollTop = messages.scrollHeight;
        }

        // 메시지 추가 (로컬 전용)
        function addMessage(text, isMe, nickname = null) {
            if (!currentRoom) return;
            
            const messages = document.getElementById('messages');
            
            // 현재 시간 생성
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            
            // 메시지 데이터 생성
            const messageData = {
                text: text,
                isMe: isMe,
                nickname: isMe ? (JSON.parse(localStorage.getItem('anonProfile') || '{}').nickname || '나') : (nickname || getRandomNickname()),
                timestamp: now.toISOString(),
                timeString: timeString
            };
            
            // 채팅 데이터에 저장
            if (!chatData.rooms[currentRoom]) {
                chatData.rooms[currentRoom] = [];
            }
            chatData.rooms[currentRoom].push(messageData);
            saveChatData();
            
            // 메시지 래퍼 생성
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `msg-wrapper ${isMe ? 'me' : ''}`;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `msg ${isMe ? 'me' : ''}`;
            
            if (isMe) {
                // 내 메시지
                messageDiv.innerHTML = `
                    <div class="msg-content">${text}</div>
                    <div class="msg-time">${timeString}</div>
                `;
            } else {
                // 상대방 메시지 (닉네임 포함)
                messageDiv.innerHTML = `
                    <div class="msg-nickname">${messageData.nickname}</div>
                    <div class="msg-content">${text}</div>
                    <div class="msg-time">${timeString}</div>
                `;
            }
            
            messageWrapper.appendChild(messageDiv);
            messages.appendChild(messageWrapper);
            messages.scrollTop = messages.scrollHeight;
        }

        // 나가기 메시지 추가
        function addLeaveMessage(nickname) {
            if (!currentRoom) return;
            
            const messages = document.getElementById('messages');
            
            // 현재 시간 생성
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            
            // 나가기 메시지 데이터 생성
            const leaveMessageData = {
                text: `${nickname}님이 채팅방을 나갔습니다.`,
                isMe: false,
                nickname: '시스템',
                timestamp: now.toISOString(),
                timeString: timeString,
                type: 'leave'
            };
            
            // 채팅 데이터에 저장
            if (!chatData.rooms[currentRoom]) {
                chatData.rooms[currentRoom] = [];
            }
            chatData.rooms[currentRoom].push(leaveMessageData);
            saveChatData();
            
            // 시스템 메시지 래퍼 생성
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'msg-wrapper system';
            messageWrapper.style.justifyContent = 'center';
            messageWrapper.style.margin = '8px 0';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'msg system';
            messageDiv.style.background = 'linear-gradient(135deg, #f3f4f6, #e5e7eb)';
            messageDiv.style.color = '#6b7280';
            messageDiv.style.fontSize = '12px';
            messageDiv.style.fontStyle = 'italic';
            messageDiv.style.maxWidth = 'auto';
            messageDiv.style.padding = '6px 12px';
            messageDiv.style.borderRadius = '12px';
            messageDiv.style.border = '1px solid #d1d5db';
            
            messageDiv.innerHTML = `
                <div class="msg-content">${leaveMessageData.text}</div>
                <div class="msg-time" style="font-size: 10px; margin-top: 2px; opacity: 0.7;">${timeString}</div>
            `;
            
            messageWrapper.appendChild(messageDiv);
            messages.appendChild(messageWrapper);
            messages.scrollTop = messages.scrollHeight;
        }

        // 랜덤 닉네임 생성
        function getRandomNickname() {
            // 1:1 채팅방인 경우 채팅방 이름을 닉네임으로 사용
            const roomData = chatData.roomList.find(room => room.name === currentRoom);
            if (roomData && roomData.type === 'dm') {
                return currentRoom;
            }
            
            // 그룹 채팅방이나 관심분야 방인 경우
            if (currentRoom && roomParticipants[currentRoom] && roomParticipants[currentRoom].users.length > 0) {
                const users = roomParticipants[currentRoom].users;
                // 현재 사용자의 닉네임 제외
                const currentUserNickname = JSON.parse(localStorage.getItem('anonProfile') || '{}').nickname || '나';
                const otherUsers = users.filter(u => u !== currentUserNickname);
                
                if (otherUsers.length > 0) {
                    // 다른 사용자 닉네임 중에서 랜덤 선택
                    return otherUsers[Math.floor(Math.random() * otherUsers.length)];
                }
                
                // 본인만 있는 경우
                return users[Math.floor(Math.random() * users.length)];
            }
            
            // 기본값 (참여자가 없는 경우)
            return '익명' + Math.floor(Math.random() * 100);
        }

    // 채팅 옵션 관련 함수들
    function toggleChatOptions() {
      const dropdown = document.getElementById('chatOptionsDropdown');
      const optionsBtn = document.getElementById('chatOptions');
      
      if (dropdown.style.display === 'none' || dropdown.style.display === '') {
        // 드롭다운 위치 계산
        const btnRect = optionsBtn.getBoundingClientRect();
        dropdown.style.top = (btnRect.bottom + 8) + 'px';
        dropdown.style.right = (window.innerWidth - btnRect.right) + 'px';
        dropdown.style.display = 'block';
      } else {
        dropdown.style.display = 'none';
      }
    }
    
    function showParticipants() {
      const participantsList = document.getElementById('participantsList');
      participantsList.innerHTML = '';
      
      // 현재 사용자 닉네임
      const currentUserNickname = localStorage.getItem('anonProfile') ? 
        JSON.parse(localStorage.getItem('anonProfile')).nickname : '익명의친구';
      
      if (currentRoom && roomParticipants[currentRoom] && roomParticipants[currentRoom].users.length > 0) {
        // 그룹 채팅방 또는 관심분야 방인 경우
        const users = roomParticipants[currentRoom].users;
        
        users.forEach((user, index) => {
          const participantItem = document.createElement('div');
          participantItem.className = 'participant-item';
          participantItem.onclick = () => showParticipantProfile(user);
          
          const isMe = user === currentUserNickname;
          
          participantItem.innerHTML = `
            <div class="participant-avatar">👤</div>
            <div class="participant-info">
              <div class="participant-name">${user}${isMe ? ' (나)' : ''}</div>
              <div class="participant-status">온라인</div>
            </div>
            <div class="participant-profile">프로필 보기</div>
          `;
          
          participantsList.appendChild(participantItem);
        });
      } else {
        // 1:1 채팅방인 경우 (상대방과 나)
        const opponentName = currentRoom; // 1:1 채팅에서는 방 이름이 상대방 이름
        
        // 상대방 프로필
        const opponentItem = document.createElement('div');
        opponentItem.className = 'participant-item';
        opponentItem.onclick = () => showParticipantProfile(opponentName);
        
        opponentItem.innerHTML = `
          <div class="participant-avatar">👤</div>
          <div class="participant-info">
            <div class="participant-name">${opponentName}</div>
            <div class="participant-status">온라인</div>
          </div>
          <div class="participant-profile">프로필 보기</div>
        `;
        participantsList.appendChild(opponentItem);
        
        // 내 프로필
        const myItem = document.createElement('div');
        myItem.className = 'participant-item';
        myItem.onclick = () => showParticipantProfile(currentUserNickname);
        
        myItem.innerHTML = `
          <div class="participant-avatar">👤</div>
          <div class="participant-info">
            <div class="participant-name">${currentUserNickname} (나)</div>
            <div class="participant-status">온라인</div>
          </div>
          <div class="participant-profile">프로필 보기</div>
        `;
        participantsList.appendChild(myItem);
      }
      
      document.getElementById('participantsModal').style.display = 'flex';
      document.getElementById('chatOptionsDropdown').style.display = 'none';
    }
    
    function closeParticipantsModal() {
      document.getElementById('participantsModal').style.display = 'none';
    }
    
    function showParticipantProfile(nickname) {
      // 내 프로필인지 확인
      const currentUser = localStorage.getItem('anonProfile') ? 
        JSON.parse(localStorage.getItem('anonProfile')).nickname : '익명의친구';
      
      let profile;
      
      if (nickname === currentUser || nickname.includes('(나)')) {
        // 내 프로필인 경우
        const myProfile = localStorage.getItem('anonProfile') ? 
          JSON.parse(localStorage.getItem('anonProfile')) : null;
        
        profile = myProfile ? {
          year: myProfile.year,
          gender: myProfile.gender,
          bio: myProfile.bio,
          interests: myProfile.interests
        } : {
          year: '2024',
          gender: '남자',
          bio: '새로운 친구를 만나고 싶어요!',
          interests: ['운동', '음악']
        };
      } else {
        // 다른 사용자 프로필인 경우 - randomProfiles에서 찾기
        const foundProfile = randomProfiles.find(p => p.nickname === nickname);
        
        if (foundProfile) {
          profile = foundProfile;
        } else {
          // 기본 프로필 (찾지 못한 경우)
          profile = {
            year: '익명',
            gender: '비공개',
            bio: '프로필 정보가 없습니다.',
            interests: []
          };
        }
      }
      
      const profileContent = document.getElementById('participantProfileContent');
      profileContent.innerHTML = `
        <div class="profile-avatar-large">👤</div>
        <h4 style="margin: 0 0 8px 0; color: #374151;">${nickname}</h4>
        <div class="profile-details">
          <div class="profile-detail-item">
            <span class="profile-detail-label">학번</span>
            <span class="profile-detail-value">${profile.year}</span>
          </div>
          <div class="profile-detail-item">
            <span class="profile-detail-label">성별</span>
            <span class="profile-detail-value">${profile.gender}</span>
          </div>
          <div class="profile-detail-item">
            <span class="profile-detail-label">소개</span>
            <span class="profile-detail-value">${profile.bio}</span>
          </div>
          <div class="profile-detail-item">
            <span class="profile-detail-label">관심사</span>
            <span class="profile-detail-value">${profile.interests.join(', ')}</span>
          </div>
        </div>
      `;
      
      document.getElementById('participantProfileModal').style.display = 'flex';
      closeParticipantsModal();
    }
    
    function closeParticipantProfileModal() {
      document.getElementById('participantProfileModal').style.display = 'none';
    }
    
    
    async function leaveChatRoom() {
      if (confirm('정말로 채팅방을 나가시겠습니까?')) {
        if (!currentRoom) return;
        
        const roomToLeave = currentRoom;
        console.log(`[나가기 시작] ${roomToLeave} 채팅방`);
        
        // 현재 사용자 정보 가져오기
        const currentUser = localStorage.getItem('anonProfile') ? 
          JSON.parse(localStorage.getItem('anonProfile')).nickname : '익명의친구';
        
        // 서버에 나가기 메시지 전송
        try {
          const leaveResponse = await fetch(`/api/chat/leave/${encodeURIComponent(roomToLeave)}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              nickname: currentUser
            })
          });
          
          if (leaveResponse.ok) {
            console.log(`[나가기 메시지] 서버에 나가기 메시지 전송 완료: ${roomToLeave}`);
          }
        } catch (error) {
          console.error('[나가기 메시지] 서버 전송 실패:', error);
        }
        
        // 1:1 채팅방인 경우 서버에 방 비활성화 요청
        const roomData = chatData.roomList.find(room => room.name === roomToLeave);
        if (roomData && roomData.type === 'dm' && roomData.roomId) {
          try {
            const roomLeaveResponse = await fetch(`/api/room/${encodeURIComponent(roomData.roomId)}/leave`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            if (roomLeaveResponse.ok) {
              console.log(`[방 비활성화] ${roomToLeave} 방을 서버에서 비활성화 완료`);
            }
          } catch (error) {
            console.error('[방 비활성화] 서버 요청 실패:', error);
          }
        }
        // 그룹 채팅방인 경우 서버에 그룹 나가기 요청
        else if (roomData && roomData.type === 'group' && roomData.roomId) {
          try {
            const groupLeaveResponse = await fetch(`/api/group/${encodeURIComponent(roomData.roomId)}/leave`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            if (groupLeaveResponse.ok) {
              console.log(`[그룹 나가기] ${roomToLeave} 그룹에서 서버 나가기 완료`);
            }
          } catch (error) {
            console.error('[그룹 나가기] 서버 요청 실패:', error);
          }
        }
        
        // 나가기 메시지 추가
        addLeaveMessage(currentUser);
        
        // 1. 나간 채팅방 목록에 추가 (최우선)
        let leftRooms = JSON.parse(localStorage.getItem('leftRooms') || '[]');
        if (!leftRooms.includes(roomToLeave)) {
          leftRooms.push(roomToLeave);
          localStorage.setItem('leftRooms', JSON.stringify(leftRooms));
          console.log(`[나가기 1/5] ${roomToLeave}을 나간 방 목록에 추가 (현재 나간 방: ${leftRooms.length}개)`);
        }
        
        // 2. 관심분야 방인 경우 서버에서 참여자 수 업데이트 및 프로필에서 제거
        try {
          const anonProfile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
          if (anonProfile && anonProfile.interests && anonProfile.interests.includes(roomToLeave)) {
            // 서버에 관심분야 방 나가기 요청
            const interestLeaveResponse = await fetch(`/api/interest/${encodeURIComponent(roomToLeave)}/leave`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            if (interestLeaveResponse.ok) {
              const result = await interestLeaveResponse.json();
              if (result.success) {
                // 로컬 프로필에서도 제거
                const interestIndex = anonProfile.interests.indexOf(roomToLeave);
                if (interestIndex > -1) {
                  anonProfile.interests.splice(interestIndex, 1);
                  localStorage.setItem('anonProfile', JSON.stringify(anonProfile));
                  console.log(`[나가기 2/5] 관심분야 방 ${roomToLeave}에서 나가기 완료 (남은 관심사: ${anonProfile.interests.length}개)`);
                  
                  // 참여자 수 업데이트를 위해 관심분야 카운트 다시 로드
                  await loadInterestCounts();
                }
              } else {
                console.error(`[나가기 2/5] 서버 관심분야 나가기 실패:`, result.message);
              }
            } else {
              console.error(`[나가기 2/5] 서버 관심분야 나가기 요청 실패`);
            }
          }
        } catch (e) {
          console.error(`[나가기 2/5] 관심분야 나가기 처리 실패:`, e);
        }
        
        // 3. 채팅방 목록에서 제거 (즉시)
        const beforeCount = chatData.roomList.length;
        chatData.roomList = chatData.roomList.filter(room => room.name !== roomToLeave);
        console.log(`[나가기 3/5] 채팅방 목록에서 제거: ${roomToLeave} (${beforeCount}개 → ${chatData.roomList.length}개)`);
        
        // 4. 채팅 기록 삭제
        if (chatData.rooms[roomToLeave]) {
            delete chatData.rooms[roomToLeave];
            console.log(`[나가기 4/5] ${roomToLeave}의 채팅 기록 삭제`);
        }
        
        // 5. 그룹 채팅방인 경우 참여자 수 감소
        if (roomParticipants[roomToLeave]) {
          roomParticipants[roomToLeave].count = Math.max(0, roomParticipants[roomToLeave].count - 1);
          
          // 참여자 목록에서 현재 사용자 제거
          const userIndex = roomParticipants[roomToLeave].users.indexOf(currentUser);
          if (userIndex > -1) {
            roomParticipants[roomToLeave].users.splice(userIndex, 1);
          }
        }
        
        // 6. 데이터 저장 (필터링 포함)
        saveChatData();
        console.log(`[나가기 5/5] 데이터 저장 완료`);
        
        // 7. UI 업데이트
        updateRoomListUI();
        
        // 8. 관심분야 목록도 즉시 업데이트 (새로고침 없이)
        const profile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
        if (profile && profile.interests) {
          updateInterestList(profile.interests);
          console.log(`[나가기 완료] 관심분야 목록 업데이트: ${profile.interests.length}개 표시`);
        }
        
        console.log(`[나가기 완료] ${roomToLeave} 방 나가기 완료, UI 업데이트됨`);
        
        // 홈으로 돌아가기
        backToHome();
        alert('채팅방에서 나갔습니다.');
      }
      document.getElementById('chatOptionsDropdown').style.display = 'none';
    }
    
    // 방별 참여자 수 업데이트
    function updateRoomParticipantCount(roomName) {
      document.querySelectorAll('.room-list li').forEach(li => {
        const roomInfo = li.querySelector('.room-info');
        if (roomInfo) {
          const roomNameSpan = roomInfo.querySelector('.room-name');
          if (roomNameSpan && roomNameSpan.textContent === roomName) {
            const countSpan = roomInfo.querySelector('.participant-count');
            const newCount = roomParticipants[roomName]?.count || 0;
            countSpan.textContent = `${newCount}명`;
          }
        }
      });
    }
    
    // 방별 읽지 않은 메시지 수 업데이트
    function updateRoomUnreadCount(roomName) {
      document.querySelectorAll('.room-list li').forEach(li => {
        const roomInfo = li.querySelector('.room-info');
        if (roomInfo) {
          const roomNameSpan = roomInfo.querySelector('.room-name');
          if (roomNameSpan && roomNameSpan.textContent === roomName) {
            const roomNameWrapper = roomInfo.querySelector('.room-name-wrapper');
            const unreadCount = roomParticipants[roomName]?.unreadCount || 0;
            
            // 기존 배지 제거
            const existingBadge = roomNameWrapper.querySelector('.unread-badge');
            if (existingBadge) {
              existingBadge.remove();
            }
            
            // 새 배지 추가 (읽지 않은 메시지가 있을 때만)
            if (unreadCount > 0) {
              const badge = document.createElement('span');
              badge.className = 'unread-badge';
              badge.textContent = unreadCount;
              roomNameWrapper.appendChild(badge);
            }
          }
        }
      });
    }
    
    // 읽지 않은 메시지 수 증가 (상대방 메시지 수신 시)
    function incrementUnreadCount(roomName) {
      if (roomName !== currentRoom && roomParticipants[roomName]) {
        roomParticipants[roomName].unreadCount++;
        updateRoomUnreadCount(roomName);
      }
    }
    
    // 서버에서 익명 프로필 가져오기
    async function loadRandomProfiles() {
      try {
        const response = await fetch("{{ url_for('get_anon_profiles') }}");
        const result = await response.json();
        
        if (result.success && result.profiles) {
          // 전역 변수에 저장
          randomProfiles.length = 0; // 배열 초기화
          randomProfiles.push(...result.profiles);
          
          // UI 업데이트
          generateRandomProfiles();
        } else {
          console.error('프로필 로드 실패:', result.message);
        }
      } catch (error) {
        console.error('프로필 로드 오류:', error);
      }
    }
    
    // 랜덤 매칭 프로필 생성
    function generateRandomProfiles() {
      const container = document.getElementById('profileCardsContainer');
      container.innerHTML = '';
      
      if (randomProfiles.length === 0) {
        container.innerHTML = '<div style="padding: 40px; text-align: center; color: #999; width: 100%;">현재 매칭 가능한 프로필이 없습니다.</div>';
        return;
      }
      
      randomProfiles.forEach(profile => {
        const card = document.createElement('div');
        card.className = 'random-profile-card';
        card.innerHTML = `
          <div class="random-profile-avatar">${profile.avatar}</div>
          <div class="random-profile-name">${profile.nickname}</div>
          <div class="random-profile-details">${profile.year} · ${profile.gender}</div>
          <div class="random-profile-bio">${profile.bio || '안녕하세요!'}</div>
          <button class="random-profile-btn" onclick="viewProfile('${profile.nickname}')">프로필 보기</button>
        `;
        container.appendChild(card);
      });
    }
    
    // 프로필 보기
    function viewProfile(profileNickname) {
      const profile = randomProfiles.find(p => p.nickname === profileNickname);
      if (profile) {
        const modalContent = document.getElementById('profileDetailContent');
        
        // 관심사 태그 생성
        const interestsHtml = profile.interests.map(interest => 
          `<span class="profile-detail-interest-tag">${interest}</span>`
        ).join('');
        
        modalContent.innerHTML = `
          <div class="profile-detail-avatar">${profile.avatar}</div>
          <div class="profile-detail-name">${profile.nickname}</div>
          <div class="profile-detail-info">${profile.year} · ${profile.gender}</div>
          <div class="profile-detail-bio">${profile.bio || '안녕하세요!'}</div>
          <div class="profile-detail-interests">
            <div class="profile-detail-interests-title">관심사</div>
            <div class="profile-detail-interests-list">
              ${interestsHtml}
            </div>
          </div>
          <div class="profile-detail-actions">
            <button class="profile-detail-btn secondary" onclick="closeProfileDetailModal()">닫기</button>
          </div>
        `;
        
        document.getElementById('profileDetailModal').style.display = 'flex';
      }
    }
    
    // 프로필 상세 모달 닫기
    function closeProfileDetailModal() {
      document.getElementById('profileDetailModal').style.display = 'none';
    }
    
    
    // 프로필 캐러셀 스크롤
    function scrollProfiles(direction) {
      const container = document.getElementById('profileCardsContainer');
      const scrollAmount = 220; // 카드 너비 + 간격
      container.scrollBy({
        left: direction * scrollAmount,
        behavior: 'smooth'
      });
    }

    // 익명 프로필 체크 함수
    function checkAnonProfile() {
      try {
        const profile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
        
        // 프로필이 없거나 필수 정보가 누락된 경우
        if (!profile || !profile.year || !profile.gender || !profile.interests || profile.interests.length === 0) {
          // 프로필 설정 페이지로 리다이렉트
          alert('랜덤 매칭을 이용하려면 먼저 익명 프로필을 설정해주세요!');
          window.spaRouter.navigateTo('/profile-setup');
          return false;
        }
        return true;
      } catch (e) {
        console.error('프로필 체크 실패:', e);
        alert('랜덤 매칭을 이용하려면 먼저 익명 프로필을 설정해주세요!');
        window.spaRouter.navigateTo('/profile-setup');
        return false;
      }
    }

    // 서버에서 사용자의 방 목록 로드
    async function loadUserRoomsFromServer() {
      try {
        const response = await fetch('/api/rooms');
        const result = await response.json();
        
        if (result.success && result.rooms) {
          // 서버에서 받은 방 목록과 로컬 방 목록 비교
          const serverRooms = result.rooms;
          const currentRoomNames = chatData.roomList.map(room => room.name);
          
          for (const serverRoom of serverRooms) {
            if (!currentRoomNames.includes(serverRoom.room_name)) {
              // 새로운 방을 로컬에 추가
              const newRoom = {
                name: serverRoom.room_name,
                type: serverRoom.type,
                roomId: serverRoom.room_id,
                unreadCount: 0,
                createdAt: serverRoom.created_at
              };
              
              chatData.roomList.push(newRoom);
              
              // roomParticipants에 추가
              if (serverRoom.type === 'dm') {
                roomParticipants[serverRoom.room_name] = {
                  count: 2,
                  users: [serverRoom.room_name],
                  unreadCount: 0
                };
              }
              
              // 채팅방 데이터 초기화
              if (!chatData.rooms[serverRoom.room_name]) {
                chatData.rooms[serverRoom.room_name] = [];
              }
              
              console.log(`[서버 동기화] 새로운 방 발견: ${serverRoom.room_name} (${serverRoom.type})`);
            }
          }
          
          if (serverRooms.length > 0) {
            saveChatData();
            updateRoomListUI();
            console.log(`[서버 동기화] ${serverRooms.length}개 방 동기화 완료`);
          }
        }
      } catch (error) {
        console.error('서버 방 목록 로드 실패:', error);
      }
    }

    // 이벤트 리스너
    document.addEventListener('DOMContentLoaded', function() {
      // 익명 프로필 체크
      if (!checkAnonProfile()) {
        return; // 프로필이 없으면 초기화 중단
      }
      
      // 년도 설정
      document.getElementById('year').textContent = new Date().getFullYear();
      
      // 채팅 데이터 로드
      loadChatData();
      
      // 서버에서 사용자의 방 목록 동기화
      loadUserRoomsFromServer();
      
      // 나간 채팅방 확실히 제거 (페이지 로드 시)
      const leftRooms = JSON.parse(localStorage.getItem('leftRooms') || '[]');
      if (leftRooms.length > 0) {
        console.log(`[페이지 로드] 나간 방 ${leftRooms.length}개 확인:`, leftRooms);
        const beforeCount = chatData.roomList.length;
        chatData.roomList = chatData.roomList.filter(room => !leftRooms.includes(room.name));
        const afterCount = chatData.roomList.length;
        if (beforeCount !== afterCount) {
          console.log(`[페이지 로드] ${beforeCount - afterCount}개 채팅방 제거됨 (${beforeCount} → ${afterCount})`);
          saveChatData();
        }
      }
      
      updateRoomListUI();
      
      // 관심분야 목록 다시 렌더링 (나간 방과 관계없이 항상 표시)
      const profile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
      if (profile && profile.interests) {
        updateInterestList(profile.interests);
        console.log(`[페이지 로드] 관심분야 목록 ${profile.interests.length}개 다시 렌더링`);
      }
      
      // 채팅 옵션 버튼 이벤트
      document.getElementById('chatOptions').addEventListener('click', toggleChatOptions);
      
      // 드롭다운 외부 클릭 시 닫기
      document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('chatOptionsDropdown');
        const optionsBtn = document.getElementById('chatOptions');
        
        if (!dropdown.contains(e.target) && !optionsBtn.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });
      
      // 모달 외부 클릭 시 닫기
      document.addEventListener('click', function(e) {
        const participantsModal = document.getElementById('participantsModal');
        const participantProfileModal = document.getElementById('participantProfileModal');
        const profileDetailModal = document.getElementById('profileDetailModal');
        
        if (e.target === participantsModal) {
          closeParticipantsModal();
        }
        
        if (e.target === participantProfileModal) {
          closeParticipantProfileModal();
        }
        
        if (e.target === profileDetailModal) {
          closeProfileDetailModal();
        }
      });
      
      // 서버에서 받은 프로필이 있으면 localStorage에 저장
      {% if anon_profile %}
      const serverProfile = {{ anon_profile|tojson|safe }};
      if (serverProfile && Object.keys(serverProfile).length > 0) {
        localStorage.setItem('anonProfile', JSON.stringify(serverProfile));
        console.log('서버 프로필을 localStorage에 저장:', serverProfile);
      } else {
        // 서버에 프로필이 없으면 localStorage의 이전 프로필 삭제
        localStorage.removeItem('anonProfile');
        console.log('서버에 익명 프로필이 없어 localStorage에서 삭제');
      }
      {% else %}
      // 서버에 프로필이 없으면 localStorage의 이전 프로필 삭제
      localStorage.removeItem('anonProfile');
      console.log('서버에 익명 프로필이 없어 localStorage에서 삭제');
      {% endif %}
      
      loadAnonProfile();
      
      // 서버에서 관심사별 참여자 수 로드
      loadInterestCounts();
      
      // 서버에서 랜덤 매칭 프로필 로드
      loadRandomProfiles();
      
      // 기본 관심분야 방들을 채팅방 목록에 추가
      initializeDefaultInterestRooms();
      
      // 매칭 버튼
      document.getElementById('startRandom').addEventListener('click', startRandomMatching);
      document.getElementById('startGroup').addEventListener('click', startGroupMatching);
      document.getElementById('cancelRandom').addEventListener('click', cancelRandomMatching);
      document.getElementById('cancelGroup').addEventListener('click', cancelGroupMatching);
      
      // 메시지 전송
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

      // 랜덤 매칭 홈으로 돌아가기
      document.getElementById('backToHome').addEventListener('click', backToHome);
      
      // 페이지 포커스 시 관심분야 목록 업데이트 (마이페이지에서 수정 후 돌아왔을 때)
      window.addEventListener('focus', function() {
        const profile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
        if (profile && profile.interests) {
          updateInterestList(profile.interests);
          console.log(`[페이지 포커스] 관심분야 목록 업데이트: ${profile.interests.length}개`);
        }
      });
      
      // 페이지 보이기 이벤트 (탭 전환 시)
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
          const profile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
          if (profile && profile.interests) {
            updateInterestList(profile.interests);
            console.log(`[페이지 가시화] 관심분야 목록 업데이트: ${profile.interests.length}개`);
          }
        }
      });

      // 모바일 메뉴는 navigation.js에서 처리됩니다
    });
    </script>
    <script src="{{ url_for("static", filename="js/script.js") }}"></script>
    <script src="{{ url_for("static", filename="js/navigation.js") }}"></script>
    <script src="{{ url_for("static", filename="js/router.js") }}"></script>
</body>
</html>