<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KBU hub | ì±„íŒ…</title>
  <link rel="icon" href="{{ url_for("static", filename="images/logo.png") }}">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
   <link rel="stylesheet" href="{{ url_for("static", filename="css/nav.css") }}">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { peach: '#FFC8B2', peachDeep: '#FF9F80', cream: '#FFF7F2', cocoa:'#6B7280', ink:'#1F2937', mint:'#B7F4E6', lemon:'#FFF3A3' },
          boxShadow: { soft:'0 10px 30px rgba(255,159,128,.18)', glow:'0 0 0 0 rgba(255,159,128,.0)', card:'0 10px 24px rgba(17,24,39,.08)' },
          borderRadius: { bubble:'999px', xl2:'1.25rem' }
        }
      }
    }
  </script>
  <style>
    html, body { font-family: Pretendard, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif; }
    .top-grad{ background: radial-gradient(60% 60% at 0% 0%, #FFF0E7 0%, rgba(255,240,231,0) 60%), radial-gradient(60% 60% at 100% 0%, #FFE7DB 0%, rgba(255,231,219,0) 60%); }
    .glass{ background: rgba(255,255,255,.7); backdrop-filter: blur(10px); }
     /* ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤íƒ€ì¼ì€ nav.css (CSS Cascade Layers)ì—ì„œ ê´€ë¦¬ */
    
    /* í—¤ë” ìŠ¤íƒ€ì¼ì€ nav.cssì—ì„œ ê´€ë¦¬ */
    
    /* ë°˜ì‘í˜• ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤íƒ€ì¼ì€ nav.cssì—ì„œ ê´€ë¦¬ */
    
    /* ì±„íŒ… ë ˆì´ì•„ì›ƒ */
    .chat-layout { 
        display: grid; 
        grid-template-columns: 280px 1fr; 
        gap: 24px; 
        padding: 24px; 
        max-width: 1200px; 
        margin: 0 auto;
        min-height: calc(100vh - 160px);
        align-items: start;
    }
    
    /* ì‚¬ì´ë“œë°” ì»¬ëŸ¼ */
    .sidebar-column {
        display: flex;
        flex-direction: column;
        gap: 16px;
        height: fit-content;
        overflow-y: visible;
        position: sticky;
        top: 100px;
        align-self: flex-start;
    }
    
    /* ì‚¬ì´ë“œë°” ì¹´ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .sidebar-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 24px rgba(17, 24, 39, 0.08);
        overflow: hidden;
        transition: all 0.3s ease;
        height: fit-content;
    }
    
    .sidebar-card:hover {
        box-shadow: 0 20px 40px rgba(17, 24, 39, 0.12);
        transform: translateY(-2px);
    }
    
    .sidebar-card-header {
        padding: 20px 20px 12px;
        border-bottom: 1px solid rgba(255, 159, 124, 0.1);
    }
    
    .sidebar-card-title {
        font-size: 16px;
        font-weight: 600;
        color: #1F2937;
        margin: 0;
    }
    
    .sidebar-card-body {
        padding: 16px 20px 20px;
    }
    
    /* ë°˜ì‘í˜• ì±„íŒ… ë ˆì´ì•„ì›ƒ */
    @media (max-width: 1024px) {
        .chat-layout {
            grid-template-columns: 280px 1fr;
            gap: 16px;
            padding: 20px;
        }
    }
    
    @media (max-width: 768px) {
        .chat-layout {
            grid-template-columns: 1fr;
            gap: 16px;
            padding: 16px;
            margin-top: 70px;
        }
        
        .sidebar-panel {
            position: relative;
            top: 0;
            max-height: 300px;
            margin-bottom: 20px;
        }
    }
    
    @media (max-width: 640px) {
        .chat-layout {
            padding: 12px;
            margin-top: 65px;
        }
    }
    
    .panel { 
        background: #fff; 
        border-radius: 16px; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
        border: 1px solid rgba(255, 200, 178, 0.2);
        overflow: hidden;
    }
    
    .sidebar-panel {
        height: fit-content;
        max-height: calc(100vh - 330px);
        position: sticky;
        top: 100px;
        overflow-y: auto;
        z-index: 10;
    }
    
    .main-panel {
        height: fit-content;
        min-height: 500px;
    }
    
    .panel-header { 
        padding: 16px 20px; 
        border-bottom: 1px solid #f0f0f0; 
        font-weight: 700; 
        background: linear-gradient(135deg, #FFF7F2, #ffffff);
        font-size: 16px;
    }
    
    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        position: relative;
    }
    
    .header-left {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .header-right {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .participant-count-header {
        font-size: 12px;
        color: #6B7280;
        font-weight: 400;
    }
    
    .panel-body { 
        padding: 16px 20px; 
    }
    
    .sidebar-body {
        padding: 16px 20px;
        max-height: calc(100vh - 350px);
        overflow-y: auto;
    }
    
    /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
    .sidebar-section {
        margin-bottom: 24px;
    }
    
    .sidebar-section:last-child {
        margin-bottom: 0;
    }
    
    .sidebar-title {
        font-size: 14px;
        font-weight: 600;
        color: #6B7280;
        margin-bottom: 8px;
        padding: 0 4px;
    }
    
    .room-list { 
        list-style: none; 
        margin: 0; 
        padding: 0; 
    }
    
    .room-list li { 
        padding: 12px 16px; 
        border-radius: 12px; 
        cursor: pointer; 
        margin-bottom: 4px;
        transition: all 0.3s ease;
        font-size: 14px;
        color: #374151;
    }
    
    .room-list li:hover { 
        background: #FFF0E5; 
        transform: translateX(4px);
    }
    
    .room-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }
    
    .room-name {
        font-weight: 600;
        color: #333;
    }
    
    .participant-count {
        font-size: 12px;
        color: #FF8C42;
        background: #FFE4D1;
        padding: 4px 10px;
        border-radius: 16px;
        font-weight: 600;
        margin-left: auto;
    }
    
    .room-name-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .unread-badge {
        background: #dc2626;
        color: white;
        font-size: 11px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 10px;
        min-width: 18px;
        text-align: center;
        line-height: 1.2;
    }
    
    .room-list li.active { 
        background: linear-gradient(135deg, #FF9F80, #FFC8B2);
        color: white;
        box-shadow: 0 4px 12px rgba(255, 159, 128, 0.3);
    }
    
    /* í”„ë¡œí•„ ì¹´ë“œ */
    .profile-card {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 20px;
        background: linear-gradient(135deg, #FFF7F2, #ffffff);
        border-radius: 16px;
        margin-bottom: 20px;
        border: 1px solid rgba(255, 200, 178, 0.3);
    }
    
    .profile-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #FF9F80, #FFC8B2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: white;
        box-shadow: 0 4px 12px rgba(255, 159, 128, 0.3);
    }
    
    .profile-info {
        flex: 1;
    }
    
    .profile-name {
        font-weight: 700;
        font-size: 18px;
        color: #1F2937;
        margin-bottom: 4px;
    }
    
    .profile-details {
        font-size: 14px;
        color: #6B7280;
        margin-bottom: 2px;
    }
    
    .profile-bio {
        font-size: 13px;
        color: #9CA3AF;
        margin-top: 8px;
        line-height: 1.4;
    }
    
    .profile-actions {
        display: flex;
        gap: 8px;
    }
    
    .btn-edit {
        padding: 8px 12px;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        font-size: 12px;
        color: #6c757d;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .btn-edit:hover {
        background: #e9ecef;
        border-color: #FF9F80;
        color: #495057;
    }
    
    /* ë§¤ì¹­ ì„¹ì…˜ */
    .matching-grid {
            display: grid; 
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .matching-card {
            background: #fff; 
        border: 1px solid #f0f0f0;
        border-radius: 16px;
        padding: 32px 24px;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .matching-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 159, 128, 0.02) 0%, rgba(255, 200, 178, 0.05) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .matching-card:hover::before {
        opacity: 1;
    }
    
    .matching-card:hover {
        border-color: #FF9F80;
        box-shadow: 0 8px 24px rgba(255, 159, 128, 0.15);
        transform: translateY(-4px);
    }
    
    .matching-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto 16px;
        background: linear-gradient(135deg, #FF9F80, #FFC8B2);
            border-radius: 12px; 
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        position: relative;
        z-index: 1;
    }
    
    .matching-title {
            font-weight: 700; 
        font-size: 18px;
        margin-bottom: 8px;
        color: #1F2937;
        position: relative;
        z-index: 1;
    }
    
    .matching-desc {
        font-size: 14px;
        color: #6B7280;
        margin-bottom: 24px;
        line-height: 1.5;
        position: relative;
        z-index: 1;
    }
    
    .btn {
        padding: 14px 24px;
        border: none;
        border-radius: 12px;
            cursor: pointer; 
        font-weight: 600;
        font-size: 14px;
            transition: all 0.3s ease;
        width: 100%;
        position: relative;
        z-index: 1;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #FF9F80, #FFC8B2);
        color: white;
        box-shadow: 0 4px 12px rgba(255, 159, 128, 0.3);
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 159, 128, 0.4);
        background: linear-gradient(135deg, #FF8A6B, #FFB89D);
    }
    
    .btn-secondary {
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }
    
    .btn-secondary:hover {
        background: #e9ecef;
        border-color: #adb5bd;
    }
    
    /* ë§¤ì¹­ ìƒíƒœ */
    .matching-status {
        text-align: center;
        padding: 16px;
        display: none;
    }
    
    .matching-spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #FF9F80;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 12px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .matching-text {
        font-weight: 600;
        color: #FF9F80;
        margin-bottom: 8px;
    }
    
    .matching-timer {
        font-size: 14px;
        color: #6B7280;
        margin-bottom: 12px;
    }
    
    /* ì±„íŒ… í™”ë©´ */
        .messages { 
        height: 400px; 
        overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
        gap: 12px;
        padding: 16px;
        background: #fafafa;
        border-radius: 12px;
        margin-bottom: 16px;
        align-items: flex-start;
    }
    
        .msg { 
            max-width: 70%; 
        padding: 12px 16px; 
        border-radius: 16px; 
        background: #fff; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        font-size: 14px;
        line-height: 1.4;
        position: relative;
        display: inline-block;
        word-wrap: break-word;
    }
    
        .msg.me { 
            align-self: flex-end; 
        background: linear-gradient(135deg, #FF9F80, #FFC8B2); 
            color: #fff; 
        }
        
        .msg-wrapper {
            display: flex;
        width: 100%;
            margin-bottom: 8px;
        }
        
        .msg-wrapper.me {
            justify-content: flex-end;
        }
    
    .msg-content {
        margin-bottom: 4px;
    }
    
    .msg-time {
        font-size: 11px;
        opacity: 0.7;
        text-align: right;
        margin-top: 4px;
    }
    
    .msg-nickname {
        font-size: 12px;
        color: #FF9F80;
        font-weight: 600;
        margin-bottom: 4px;
        display: block;
    }
    
    .msg.me .msg-nickname {
        display: none;
    }
    
    .msg.me .msg-time {
        color: rgba(255, 255, 255, 0.8);
    }
    
    .msg:not(.me) .msg-time {
        color: #999;
    }
    
        .composer { 
            display: flex; 
        gap: 12px; 
        padding: 16px;
        background: #f8f9fa;
        border-radius: 12px;
    }
    
        .composer input { 
        flex: 4; 
        padding: 12px 16px; 
        border: 1px solid #e9ecef; 
            border-radius: 10px; 
        font-size: 14px;
        background: white;
        min-width: 0;
    }
    
    .composer .btn {
        flex: 1;
        min-width: 80px;
        white-space: nowrap;
    }
    
    /* í—¤ë” í™ˆ ë²„íŠ¼ */
    .btn-home {
        background: linear-gradient(135deg, #FF9F80, #FFC8B2);
            border: none;
        color: white;
        padding: 8px 12px;
            border-radius: 8px;
        font-size: 13px;
            font-weight: 600;
        cursor: pointer;
            transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 2px 8px rgba(255, 159, 128, 0.3);
    }
    
    .btn-home:hover {
        background: linear-gradient(135deg, #FF8A6B, #FFB89D);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 159, 128, 0.4);
    }
    
    .btn-home svg {
        width: 14px;
        height: 14px;
    }
    
    /* ì±„íŒ… ì˜µì…˜ ë²„íŠ¼ */
    .btn-options {
        background: transparent;
            border: none;
        color: #6B7280;
        padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-options:hover {
        background: rgba(107, 114, 128, 0.1);
        color: #374151;
    }
    
    /* ì±„íŒ… ì˜µì…˜ ë“œë¡­ë‹¤ìš´ */
    .chat-options-dropdown {
        position: fixed;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        min-width: 200px;
        z-index: 1000;
        overflow: hidden;
    }
    
    .dropdown-header {
        padding: 12px 16px;
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .dropdown-item {
        padding: 12px 16px;
        font-size: 14px;
        color: #374151;
        cursor: pointer;
        display: flex;
        align-items: center;
            gap: 12px;
        transition: background-color 0.2s ease;
    }
    
    .dropdown-item:hover {
        background: #f3f4f6;
    }
    
    .dropdown-item.danger {
        color: #dc2626;
    }
    
    .dropdown-item.danger:hover {
        background: #fef2f2;
    }
    
    .dropdown-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 4px 0;
    }
    
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
            width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }
    
    .modal-content {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f9fafb;
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #374151;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6B7280;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }
    
    .modal-close:hover {
        background: #e5e7eb;
        color: #374151;
    }
    
    .modal-body {
            padding: 24px; 
        max-height: 60vh;
        overflow-y: auto;
    }
    
    /* ì°¸ì—¬ì ëª©ë¡ ìŠ¤íƒ€ì¼ */
    .participants-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .participant-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border: 1px solid #e5e7eb;
            border-radius: 12px; 
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
    }
    
    .participant-item:hover {
        border-color: #FF9F80;
        background: #FFF7F2;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 159, 128, 0.2);
    }
    
    .participant-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
            background: linear-gradient(135deg, #FF9F80, #FFC8B2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        margin-right: 12px;
    }
    
    .participant-info {
        flex: 1;
    }
    
    .participant-name {
        font-weight: 600;
        color: #374151;
            margin-bottom: 4px;
    }
    
    .participant-status {
        font-size: 12px;
        color: #6B7280;
    }
    
    /* ì°¸ì—¬ì í”„ë¡œí•„ ìŠ¤íƒ€ì¼ */
    .participant-profile {
        text-align: center;
    }
    
    .profile-avatar-large {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #FF9F80, #FFC8B2);
            display: flex; 
        align-items: center;
        justify-content: center;
        font-size: 36px;
        margin: 0 auto 20px;
    }
    
    .profile-details {
        text-align: left;
        margin-top: 20px;
    }
    
    .profile-detail-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .profile-detail-label {
        font-weight: 600;
        color: #6B7280;
    }
    
    .profile-detail-value {
        color: #374151;
    }
    
    /* ëœë¤ ë§¤ì¹­ í”„ë¡œí•„ ì„¹ì…˜ */
    .random-matching-section {
        margin: 24px 0;
    }
    
    .section-header {
        margin-bottom: 16px;
    }
    
    .section-title {
        font-size: 18px;
        font-weight: 700;
        color: #374151;
            display: flex; 
        align-items: center;
            gap: 8px; 
    }
    
    .profile-carousel {
        position: relative;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .carousel-btn {
        background: #f3f4f6;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #6b7280;
        flex-shrink: 0;
    }
    
    .carousel-btn:hover {
        background: #e5e7eb;
        color: #374151;
        transform: scale(1.05);
    }
    
    .profile-cards-container {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        scroll-behavior: smooth;
        padding: 8px 0;
            flex: 1; 
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    
    .profile-cards-container::-webkit-scrollbar {
        display: none;
    }
    
    .random-profile-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        min-width: 200px;
        max-width: 200px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        text-align: center;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }
    
    .random-profile-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    
    .random-profile-avatar {
        width: 60px;
        height: 60px;
            border-radius: 50%;
        background: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: 600;
        color: #6b7280;
        margin: 0 auto 12px;
    }
    
    .random-profile-name {
        font-size: 16px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 6px;
    }
    
    .random-profile-details {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 8px;
    }
    
    .random-profile-bio {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 16px;
        line-height: 1.4;
        min-height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .random-profile-btn {
        background: linear-gradient(135deg, #FF9F80, #FFC8B2);
        color: white;
        border: none;
        border-radius: 8px;
            padding: 8px 16px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        width: 100%;
        box-shadow: 0 2px 8px rgba(255, 159, 128, 0.3);
    }
    
    .random-profile-btn:hover {
        background: linear-gradient(135deg, #FF8A6B, #FFB89A);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 159, 128, 0.4);
    }
    
    /* í”„ë¡œí•„ ìƒì„¸ ëª¨ë‹¬ */
    .profile-detail-content {
        text-align: center;
    }
    
    .profile-detail-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #FFC8B2, #FF9F80);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        font-weight: 600;
        color: white;
        margin: 0 auto 20px;
        box-shadow: 0 8px 22px rgba(255, 159, 128, 0.35);
    }
    
    .profile-detail-name {
        font-size: 24px;
        font-weight: 700;
        color: #1F2937;
        margin-bottom: 8px;
    }
    
    .profile-detail-info {
        font-size: 16px;
        color: #6B7280;
        margin-bottom: 16px;
    }
    
    .profile-detail-bio {
        font-size: 14px;
        color: #374151;
        line-height: 1.6;
        background: #FFF7F2;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 24px;
        border: 1px solid rgba(255, 159, 128, 0.2);
    }
    
    .profile-detail-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }
    
    .profile-detail-btn {
        padding: 12px 24px;
            border: none;
            border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
            cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .profile-detail-btn.primary {
        background: linear-gradient(135deg, #FF9F80, #FF8A6B);
        color: white;
        box-shadow: 0 4px 12px rgba(255, 159, 128, 0.3);
    }
    
    .profile-detail-btn.primary:hover {
        background: linear-gradient(135deg, #FF8A6B, #FF7A5B);
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(255, 159, 128, 0.4);
    }
    
    .profile-detail-btn.secondary {
        background: #FFF7F2;
        color: #6B7280;
        border: 1px solid rgba(255, 159, 128, 0.3);
    }
    
    .profile-detail-btn.secondary:hover {
        background: #FFC8B2;
        color: #374151;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 159, 128, 0.2);
    }
    
    .profile-detail-interests {
        margin-bottom: 20px;
    }
    
    .profile-detail-interests-title {
        font-size: 14px;
            font-weight: 600;
        color: #6B7280;
        margin-bottom: 8px;
        text-align: center;
    }
    
    .profile-detail-interests-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
    }
    
    .profile-detail-interest-tag {
            background: linear-gradient(135deg, #FF9F80, #FFC8B2);
            color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        box-shadow: 0 2px 6px rgba(255, 159, 128, 0.25);
    }
    
    .composer input:focus {
        outline: none;
        border-color: #FF9F80;
        box-shadow: 0 0 0 3px rgba(255, 159, 128, 0.1);
    }
    
    /* ë§ˆì´í”„ë¡œí•„ ì½˜í…ì¸  ìŠ¤íƒ€ì¼ */
    .my-profile-content {
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }
    
    .my-profile-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #FF9F7C, #FFC8B2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(255, 159, 124, 0.3);
    }
    
    .my-profile-info {
        flex: 1;
        min-width: 0;
    }
    
    .my-profile-name {
        font-size: 14px;
        font-weight: 600;
        color: #1F2937;
        margin-bottom: 4px;
        line-height: 1.3;
    }
    
    .my-profile-details {
        font-size: 12px;
        color: #6B7280;
        margin-bottom: 6px;
        line-height: 1.3;
    }
    
    .my-profile-bio {
        font-size: 12px;
        color: #6B7280;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .my-profile-actions {
        flex-shrink: 0;
        margin-left: auto;
    }
    
    .my-profile-edit-btn {
        background: linear-gradient(135deg, #FF9F7C, #FF7B54);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(255, 159, 124, 0.3);
    }
    
    .my-profile-edit-btn:hover {
        background: linear-gradient(135deg, #FF7B54, #FF9F7C);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 159, 124, 0.4);
    }

    /* ë°˜ì‘í˜• */
        @media(max-width: 900px){ 
            .chat-layout{ 
                grid-template-columns: 1fr; 
                padding: 16px;
            } 
        
        .matching-grid {
            grid-template-columns: 1fr;
        }
        
        .sidebar-column {
            gap: 12px;
            position: static;
            top: auto;
        }
        
        .sidebar-card-header {
            padding: 16px 16px 10px;
        }
        
        .sidebar-card-body {
            padding: 12px 16px 16px;
        }
        
        .my-profile-avatar {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }
        
        .my-profile-name {
            font-size: 13px;
        }
        
        .my-profile-details,
        .my-profile-bio {
            font-size: 11px;
        }
        
        .my-profile-edit-btn {
            padding: 4px 8px;
            font-size: 11px;
        }
    }
    
    /* ë‚˜ê°„ ì±„íŒ…ë°©ì€ ëª©ë¡ì—ì„œ ì™„ì „íˆ ì œê±°ë˜ë¯€ë¡œ ìŠ¤íƒ€ì¼ ë¶ˆí•„ìš” */

    /* í†µì¼ëœ Footer ìŠ¤íƒ€ì¼ */
    footer {
        border-top: 1px solid rgba(255, 200, 178, 0.5);
        margin-top: 0;
        padding: 0;
    }
    
    footer > div {
        max-width: 72rem;
        margin: 0 auto;
        padding: 1.5rem 1rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
        color: #6B7280;
        text-align: center;
        }
    </style>
</head>
<body class="bg-cream">
  <div class="top-grad h-[160px] w-full absolute inset-0 -z-10 pointer-events-none"></div>

  <header class="fixed top-0 left-0 right-0 z-50 border-b border-peach/40 glass">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4">
      <a href="{{ url_for('index') }}" class="flex items-center gap-2 font-extrabold text-lg">
        <img src="{{ url_for("static", filename="images/logo.png") }}" alt="KBU hub" class="w-9 h-9 rounded-full shadow-[0_8px_18px_rgba(255,159,128,.25)]">
        <span>hub</span>
      </a>
      <nav class="ml-auto hidden md:flex">
        <div id="navPill" class="nav-pill">
          <!-- ë„¤ë¹„ê²Œì´ì…˜ ì•„ì´í…œì€ navigation.jsì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
        </div>
      </nav>
      <button id="menuBtn" class="md:hidden ml-auto p-2 rounded-full border border-peach/60">â˜°</button>
    </div>
    <div id="mobileNav" class="hidden md:hidden px-4 pb-3 border-t border-peach/40 bg-white/70">
      <div class="flex flex-col gap-1 py-2 text-sm">
        <!-- ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ ì•„ì´í…œì€ navigation.jsì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
      </div>
    </div>
  </header>

  <main class="chat-layout" style="margin-top: 80px;">
    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
    <div class="sidebar-column">
      <!-- ì±„íŒ…ë°© ëª©ë¡ ì¹´ë“œ -->
      <div class="sidebar-card">
        <div class="sidebar-card-header">
          <h2 class="sidebar-card-title">ì±„íŒ…ë°© ëª©ë¡</h2>
        </div>
        <div class="sidebar-card-body">
          <div class="sidebar-section">
            <div class="sidebar-title">1:1</div>
            <ul class="room-list" id="dmList">
              <!-- 1:1 ì±„íŒ…ë°© ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </ul>
        </div>
        
          <div class="sidebar-section">
            <div class="sidebar-title">ê·¸ë£¹</div>
            <ul class="room-list" id="groupList">
              <!-- ê·¸ë£¹ ì±„íŒ…ë°© ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </ul>
                            </div>
                            
          <div class="sidebar-section">
            <div class="sidebar-title">ê´€ì‹¬ ë¶„ì•¼</div>
            <ul class="room-list" id="interestList">
              <!-- ê´€ì‹¬ì‚¬ ê¸°ë°˜ ì±„íŒ…ë°©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </ul>
                                </div>
                            </div>
                        </div>

      <!-- ë§ˆì´í”„ë¡œí•„ ì¹´ë“œ -->
      <div class="sidebar-card">
        <div class="sidebar-card-header">
          <h2 class="sidebar-card-title">ë§ˆì´í”„ë¡œí•„</h2>
                                </div>
        <div class="sidebar-card-body">
          <div class="profile-card">
            <div class="profile-avatar" id="myProfileAvatar"></div>
            <div class="profile-info">
              <div class="profile-name" id="myProfileName"></div>
              <div class="profile-details" id="myProfileDetails"></div>
              <div class="profile-bio" id="myProfileBio"></div>
            </div>
            <button class="btn btn-sm btn-outline" onclick="location.href='/mypage'">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1">
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              </svg>
              ìˆ˜ì •
            </button>
          </div>
        </div>
                        </div>
                        </div>

    <!-- ì˜¤ë¥¸ìª½ ë©”ì¸ ì˜ì—­ -->
    <section class="panel main-panel">
      <div class="panel-header">
        <div class="header-content">
          <div class="header-left">
            <span id="chatHeader">ëœë¤ ë§¤ì¹­</span>
            <span id="participantCount" class="participant-count-header" style="display:none;"></span>
                                </div>
          <div class="header-right">
            <button id="chatOptions" class="btn-options" style="display:none;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="1"/>
                <circle cx="19" cy="12" r="1"/>
                <circle cx="5" cy="12" r="1"/>
              </svg>
                                </button>
            <button id="backToHome" class="btn-home" style="display:none;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              í™ˆìœ¼ë¡œ
                                </button>
                                </div>
                            </div>
                        </div>

      <!-- ì±„íŒ… ì˜µì…˜ ë“œë¡­ë‹¤ìš´ -->
      <div id="chatOptionsDropdown" class="chat-options-dropdown" style="display:none;">
        <div class="dropdown-header">ì±„íŒ… ì˜µì…˜</div>
        <div class="dropdown-item" onclick="showParticipants()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          ì°¸ì—¬ì ë³´ê¸°
                        </div>
        <div class="dropdown-divider"></div>
        <div class="dropdown-item danger" onclick="leaveChatRoom()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16,17 21,12 16,7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
          ì±„íŒ…ë°© ë‚˜ê°€ê¸°
                            </div>
                </div>
                
      <!-- ì°¸ì—¬ì ë³´ê¸° ëª¨ë‹¬ -->
      <div id="participantsModal" class="modal" style="display:none;">
        <div class="modal-content">
          <div class="modal-header">
            <h3>ì°¸ì—¬ì ëª©ë¡</h3>
            <button class="modal-close" onclick="closeParticipantsModal()">&times;</button>
                                </div>
          <div class="modal-body">
            <div id="participantsList" class="participants-list">
              <!-- ì°¸ì—¬ì ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            </div>
                        </div>
                            </div>
            </div>
        
      <!-- ì°¸ì—¬ì í”„ë¡œí•„ ëª¨ë‹¬ -->
      <div id="participantProfileModal" class="modal" style="display:none;">
        <div class="modal-content">
          <div class="modal-header">
            <h3>ì°¸ì—¬ì í”„ë¡œí•„</h3>
            <button class="modal-close" onclick="closeParticipantProfileModal()">&times;</button>
                </div>
          <div class="modal-body">
            <div id="participantProfileContent" class="participant-profile">
              <!-- ì°¸ì—¬ì í”„ë¡œí•„ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
          </div>
                        </div>
                        </div>

      <!-- í”„ë¡œí•„ ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ -->
      <div id="profileDetailModal" class="modal" style="display:none;">
        <div class="modal-content">
          <div class="modal-header">
            <h3>í”„ë¡œí•„ ìƒì„¸</h3>
            <button class="modal-close" onclick="closeProfileDetailModal()">&times;</button>
                                            </div>
          <div class="modal-body">
            <div id="profileDetailContent" class="profile-detail-content">
              <!-- í”„ë¡œí•„ ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                                <div class="panel-body">
        <!-- ê¸°ë³¸ í™”ë©´: í”„ë¡œí•„ + ë§¤ì¹­ ì˜µì…˜ -->
                    <div id="chatContent">

          <!-- ëœë¤ ë§¤ì¹­ í”„ë¡œí•„ ì„¹ì…˜ -->
          <div class="random-matching-section">
            <div class="section-header">
              <span class="section-title">âœ¨ ëœë¤ ë§¤ì¹­ í”„ë¡œí•„</span>
                                            </div>
            <div class="profile-carousel">
              <button class="carousel-btn prev-btn" onclick="scrollProfiles(-1)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15,18 9,12 15,6"/>
                </svg>
              </button>
              <div class="profile-cards-container" id="profileCardsContainer">
                <!-- í”„ë¡œí•„ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                                        </div>
              <button class="carousel-btn next-btn" onclick="scrollProfiles(1)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9,18 15,12 9,6"/>
                </svg>
              </button>
                                    </div>
                                </div>

          <!-- ë§¤ì¹­ ì˜µì…˜ -->
          <div class="matching-grid">
            <div class="matching-card">
              <div class="matching-icon">ğŸ’¬</div>
              <div class="matching-title">ëœë¤ 1:1 ëŒ€í™”</div>
              <div class="matching-desc">ìµëª…ìœ¼ë¡œ í•œ ëª…ê³¼ ì—°ê²°ë©ë‹ˆë‹¤.</div>
              <button id="startRandom" class="btn btn-primary">1:1 ë§¤ì¹­ ì‹œì‘</button>
              <div id="randomMatchingStatus" class="matching-status">
                                                <div class="matching-spinner"></div>
                <div class="matching-text">ë§¤ì¹­ ì¤‘...</div>
                <div class="matching-timer" id="randomTimer">00:00:00</div>
                <button id="cancelRandom" class="btn btn-secondary">ë§¤ì¹­ ì·¨ì†Œ</button>
                                    </div>
                                        </div>
            
            <div class="matching-card">
              <div class="matching-icon">ğŸ‘¥</div>
              <div class="matching-title">ëœë¤ ê·¸ë£¹ ëŒ€í™”</div>
              <div class="matching-desc">3-6ëª…ì´ ëœë¤ìœ¼ë¡œ ëª¨ì—¬ ëŒ€í™”í•©ë‹ˆë‹¤.</div>
              <button id="startGroup" class="btn btn-primary">ê·¸ë£¹ ë§¤ì¹­ ì‹œì‘</button>
              <div id="groupMatchingStatus" class="matching-status">
                                                <div class="matching-spinner"></div>
                <div class="matching-text">ë§¤ì¹­ ì¤‘...</div>
                <div class="matching-timer" id="groupTimer">00:00:00</div>
                <button id="cancelGroup" class="btn btn-secondary">ë§¤ì¹­ ì·¨ì†Œ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
        <!-- ì±„íŒ… í™”ë©´ -->
                    <div id="chatRoom" style="display:none;">
                        <div class="messages" id="messages">
            <!-- ì±„íŒ… ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                        <div class="composer">
                            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                            <button id="sendButton" class="btn btn-primary">ì „ì†¡</button>
                        </div>
                    </div>
                </div>
            </section>
    </main>

  <footer>
    <div>
      Â© <span id="year"></span> KBU hub Â· All rights reserved.
        </div>
    </footer>

    <script>
    // ìµëª… í”„ë¡œí•„ ë¡œë“œ
    async function loadAnonProfile() {
      try {
        // ì„œë²„ì—ì„œ ìµœì‹  ìµëª… í”„ë¡œí•„ ê°€ì ¸ì˜¤ê¸°
        const response = await fetch('/api/anon-profile');
        const result = await response.json();

        let profile = null;

        if (result.success && result.profile) {
          // ì„œë²„ì—ì„œ ë°›ì€ í”„ë¡œí•„ì„ localStorageì— ì €ì¥
          localStorage.setItem('anonProfile', JSON.stringify(result.profile));
          profile = result.profile;
          console.log('[ìµëª…ì¹´ë“œ ë¡œë“œ] ì„œë²„ì—ì„œ ìµœì‹  í”„ë¡œí•„ ê°€ì ¸ì˜´:', profile);
        } else {
          // ì„œë²„ì— ì—†ìœ¼ë©´ localStorageì—ì„œ ê°€ì ¸ì˜¤ê¸°
          profile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
          console.log('[ìµëª…ì¹´ë“œ ë¡œë“œ] localStorageì—ì„œ í”„ë¡œí•„ ê°€ì ¸ì˜´:', profile);
        }

        if (profile) {
          // ë§ˆì´í”„ë¡œí•„ ì¹´ë“œ ì—…ë°ì´íŠ¸
          const myProfileAvatar = document.getElementById('myProfileAvatar');
          if (myProfileAvatar) {
            myProfileAvatar.textContent = profile.avatar || profile.nickname[0] || 'ìµ';
          }
          document.getElementById('myProfileName').textContent = profile.nickname || 'ìµëª…ì˜ì¹œêµ¬';
          document.getElementById('myProfileDetails').textContent = `${profile.year} Â· ${profile.gender}`;
          document.getElementById('myProfileBio').textContent = profile.bio || 'ìƒˆë¡œìš´ ì¹œêµ¬ë¥¼ ë§Œë‚˜ê³  ì‹¶ì–´ìš”!';

          // ê´€ì‹¬ì‚¬ ëª©ë¡ ì—…ë°ì´íŠ¸
          updateInterestList(profile.interests || []);

          // ë§¤ì¹­ ë²„íŠ¼ í™œì„±í™”
          document.getElementById('startRandom').textContent = '1:1 ë§¤ì¹­ ì‹œì‘';
          document.getElementById('startGroup').textContent = 'ê·¸ë£¹ ë§¤ì¹­ ì‹œì‘';
        } else { 
          // ê¸°ë³¸ê°’ ì„¤ì •
          document.getElementById('myProfileName').textContent = 'ìµëª… í”„ë¡œí•„';
          document.getElementById('myProfileDetails').textContent = 'í”„ë¡œí•„ ë¯¸ì„¤ì •';
          document.getElementById('myProfileBio').textContent = 'ìµëª…ì¹´ë“œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.';

          // ê´€ì‹¬ì‚¬ ëª©ë¡ ì—…ë°ì´íŠ¸
          updateInterestList([]);

          // ë§¤ì¹­ ë²„íŠ¼ í™œì„±í™”
          document.getElementById('startRandom').textContent = '1:1 ë§¤ì¹­ ì‹œì‘';
          document.getElementById('startGroup').textContent = 'ê·¸ë£¹ ë§¤ì¹­ ì‹œì‘';
        }
      } catch (e) {
        console.error('í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', e);
        // ê¸°ë³¸ê°’ ì„¤ì •
        document.getElementById('myProfileName').textContent = 'ìµëª… í”„ë¡œí•„';
        document.getElementById('myProfileDetails').textContent = 'í”„ë¡œí•„ ë¯¸ì„¤ì •';
        document.getElementById('myProfileBio').textContent = 'ìµëª…ì¹´ë“œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.';
      }
    }

    // ì„œë²„ì—ì„œ ê´€ì‹¬ì‚¬ë³„ ì°¸ì—¬ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
    async function loadInterestCounts() {
      try {
        const response = await fetch("{{ url_for('get_interest_counts') }}");
        const result = await response.json();
        
        if (result.success && result.interest_counts) {
          // roomParticipants ì—…ë°ì´íŠ¸
          Object.keys(result.interest_counts).forEach(interest => {
            if (!roomParticipants[interest]) {
              roomParticipants[interest] = {
                count: 0,
                users: [],
                unreadCount: 0
              };
            }
            roomParticipants[interest].count = result.interest_counts[interest];
            
            // ë‹‰ë„¤ì„ ëª©ë¡ë„ ì—…ë°ì´íŠ¸
            if (result.interest_users && result.interest_users[interest]) {
              roomParticipants[interest].users = result.interest_users[interest];
            }
          });
          
          // UI ì—…ë°ì´íŠ¸ (í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ê´€ì‹¬ì‚¬ ëª©ë¡ ë‹¤ì‹œ ë Œë”ë§)
          const profile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
          if (profile && profile.interests) {
            updateInterestList(profile.interests);
          }
        }
      } catch (error) {
        console.error('ê´€ì‹¬ì‚¬ ì¹´ìš´íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }
    
    // ê´€ì‹¬ì‚¬ ëª©ë¡ ì—…ë°ì´íŠ¸
    function updateInterestList(interests) {
      const interestList = document.getElementById('interestList');
      
      // ê´€ì‹¬ë¶„ì•¼ ëª©ë¡ ì´ˆê¸°í™”
      interestList.innerHTML = '';
      
      if (interests.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'ì„ íƒí•œ ê´€ì‹¬ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.';
        li.style.color = '#999';
        li.style.cursor = 'default';
        interestList.appendChild(li);
        return;
      }
            
      // ê´€ì‹¬ì‚¬ë³„ ì´ëª¨ì§€ ë§¤í•‘
      const interestEmojis = {
        'ì˜í™”': 'ğŸ¬',
        'ìš´ë™': 'ğŸ’ª',
        'ê²Œì„': 'ğŸ®',
        'ìŒì•…': 'ğŸµ',
        'ì¹´í˜': 'â˜•',
        'ì—¬í–‰': 'âœˆï¸',
        'ìŠ¤í„°ë””': 'ğŸ“š',
        'ë…ì„œ': 'ğŸ“–',
        'ë§›ì§‘': 'ğŸ½ï¸'
      };
      
      // ë‚˜ê°„ ì±„íŒ…ë°© ëª©ë¡ í™•ì¸
      const leftRooms = JSON.parse(localStorage.getItem('leftRooms') || '[]');
      
      interests.forEach(interest => {
        // ë‚˜ê°„ ì±„íŒ…ë°©ì¸ì§€ í™•ì¸ (ì œì™¸í•˜ì§€ ì•Šê³  í‘œì‹œ)
        const isLeftRoom = leftRooms.includes(interest);
        if (isLeftRoom) {
          console.log(`[ê´€ì‹¬ë¶„ì•¼ ëª©ë¡] ${interest}ëŠ” ë‚˜ê°„ ë°©ì´ì§€ë§Œ ëª©ë¡ì— í‘œì‹œ (ì¬ì…ì¥ ê°€ëŠ¥)`);
        }
        
        const li = document.createElement('li');
        const emoji = interestEmojis[interest] || 'ğŸ¯';
        const participantCount = roomParticipants[interest]?.count || 0;
        
        // ë‚˜ê°„ ë°©ì¸ ê²½ìš° ì‹œê°ì ìœ¼ë¡œ êµ¬ë¶„
        if (isLeftRoom) {
            li.style.opacity = '0.6';
            li.style.borderLeft = '3px solid #ff6b6b';
        }
        
        // ê´€ì‹¬ë¶„ì•¼ í•­ëª© HTML êµ¬ì¡° (ì±„íŒ…ë°© ëª©ë¡ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼)
        li.innerHTML = `
            <div class="room-info">
                <div class="room-name-wrapper">
                    <span class="room-name">${emoji} ${interest}</span>
                    ${isLeftRoom ? '<span style="color: #ff6b6b; font-size: 12px; margin-left: 5px;">(ë‚˜ê°„ ë°©)</span>' : ''}
                </div>
                <span class="participant-count">${participantCount}ëª…</span>
            </div>
        `;
        
        // í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        li.addEventListener('click', () => {
            // ë‚˜ê°„ ë°©ì¸ ê²½ìš° leftRoomsì—ì„œ ì œê±° (ì¬ì…ì¥ í—ˆìš©)
            if (isLeftRoom) {
                let leftRooms = JSON.parse(localStorage.getItem('leftRooms') || '[]');
                const roomIndex = leftRooms.indexOf(interest);
                if (roomIndex > -1) {
                    leftRooms.splice(roomIndex, 1);
                    localStorage.setItem('leftRooms', JSON.stringify(leftRooms));
                    console.log(`[ì¬ì…ì¥] ${interest} ë°©ì„ ë‚˜ê°„ ë°© ëª©ë¡ì—ì„œ ì œê±°`);
                    
                    // UIì—ì„œ "(ë‚˜ê°„ ë°©)" í‘œì‹œ ì œê±°
                    li.style.opacity = '1';
                    li.style.borderLeft = 'none';
                    const leftRoomSpan = li.querySelector('span[style*="color: #ff6b6b"]');
                    if (leftRoomSpan) {
                        leftRoomSpan.remove();
                    }
                }
            }
            
            // ê´€ì‹¬ì‚¬ ë°© ì…ì¥ ì‹œ ì±„íŒ…ë°© ëª©ë¡ì— ì¶”ê°€
            const added = addInterestRoom(interest);
            if (added) {
                enterRoom(interest);
            } else {
                console.error(`[ì…ì¥ ì‹¤íŒ¨] ${interest} ë°© ì¶”ê°€ ì‹¤íŒ¨`);
            }
            
            // ëª¨ë“  ì±„íŒ…ë°© ëª©ë¡ì—ì„œ active í´ë˜ìŠ¤ ì œê±° í›„ í˜„ì¬ ë°©ì— ì¶”ê°€
            document.querySelectorAll('.room-list li, #dmList li, #interestList li').forEach(item => {
                item.classList.remove('active');
            });
            li.classList.add('active');
        });
        
        interestList.appendChild(li);
      });
      
      // í‘œì‹œëœ ê´€ì‹¬ì‚¬ ê°œìˆ˜ ê³„ì‚° (ëª¨ë“  ê´€ì‹¬ì‚¬ í‘œì‹œ)
      const displayedCount = interestList.children.length;
      const leftCount = leftRooms.filter(room => interests.includes(room)).length;
      console.log(`[ê´€ì‹¬ë¶„ì•¼ ëª©ë¡] ì „ì²´ ${interests.length}ê°œ í‘œì‹œ (${leftCount}ê°œëŠ” ë‚˜ê°„ ë°©, ì¬ì…ì¥ ê°€ëŠ¥)`);
    }

    // ê´€ì‹¬ì‚¬ ë°©ì„ ì±„íŒ…ë°© ëª©ë¡ì— ì¶”ê°€
    function addInterestRoom(interest) {
        // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°©ì¸ì§€ í™•ì¸
        const existingRoom = chatData.roomList.find(room => room.name === interest);
        if (existingRoom) {
            console.log(`[ì±„íŒ…ë°© ì¶”ê°€] ${interest} ë°©ì€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤`);
            return true;
        }
        
        // roomParticipants ì´ˆê¸°í™” (ì—†ìœ¼ë©´)
        if (!roomParticipants[interest]) {
            roomParticipants[interest] = {
                count: 0,
                users: [],
                unreadCount: 0
            };
        }
        
        // ì±„íŒ…ë°© ë°ì´í„°ì— ì¶”ê°€
        if (!chatData.rooms[interest]) {
            chatData.rooms[interest] = [];
        }
        
        // ì±„íŒ…ë°© ëª©ë¡ì— ì¶”ê°€
        chatData.roomList.push({
            name: interest,
            type: 'interest',
            unreadCount: 0,
            participantCount: roomParticipants[interest].count,
            createdAt: new Date().toISOString()
        });
        
        console.log(`[ì±„íŒ…ë°© ì¶”ê°€] ${interest} ë°©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ (ì´ ${chatData.roomList.length}ê°œ)`);
        saveChatData();
        updateRoomListUI();
        return true;
    }

    // ê´€ì‹¬ë¶„ì•¼ ë°© ì°¸ì—¬ì ìˆ˜ ì¦ê°€ (ì œê±° - ì„œë²„ì—ì„œ ì‹¤ì œ ìˆ˜ë¥¼ ê°€ì ¸ì˜´)
    async function incrementParticipantCount(interest) {
        // ì„œë²„ì—ì„œ ìµœì‹  ì°¸ì—¬ì ìˆ˜ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì˜´
        await loadInterestCounts();
    }

    // ê´€ì‹¬ë¶„ì•¼ ëª©ë¡ UI ì—…ë°ì´íŠ¸
    function updateInterestListUI(interest) {
        const interestList = document.getElementById('interestList');
        const listItems = interestList.querySelectorAll('li');
        
        listItems.forEach(li => {
            const roomNameSpan = li.querySelector('.room-name');
            if (roomNameSpan && roomNameSpan.textContent.includes(interest)) {
                const participantCountSpan = li.querySelector('.participant-count');
                if (participantCountSpan) {
                    const currentCount = roomParticipants[interest]?.count || 0;
                    participantCountSpan.textContent = `${currentCount}ëª…`;
                }
            }
        });
    }

    // ê¸°ë³¸ ê´€ì‹¬ë¶„ì•¼ ë°©ë“¤ì„ ì´ˆê¸°í™”
    function initializeDefaultInterestRooms() {
        // ê¸°ë³¸ ê´€ì‹¬ë¶„ì•¼ ë°© ì´ˆê¸°í™” ì•ˆí•¨ (ì‚¬ìš©ìê°€ ì§ì ‘ ì°¸ì—¬)
    }


    // ë§¤ì¹­ ê´€ë ¨ ë³€ìˆ˜
        let randomMatching = false;
        let groupMatching = false;
        let randomStartTime = null;
        let groupStartTime = null;
        let randomTimer = null;
        let groupTimer = null;
        
        // ê·¸ë£¹ ë§¤ì¹­ ëŒ€ê¸°ì—´ (ì „ì—­)
        let groupMatchingQueue = {
            male: [], // ë‚¨ì ëŒ€ê¸°ì ëª©ë¡
            female: [], // ì—¬ì ëŒ€ê¸°ì ëª©ë¡
            groups: [] // ì™„ì„±ëœ ê·¸ë£¹ ëª©ë¡
        };
        
        // ì±„íŒ… ë°ì´í„° ì €ì¥ì†Œ (ì „ì—­)
        let chatData = {
            rooms: {}, // ì±„íŒ…ë°©ë³„ ë©”ì‹œì§€ ì €ì¥
            roomList: [] // ì±„íŒ…ë°© ëª©ë¡
        };

    // íƒ€ì´ë¨¸ í¬ë§·íŒ…
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // ì±„íŒ… ë°ì´í„° ì €ì¥
        function saveChatData() {
            try {
                // ì €ì¥ë§Œ ìˆ˜í–‰ (í•„í„°ë§ì€ loadChatDataì™€ leaveChatRoomì—ì„œë§Œ)
                localStorage.setItem('chatData', JSON.stringify(chatData));
                console.log(`[ì €ì¥] ${chatData.roomList.length}ê°œ ì±„íŒ…ë°© ì €ì¥`);
            } catch (e) {
                console.error('ì±„íŒ… ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', e);
            }
        }

        // ì±„íŒ… ë°ì´í„° ë¡œë“œ
        function loadChatData() {
            try {
                const saved = localStorage.getItem('chatData');
                if (saved) {
                    chatData = JSON.parse(saved);
                    
                    // ë‚˜ê°„ ì±„íŒ…ë°© ëª©ë¡ í•„í„°ë§
                    const leftRooms = JSON.parse(localStorage.getItem('leftRooms') || '[]');
                    if (leftRooms.length > 0) {
                        // ë‚˜ê°„ ë°© ëª©ë¡ì—ì„œ ì œê±°
                        chatData.roomList = chatData.roomList.filter(room => !leftRooms.includes(room.name));
                        console.log(`[ë¡œë“œ] ${leftRooms.length}ê°œì˜ ë‚˜ê°„ ì±„íŒ…ë°© í•„í„°ë§ ì™„ë£Œ`);
                        
                        // í•„í„°ë§ëœ ë°ì´í„° ì €ì¥
                        saveChatData();
                    }
                }
            } catch (e) {
                console.error('ì±„íŒ… ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
                chatData = { rooms: {}, roomList: [] };
            }
        }

        // ì±„íŒ…ë°© ëª©ë¡ UI ì—…ë°ì´íŠ¸
        function updateRoomListUI() {
            // ë‚˜ê°„ ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
            const leftRooms = JSON.parse(localStorage.getItem('leftRooms') || '[]');
            
            // 1:1 ì±„íŒ…ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
            const dmList = document.getElementById('dmList');
            dmList.innerHTML = '';
            
            // ê·¸ë£¹ ì±„íŒ…ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
            const groupList = document.getElementById('groupList');
            groupList.innerHTML = '';
            
            // ê´€ì‹¬ë¶„ì•¼ ì±„íŒ…ë°© ëª©ë¡ì€ updateInterestListì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ
            // const interestList = document.getElementById('interestList');
            // interestList.innerHTML = '';
            
            let displayCount = 0;
            let skipCount = 0;
            
            // ë‚˜ê°„ ë°©ì„ ì œì™¸í•˜ê³  ì±„íŒ…ë°© ëª©ë¡ ë Œë”ë§
            chatData.roomList.forEach(room => {
                // ë‚˜ê°„ ë°©ì€ ìŠ¤í‚µ
                if (leftRooms.includes(room.name)) {
                    console.log(`[UI ìŠ¤í‚µ] ${room.name}ì€ ë‚˜ê°„ ë°©`);
                    skipCount++;
                    return;
                }
                
                if (room.type === 'dm') {
                    createRoomListItem('dmList', room.name, room.unreadCount || 0);
                    displayCount++;
                } else if (room.type === 'group') {
                    createRoomListItem('groupList', room.name, room.unreadCount || 0, room.participantCount || 0);
                    displayCount++;
                } else if (room.type === 'interest') {
                    // ê´€ì‹¬ë¶„ì•¼ ë°©ì€ ë³„ë„ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ (updateInterestListì—ì„œ ì²˜ë¦¬)
                    console.log(`[UI ìŠ¤í‚µ] ${room.name} ê´€ì‹¬ë¶„ì•¼ ë°©ì€ ë³„ë„ ì²˜ë¦¬`);
                }
            });
            
            console.log(`[UI ì—…ë°ì´íŠ¸] ì „ì²´ ${chatData.roomList.length}ê°œ ì¤‘ ${displayCount}ê°œ í‘œì‹œ, ${skipCount}ê°œ ìŠ¤í‚µ`);
        }

        // ì±„íŒ…ë°© ëª©ë¡ ì•„ì´í…œ ìƒì„±
        function createRoomListItem(listId, roomName, unreadCount = 0, participantCount = 0) {
            const list = document.getElementById(listId);
            const li = document.createElement('li');
            const isGroupChat = listId === 'groupList' || listId === 'interestList';
            const isInterestRoom = listId === 'interestList';
            
            // ê´€ì‹¬ë¶„ì•¼ ë°©ì¸ ê²½ìš° ì‹¤ì œ ì°¸ì—¬ì ìˆ˜ ì‚¬ìš©
            if (isInterestRoom && roomParticipants[roomName]) {
                participantCount = roomParticipants[roomName].count;
            }
            
            // ê´€ì‹¬ë¶„ì•¼ ë°©ì¸ ê²½ìš° ì´ëª¨ì§€ ì¶”ê°€
            let displayName = roomName;
            if (isInterestRoom) {
                const interestEmojis = {
                    'ìš´ë™': 'ğŸ’ª',
                    'ê²Œì„': 'ğŸ®',
                    'ìŒì•…': 'ğŸµ',
                    'ì˜í™”': 'ğŸ¬',
                    'ì¹´í˜': 'â˜•',
                    'ì—¬í–‰': 'âœˆï¸',
                    'ìŠ¤í„°ë””': 'ğŸ“š',
                    'ë…ì„œ': 'ğŸ“–',
                    'ë§›ì§‘': 'ğŸ½ï¸'
                };
                const emoji = interestEmojis[roomName] || 'ğŸ¯';
                displayName = `${emoji} ${roomName}`;
            }
            
            li.innerHTML = `
                <div class="room-info">
                    <div class="room-name-wrapper">
                        <span class="room-name">${displayName}</span>
                        ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                    </div>
                    ${isGroupChat ? `<span class="participant-count">${participantCount}ëª…</span>` : ''}
                </div>
            `;
            li.addEventListener('click', () => {
                enterRoom(roomName);
                
                // ëª¨ë“  ì±„íŒ…ë°© ëª©ë¡ì—ì„œ active í´ë˜ìŠ¤ ì œê±° í›„ í˜„ì¬ ë°©ì— ì¶”ê°€
                document.querySelectorAll('.room-list li, #dmList li, #interestList li').forEach(item => {
                    item.classList.remove('active');
                });
                li.classList.add('active');
            });
            list.appendChild(li);
        }

        // 1:1 ë§¤ì¹­ ì‹œì‘
        async function startRandomMatching() {
            // í”„ë¡œí•„ ì²´í¬
            if (!checkAnonProfile()) {
                return;
            }
            
            randomMatching = true;
            randomStartTime = Date.now();
            document.getElementById('startRandom').style.display = 'none';
            document.getElementById('randomMatchingStatus').style.display = 'block';
            
            randomTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - randomStartTime) / 1000);
                document.getElementById('randomTimer').textContent = formatTime(elapsed);
            }, 1000);

            try {
                // ì„œë²„ì— ë§¤ì¹­ ìš”ì²­
                const response = await fetch('/api/matching/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.matched && result.match_data) {
                        // ì¦‰ì‹œ ë§¤ì¹­ ì„±ê³µ
                        clearInterval(randomTimer);
                        randomMatching = false;
                        document.getElementById('startRandom').style.display = 'block';
                        document.getElementById('randomMatchingStatus').style.display = 'none';
                        
                        // ë§¤ì¹­ëœ ë°©ì„ ì±„íŒ…ë°© ëª©ë¡ì— ì¶”ê°€
                        await handleMatchedRoom(result.match_data);
                        
                        alert('1:1 ë§¤ì¹­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } else {
                        // ë§¤ì¹­ ëŒ€ê¸° ì¤‘ - ì£¼ê¸°ì ìœ¼ë¡œ ë§¤ì¹­ ìƒíƒœ í™•ì¸
                        checkMatchingStatus();
                    }
                } else {
                    // ë§¤ì¹­ ì‹¤íŒ¨ - ê¸°ì¡´ ë°©ì´ ìˆëŠ” ê²½ìš° ì²˜ë¦¬
                    if (result.existing_room) {
                        clearInterval(randomTimer);
                        randomMatching = false;
                        document.getElementById('startRandom').style.display = 'block';
                        document.getElementById('randomMatchingStatus').style.display = 'none';
                        
                        // ê¸°ì¡´ ë°©ì„ ì±„íŒ…ë°© ëª©ë¡ì— ì¶”ê°€ (ì—†ëŠ” ê²½ìš°ì—ë§Œ)
                        const roomName = result.existing_room.other_nickname;
                        const existingRoom = chatData.roomList.find(room => room.name === roomName);
                        
                        if (!existingRoom) {
                            const newRoom = {
                                name: roomName,
                                type: 'dm',
                                roomId: result.existing_room.room_id,
                                unreadCount: 0,
                                createdAt: new Date().toISOString()
                            };
                            
                            chatData.roomList.push(newRoom);
                            
                            // roomParticipantsì— ì¶”ê°€
                            roomParticipants[roomName] = {
                                count: 2,
                                users: [roomName],
                                unreadCount: 0
                            };
                            
                            // ì±„íŒ…ë°© ë°ì´í„° ì´ˆê¸°í™”
                            if (!chatData.rooms[roomName]) {
                                chatData.rooms[roomName] = [];
                            }
                            
                            saveChatData();
                            updateRoomListUI();
                            
                            console.log(`[ê¸°ì¡´ ë°© ë³µì›] ${roomName}ê³¼ì˜ ê¸°ì¡´ ë°©ì„ ëª©ë¡ì— ì¶”ê°€`);
                        }
                        
                        alert(`${result.message}\nê¸°ì¡´ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”.`);
                    } else {
                        alert(result.message || 'ë§¤ì¹­ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        cancelMatching();
                    }
                }
            } catch (error) {
                console.error('ë§¤ì¹­ ìš”ì²­ ì‹¤íŒ¨:', error);
                alert('ë§¤ì¹­ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                cancelMatching();
            }
        }

        // ë§¤ì¹­ ìƒíƒœ í™•ì¸
        async function checkMatchingStatus() {
            if (!randomMatching) return;
            
            try {
                // ì„œë²„ì—ì„œ ì‚¬ìš©ìì˜ ë°© ëª©ë¡ í™•ì¸
                const response = await fetch('/api/rooms');
                const result = await response.json();
                
                if (result.success) {
                    // ìƒˆë¡œ ìƒì„±ëœ ë°©ì´ ìˆëŠ”ì§€ í™•ì¸
                    const currentRooms = chatData.roomList.filter(room => room.type === 'dm').map(room => room.name);
                    const serverRooms = result.rooms.filter(room => room.type === 'dm');
                    
                    for (const serverRoom of serverRooms) {
                        const roomExists = currentRooms.includes(serverRoom.room_name);
                        if (!roomExists) {
                            // ìƒˆë¡œìš´ ë§¤ì¹­ëœ ë°© ë°œê²¬
                            clearInterval(randomTimer);
                            randomMatching = false;
                            document.getElementById('startRandom').style.display = 'block';
                            document.getElementById('randomMatchingStatus').style.display = 'none';
                            
                            // ë°©ì„ ì±„íŒ…ë°© ëª©ë¡ì— ì¶”ê°€
                            await handleServerRoom(serverRoom);
                            
                            alert('1:1 ë§¤ì¹­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                            return;
                        }
                    }
                }
                
                // ë§¤ì¹­ì´ ì•„ì§ ì•ˆ ë˜ì—ˆìœ¼ë©´ 2ì´ˆ í›„ ë‹¤ì‹œ í™•ì¸
                setTimeout(checkMatchingStatus, 2000);
            } catch (error) {
                console.error('ë§¤ì¹­ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
                setTimeout(checkMatchingStatus, 2000);
            }
        }

        // ë§¤ì¹­ ì·¨ì†Œ
        async function cancelMatching() {
            randomMatching = false;
            clearInterval(randomTimer);
            document.getElementById('startRandom').style.display = 'block';
            document.getElementById('randomMatchingStatus').style.display = 'none';
            
            try {
                await fetch('/api/matching/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
            } catch (error) {
                console.error('ë§¤ì¹­ ì·¨ì†Œ ì‹¤íŒ¨:', error);
            }
        }

        // ë§¤ì¹­ëœ ë°© ì²˜ë¦¬
        async function handleMatchedRoom(matchData) {
            const roomId = matchData.room_id;
            const otherUser = matchData.user1.student_id === getCurrentStudentId() ? matchData.user2 : matchData.user1;
            
            // ì±„íŒ…ë°© ëª©ë¡ì— ì¶”ê°€
            const newRoom = {
                name: otherUser.nickname,
                type: 'dm',
                roomId: roomId,
                unreadCount: 0,
                createdAt: new Date().toISOString()
            };
            
            chatData.roomList.push(newRoom);
            
            // roomParticipantsì— ì¶”ê°€
            roomParticipants[otherUser.nickname] = {
                count: 2,
                users: [otherUser.nickname],
                unreadCount: 0
            };
            
            // ì±„íŒ…ë°© ë°ì´í„° ì´ˆê¸°í™”
            if (!chatData.rooms[otherUser.nickname]) {
                chatData.rooms[otherUser.nickname] = [];
            }
            
            saveChatData();
            updateRoomListUI();
            
            console.log(`[ë§¤ì¹­ ì™„ë£Œ] ${otherUser.nickname}ê³¼ ë§¤ì¹­ë¨ (ë°© ID: ${roomId})`);
        }

        // ì„œë²„ì—ì„œ ë°›ì€ ë°© ì •ë³´ ì²˜ë¦¬
        async function handleServerRoom(serverRoom) {
            const roomName = serverRoom.room_name;
            const roomId = serverRoom.room_id;
            
            // ì±„íŒ…ë°© ëª©ë¡ì— ì¶”ê°€
            const newRoom = {
                name: roomName,
                type: 'dm',
                roomId: roomId,
                unreadCount: 0,
                createdAt: serverRoom.created_at
            };
            
            chatData.roomList.push(newRoom);
            
            // roomParticipantsì— ì¶”ê°€
            roomParticipants[roomName] = {
                count: 2,
                users: [roomName],
                unreadCount: 0
            };
            
            // ì±„íŒ…ë°© ë°ì´í„° ì´ˆê¸°í™”
            if (!chatData.rooms[roomName]) {
                chatData.rooms[roomName] = [];
            }
            
            saveChatData();
            updateRoomListUI();
            
            console.log(`[ì„œë²„ ë§¤ì¹­] ${roomName}ê³¼ ë§¤ì¹­ë¨ (ë°© ID: ${roomId})`);
        }

        // í˜„ì¬ ì‚¬ìš©ìì˜ í•™ë²ˆ ê°€ì ¸ì˜¤ê¸°
        function getCurrentStudentId() {
            const currentUser = sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser');
            if (currentUser) {
                try {
                    const user = JSON.parse(currentUser);
                    return user.student_id;
                } catch (e) {
                    return null;
                }
            }
            return null;
        }

        // ê·¸ë£¹ ë§¤ì¹­ ì‹œì‘ (ì„œë²„ API ì‚¬ìš©)
        async function startGroupMatching() {
            // í”„ë¡œí•„ ì²´í¬
            if (!checkAnonProfile()) {
                return;
            }
            
            try {
                // ì„œë²„ì— ê·¸ë£¹ ë§¤ì¹­ ì‹œì‘ ìš”ì²­
                const response = await fetch('/api/group-matching/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    groupMatching = true;
                    groupStartTime = Date.now();
                    document.getElementById('startGroup').style.display = 'none';
                    document.getElementById('groupMatchingStatus').style.display = 'block';
                    
                    groupTimer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - groupStartTime) / 1000);
                        document.getElementById('groupTimer').textContent = formatTime(elapsed);
                        updateGroupMatchingStatus();
                    }, 1000);
                    
                    // ë§¤ì¹­ ì„±ê³µ ì‹œ ì¦‰ì‹œ ê·¸ë£¹ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™
                    if (result.matched && result.match_data) {
                        handleGroupMatchingSuccess(result.match_data);
                    }
                    
                    alert(result.message);
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('ê·¸ë£¹ ë§¤ì¹­ ì‹œì‘ ì‹¤íŒ¨:', error);
                alert('ê·¸ë£¹ ë§¤ì¹­ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // 1:1 ë§¤ì¹­ ì™„ë£Œ (ê¸°ì¡´ ë¡œì»¬ ë°©ì‹ - ì„œë²„ ë°©ì‹ìœ¼ë¡œ ëŒ€ì²´ë¨)
        // function completeRandomMatching(availableProfiles = null) {
        //     // ì´ í•¨ìˆ˜ëŠ” ì´ì œ ì„œë²„ ê¸°ë°˜ ë§¤ì¹­ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´ë¨
        //     // handleMatchedRoom() í•¨ìˆ˜ë¥¼ ì‚¬ìš©
        // }

        // ê·¸ë£¹ ë§¤ì¹­ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì„œë²„ì—ì„œ ëŒ€ê¸°ì—´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°)
        async function updateGroupMatchingStatus() {
            try {
                // ì„œë²„ì—ì„œ ê·¸ë£¹ ë§¤ì¹­ ëŒ€ê¸°ì—´ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì„ì‹œë¡œ ë¡œì»¬ ì •ë³´ ì‚¬ìš©)
                // TODO: ì„œë²„ API ì¶”ê°€ ì‹œ ì‹¤ì œ ì„œë²„ í˜¸ì¶œë¡œ ë³€ê²½
                const maleCount = groupMatchingQueue.male.length;
                const femaleCount = groupMatchingQueue.female.length;
                const totalCount = maleCount + femaleCount;
                
                const matchingText = document.querySelector('#groupMatchingStatus .matching-text');
                if (matchingText) {
                    if (totalCount < 3) {
                        matchingText.textContent = `ë§¤ì¹­ ì¤‘... (ëŒ€ê¸°ì: ë‚¨ì ${maleCount}ëª…, ì—¬ì ${femaleCount}ëª…)`;
                    } else {
                        matchingText.textContent = `ë¹„ìœ¨ ë§ì¶¤ ì¤‘... (ëŒ€ê¸°ì: ë‚¨ì ${maleCount}ëª…, ì—¬ì ${femaleCount}ëª…)`;
                    }
                }
            } catch (error) {
                console.error('ê·¸ë£¹ ë§¤ì¹­ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }

        // ê·¸ë£¹ ë§¤ì¹­ ì‹œë„ í•¨ìˆ˜ëŠ” ì´ì œ ì„œë²„ì—ì„œ ì²˜ë¦¬ë¨ (ë¡œì»¬ í•¨ìˆ˜ ì œê±°)

        // ê·¸ë£¹ ë§¤ì¹­ ì„±ê³µ ì²˜ë¦¬ (ì„œë²„ ì‘ë‹µ ì²˜ë¦¬)
        async function handleGroupMatchingSuccess(matchData) {
            groupMatching = false;
            clearInterval(groupTimer);
            document.getElementById('startGroup').style.display = 'block';
            document.getElementById('groupMatchingStatus').style.display = 'none';
            
            const roomId = matchData.room_id;
            const groupSize = matchData.group_size;
            const members = matchData.members;
            
            // ëª¨ë“  ë©¤ë²„ ì •ë³´ ìˆ˜ì§‘
            const allMembers = [...members.male, ...members.female];
            
            // ê·¸ë£¹ ëœë¤ ì±„íŒ…ìš© ì°¸ì—¬ì ì •ë³´ ìƒì„±
            const groupRoomName = `ê·¸ë£¹ ${roomId.split('_')[1]}`;
            roomParticipants[groupRoomName] = {
                count: groupSize,
                users: allMembers.map(member => member.nickname),
                unreadCount: 0,
                roomId: roomId
            };
            
            // ì±„íŒ…ë°© ë°ì´í„°ì— ì¶”ê°€
            if (!chatData.rooms[groupRoomName]) {
                chatData.rooms[groupRoomName] = [];
            }
            
            // ì±„íŒ…ë°© ëª©ë¡ì— ì¶”ê°€
            chatData.roomList.push({
                name: groupRoomName,
                type: 'group',
                unreadCount: 0,
                participantCount: groupSize,
                roomId: roomId,
                createdAt: new Date().toISOString()
            });
            
            saveChatData();
            updateRoomListUI();
            
            // ë‚¨ë…€ ë¹„ìœ¨ ì •ë³´ í‘œì‹œ
            const maleCount = members.male.length;
            const femaleCount = members.female.length;
            alert(`ê·¸ë£¹ ë§¤ì¹­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (${groupSize}ëª…, ë‚¨ì ${maleCount}ëª…, ì—¬ì ${femaleCount}ëª…)`);
            
            // ìë™ìœ¼ë¡œ ê·¸ë£¹ ì±„íŒ…ë°©ì— ì…ì¥
            setTimeout(() => {
                enterRoom(groupRoomName);
            }, 1000);
        }

        // ë§¤ì¹­ ì·¨ì†Œ
        function cancelRandomMatching() {
            randomMatching = false;
            clearInterval(randomTimer);
      document.getElementById('startRandom').style.display = 'block';
      document.getElementById('randomMatchingStatus').style.display = 'none';
        }

        // ê·¸ë£¹ ë§¤ì¹­ ì·¨ì†Œ (ì„œë²„ API ì‚¬ìš©)
        async function cancelGroupMatching() {
            try {
                const response = await fetch('/api/group-matching/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                groupMatching = false;
                clearInterval(groupTimer);
                document.getElementById('startGroup').style.display = 'block';
                document.getElementById('groupMatchingStatus').style.display = 'none';
                
                if (result.success) {
                    console.log(result.message);
                }
            } catch (error) {
                console.error('ê·¸ë£¹ ë§¤ì¹­ ì·¨ì†Œ ì‹¤íŒ¨:', error);
                // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ UIëŠ” ì´ˆê¸°í™”
                groupMatching = false;
                clearInterval(groupTimer);
                document.getElementById('startGroup').style.display = 'block';
                document.getElementById('groupMatchingStatus').style.display = 'none';
            }
        }

    // ì±„íŒ…ë°© ìƒì„±
    function createRoom(listId, roomName) {
      const list = document.getElementById(listId);
      const li = document.createElement('li');
      const participantCount = roomParticipants[roomName]?.count || 0;
      const unreadCount = roomParticipants[roomName]?.unreadCount || 0;
      
      // 1:1 ì±„íŒ…ì¸ì§€ ê·¸ë£¹ ì±„íŒ…ì¸ì§€ êµ¬ë¶„
      const isGroupChat = listId === 'roomList';
      
      li.innerHTML = `
        <div class="room-info">
          <div class="room-name-wrapper">
            <span class="room-name">${roomName}</span>
            ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
          </div>
          ${isGroupChat ? `<span class="participant-count">${participantCount}ëª…</span>` : ''}
        </div>
      `;
      li.addEventListener('click', () => enterRoom(roomName));
      list.appendChild(li);
    }

        // í˜„ì¬ í™œì„± ì±„íŒ…ë°©
        let currentRoom = null;
        
        // ëœë¤ ë§¤ì¹­ í”„ë¡œí•„ ë°ì´í„°
        const randomProfiles = [];
        
        // ì±„íŒ…ë°©ë³„ ì°¸ì—¬ì ì •ë³´ (ê´€ì‹¬ì‚¬ë³„ ê·¸ë£¹ ì±„íŒ… - ì¸ì›ìˆ˜ ì œí•œ ì—†ìŒ)
        const roomParticipants = {};

        // ì±„íŒ…ë°© ì…ì¥
        async function enterRoom(roomName) {
            console.log(`[ì…ì¥] ${roomName} ë°©ì— ì…ì¥ ì‹œë„`);
            
            // ë‚˜ê°„ ë°©ì€ ì´ë¯¸ ëª©ë¡ì—ì„œ ì œì™¸ë˜ë¯€ë¡œ ì²´í¬ ë¶ˆí•„ìš”
            
            currentRoom = roomName;
            document.getElementById('chatHeader').textContent = roomName;
            document.getElementById('chatContent').style.display = 'none';
            document.getElementById('chatRoom').style.display = 'block';
            
            // ë°© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const roomData = chatData.roomList.find(room => room.name === roomName);
            
            // 1:1 ì±„íŒ…ë°©ì¸ ê²½ìš° ì„œë²„ì—ì„œ ë©”ì‹œì§€ ë¡œë“œ, ê·¸ ì™¸ì—ëŠ” ë¡œì»¬ì—ì„œ ë¡œë“œ
            if (roomData && roomData.type === 'dm') {
                // 1:1 ì±„íŒ…ë°©: ì„œë²„ì—ì„œ ë©”ì‹œì§€ ë¡œë“œ
                await loadRoomMessages(roomName);
                
                // ë©”ì‹œì§€ í´ë§ ì‹œì‘
                startMessagePolling();
                console.log(`[ì…ì¥] ${roomName} ë°© ì…ì¥ ì™„ë£Œ, í´ë§ ì‹œì‘ë¨`);
            } else {
                // ê´€ì‹¬ë¶„ì•¼ ë°©: ì„œë²„ì—ì„œ ë©”ì‹œì§€ ë¡œë“œ
                await loadRoomMessages(roomName);
                
                // ì°¸ì—¬ì ìˆ˜ ì¦ê°€
                if (roomData && roomData.type === 'interest') {
                    incrementParticipantCount(roomName);
                }
                
                // ë©”ì‹œì§€ í´ë§ ì‹œì‘ (ê´€ì‹¬ë¶„ì•¼ ë°©ë„ ì‹¤ì‹œê°„ ë©”ì‹œì§€ ìˆ˜ì‹ )
                startMessagePolling();
                console.log(`[ì…ì¥] ${roomName} ë°© ì…ì¥ ì™„ë£Œ, í´ë§ ì‹œì‘ë¨`);
            }
            
            // ì°¸ì—¬ì ìˆ˜ í‘œì‹œ (ê·¸ë£¹ ì±„íŒ…ë°©ì¸ ê²½ìš°ì—ë§Œ)
            const participantCount = roomParticipants[roomName]?.count || 0;
            const participantCountElement = document.getElementById('participantCount');
            
            if (roomParticipants[roomName]) {
                // ê·¸ë£¹ ì±„íŒ…ë°©
                participantCountElement.textContent = `í˜„ì¬ ${participantCount}ëª… ì°¸ì—¬ì¤‘`;
                participantCountElement.style.display = 'block';
            } else {
                // 1:1 ì±„íŒ…ë°©
                participantCountElement.textContent = `1:1 ì±„íŒ…`;
                participantCountElement.style.display = 'block';
            }
            
            // ë²„íŠ¼ë“¤ í‘œì‹œ
            document.getElementById('backToHome').style.display = 'inline-flex';
            document.getElementById('chatOptions').style.display = 'inline-flex';
            
            // ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì´ˆê¸°í™”
            if (roomParticipants[roomName]) {
                roomParticipants[roomName].unreadCount = 0;
                updateRoomUnreadCount(roomName);
            }
            
            // ì±„íŒ…ë°© ëª©ë¡ì—ì„œ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì´ˆê¸°í™”
            if (roomData) {
                roomData.unreadCount = 0;
                saveChatData();
                updateRoomListUI();
            }
            
            // í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.room-list li, #dmList li, #interestList li').forEach(li => {
                li.classList.remove('active');
                if (li.textContent.includes(roomName)) {
                    li.classList.add('active');
                }
            });
            
            // 1:1 ì±„íŒ…ë°©ì¸ ê²½ìš° ì„œë²„ì— ì…ì¥ ì•Œë¦¼
            if (roomData && roomData.type === 'dm' && roomData.roomId) {
                try {
                    const response = await fetch(`/api/room/${encodeURIComponent(roomData.roomId)}/enter`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`[ì…ì¥] ${roomName} ë°© ì…ì¥ ì™„ë£Œ:`, result.message);
                        
                        if (result.other_user_entered) {
                            console.log('[ì…ì¥] ìƒëŒ€ë°©ì´ ì´ë¯¸ ì…ì¥í•œ ìƒíƒœ');
                        } else {
                            console.log('[ì…ì¥] ì²« ë²ˆì§¸ ì…ì¥ì');
                        }
                        
                        // ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ ë‹¤ì‹œ ë¡œë“œ (ì…ì¥ ë©”ì‹œì§€ í¬í•¨)
                        await loadRoomMessages(roomName);
                    }
                } catch (error) {
                    console.error('[ì…ì¥] ì„œë²„ ì…ì¥ ì•Œë¦¼ ì‹¤íŒ¨:', error);
                }
            }
            // ê·¸ë£¹ ì±„íŒ…ë°©ì¸ ê²½ìš° ì„œë²„ì— ì…ì¥ ì•Œë¦¼
            else if (roomData && roomData.type === 'group' && roomData.roomId) {
                try {
                    const response = await fetch(`/api/group/${encodeURIComponent(roomData.roomId)}/enter`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`[ê·¸ë£¹ ì…ì¥] ${roomName} ê·¸ë£¹ ì…ì¥ ì™„ë£Œ:`, result.message);
                        
                        // ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ ë‹¤ì‹œ ë¡œë“œ (ì…ì¥ ë©”ì‹œì§€ í¬í•¨)
                        await loadRoomMessages(roomName);
                    }
                } catch (error) {
                    console.error('[ê·¸ë£¹ ì…ì¥] ì„œë²„ ì…ì¥ ì•Œë¦¼ ì‹¤íŒ¨:', error);
                }
            }
        }

        // ì±„íŒ…ë°© ë©”ì‹œì§€ ë¡œë“œ
        function loadRoomMessages(roomName) {
            const messages = document.getElementById('messages');
            messages.innerHTML = '';
            
            if (chatData.rooms[roomName] && chatData.rooms[roomName].length > 0) {
                // ì €ì¥ëœ ë©”ì‹œì§€ í‘œì‹œ
                chatData.rooms[roomName].forEach(messageData => {
                    const messageWrapper = document.createElement('div');
                    
                    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
                    if (messageData.type === 'leave' || messageData.type === 'enter' || messageData.type === 'wait') {
                        // ì‹œìŠ¤í…œ ë©”ì‹œì§€ (ë‚˜ê°€ê¸°, ì…ì¥, ëŒ€ê¸°)
                        messageWrapper.className = 'msg-wrapper system';
                        messageWrapper.style.justifyContent = 'center';
                        messageWrapper.style.margin = '8px 0';
                        
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'msg system';
                        
                        // ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ì„¤ì •
                        if (messageData.type === 'enter') {
                            messageDiv.style.background = 'linear-gradient(135deg, #dcfce7, #bbf7d0)';
                            messageDiv.style.color = '#166534';
                            messageDiv.style.border = '1px solid #86efac';
                        } else if (messageData.type === 'wait') {
                            messageDiv.style.background = 'linear-gradient(135deg, #fef3c7, #fde68a)';
                            messageDiv.style.color = '#92400e';
                            messageDiv.style.border = '1px solid #fbbf24';
                        } else {
                            // leave
                            messageDiv.style.background = 'linear-gradient(135deg, #f3f4f6, #e5e7eb)';
                            messageDiv.style.color = '#6b7280';
                            messageDiv.style.border = '1px solid #d1d5db';
                        }
                        
                        messageDiv.style.fontSize = '12px';
                        messageDiv.style.fontStyle = 'italic';
                        messageDiv.style.maxWidth = 'auto';
                        messageDiv.style.padding = '6px 12px';
                        messageDiv.style.borderRadius = '12px';
                        
                        // ì‹œê°„ í‘œì‹œ (ì„œë²„ì—ì„œ ì˜¨ ë©”ì‹œì§€ì¸ ê²½ìš°)
                        let timeString = messageData.timeString;
                        if (!timeString && messageData.timestamp) {
                            const date = new Date(messageData.timestamp * 1000);
                            timeString = date.toLocaleTimeString('ko-KR', { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                hour12: false 
                            });
                        }
                        
                        messageDiv.innerHTML = `
                            <div class="msg-content">${messageData.content || messageData.text}</div>
                            <div class="msg-time" style="font-size: 10px; margin-top: 2px; opacity: 0.7;">${timeString}</div>
                        `;
                        
                        messageWrapper.appendChild(messageDiv);
                    } else {
                        // ì¼ë°˜ ë©”ì‹œì§€
                        messageWrapper.className = `msg-wrapper ${messageData.isMe ? 'me' : ''}`;
                        
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `msg ${messageData.isMe ? 'me' : ''}`;
                        
                        if (messageData.isMe) {
                            // ë‚´ ë©”ì‹œì§€
                            messageDiv.innerHTML = `
                                <div class="msg-content">${messageData.text}</div>
                                <div class="msg-time">${messageData.timeString}</div>
                            `;
                        } else {
                            // ìƒëŒ€ë°© ë©”ì‹œì§€
                            messageDiv.innerHTML = `
                                <div class="msg-nickname">${messageData.nickname}</div>
                                <div class="msg-content">${messageData.text}</div>
                                <div class="msg-time">${messageData.timeString}</div>
                            `;
                        }
                        
                        messageWrapper.appendChild(messageDiv);
                    }
                    
                    messages.appendChild(messageWrapper);
                });
            } else {
                // ì²« ì…ì¥ ë©”ì‹œì§€
                addMessage('ì±„íŒ…ë°©ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤.', false);
            }
            
            messages.scrollTop = messages.scrollHeight;
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message && currentRoom) {
                console.log(`[ì „ì†¡] ì±„íŒ…ë°©: ${currentRoom}, ë©”ì‹œì§€: ${message}`);
                
                // ë°© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const roomData = chatData.roomList.find(room => room.name === currentRoom);
                
                // 1:1 ì±„íŒ…ë°©ì¸ ê²½ìš° roomId ì‚¬ìš©, ê·¸ë£¹ì±„íŒ…ë°©ë„ roomId ì‚¬ìš©, ê·¸ ì™¸ì—ëŠ” roomName ì‚¬ìš©
                const roomId = (roomData && (roomData.type === 'dm' || roomData.type === 'group') && roomData.roomId) ? roomData.roomId : currentRoom;
                
                console.log(`[ì „ì†¡] ì‹¤ì œ ì±„íŒ…ë°© ID: ${roomId} (íƒ€ì…: ${roomData?.type || 'unknown'})`);
                
                // ë‚´ ë©”ì‹œì§€ë¥¼ ì¦‰ì‹œ í‘œì‹œ
                addMessage(message, true);
                messageInput.value = '';
                
                // ì„œë²„ì— ë©”ì‹œì§€ ì „ì†¡ (1:1 ì±„íŒ…ë°©ê³¼ ê·¸ë£¹ì±„íŒ…ë°© ëª¨ë‘)
                if (roomData && (roomData.type === 'dm' || roomData.type === 'group')) {
                    try {
                        const anonProfile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
                        const nickname = anonProfile ? anonProfile.nickname : 'ìµëª…';
                    
                    console.log(`[ì „ì†¡] ë‹‰ë„¤ì„: ${nickname}, ì±„íŒ…ë°© ID: ${roomId}`);
                    
                    const response = await fetch(`/api/chat/messages/${encodeURIComponent(roomId)}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            sender_nickname: nickname
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.message_data) {
                        // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ IDë¥¼ í•´ë‹¹ ì±„íŒ…ë°©ì˜ ì¶”ì  ëª©ë¡ì— ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
                        if (!displayedMessageIds[currentRoom]) {
                            displayedMessageIds[currentRoom] = new Set();
                        }
                        displayedMessageIds[currentRoom].add(result.message_data.id);
                        console.log(`[ì „ì†¡ ì„±ê³µ] ë©”ì‹œì§€ ID: ${result.message_data.id}`);
                    } else {
                        console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', result.message);
                    }
                } catch (error) {
                    console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
                }
            } else {
                console.warn('ë©”ì‹œì§€ ë˜ëŠ” í˜„ì¬ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

    // ë©”ì‹œì§€ í´ë§ ì¸í„°ë²Œ
    let messagePollingInterval = null;
    let displayedMessageIds = {}; // ì±„íŒ…ë°©ë³„ë¡œ ì´ë¯¸ í‘œì‹œëœ ë©”ì‹œì§€ ID ì¶”ì  { roomName: Set(), ... }
    
    // ì±„íŒ…ë°© ë©”ì‹œì§€ ë¡œë“œ
    async function loadRoomMessages(roomName) {
        console.log(`[ë¡œë“œ] ${roomName} ë°©ì˜ ë©”ì‹œì§€ ë¡œë“œ ì‹œì‘`);
        
        // ë°© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const roomData = chatData.roomList.find(room => room.name === roomName);
        
        // 1:1 ì±„íŒ…ë°©ì¸ ê²½ìš° roomId ì‚¬ìš©, ê·¸ë£¹ì±„íŒ…ë°©ë„ roomId ì‚¬ìš©, ê·¸ ì™¸ì—ëŠ” roomName ì‚¬ìš©
        const roomId = (roomData && (roomData.type === 'dm' || roomData.type === 'group') && roomData.roomId) ? roomData.roomId : roomName;
        
        console.log(`[ë¡œë“œ] ì‹¤ì œ ì±„íŒ…ë°© ID: ${roomId} (íƒ€ì…: ${roomData?.type || 'unknown'})`);
        
        try {
            const response = await fetch(`/api/chat/messages/${encodeURIComponent(roomId)}`);
            const result = await response.json();
            
            console.log(`[ë¡œë“œ] ì„œë²„ ì‘ë‹µ:`, result);
            
            if (result.success && result.messages) {
                // ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
                document.getElementById('messages').innerHTML = '';
                
                // í•´ë‹¹ ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ ID ì¶”ì  ì´ˆê¸°í™”
                if (!displayedMessageIds[roomName]) {
                    displayedMessageIds[roomName] = new Set();
                }
                displayedMessageIds[roomName].clear();
                
                // í˜„ì¬ ì‚¬ìš©ìì˜ ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°
                const anonProfile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
                const myNickname = anonProfile ? anonProfile.nickname : 'ìµëª…';
                
                console.log(`[ë¡œë“œ] ë‚´ ë‹‰ë„¤ì„: ${myNickname}`);
                
                // ë©”ì‹œì§€ í‘œì‹œ
                result.messages.forEach(msg => {
                    console.log(`[ë¡œë“œ] ë©”ì‹œì§€: ${msg.sender} - ${msg.content.substring(0, 20)}... (íƒ€ì…: ${msg.type || 'text'})`);
                    addMessageFromServer(msg);
                    displayedMessageIds[roomName].add(msg.id);
                });
                
                console.log(`[ë¡œë“œ] ${roomName} ë°©ì˜ ë©”ì‹œì§€ ${result.messages.length}ê°œ ë¡œë“œ ì™„ë£Œ`);
            }
        } catch (error) {
            console.error('[ë¡œë“œ] ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
        }
    }
    
    // ë©”ì‹œì§€ í´ë§ ì‹œì‘
    function startMessagePolling() {
        // ê¸°ì¡´ í´ë§ ì¤‘ì§€
        if (messagePollingInterval) {
            clearInterval(messagePollingInterval);
            console.log('[í´ë§] ê¸°ì¡´ í´ë§ ì¤‘ì§€');
        }
        
        console.log(`[í´ë§] ${currentRoom} ë°©ì˜ ë©”ì‹œì§€ í´ë§ ì‹œì‘ (2ì´ˆë§ˆë‹¤)`);
        
        // 2ì´ˆë§ˆë‹¤ ìƒˆ ë©”ì‹œì§€ í™•ì¸
        messagePollingInterval = setInterval(async () => {
            if (currentRoom) {
                try {
                    // ë°© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const roomData = chatData.roomList.find(room => room.name === currentRoom);
                    
                    // 1:1 ì±„íŒ…ë°©ì¸ ê²½ìš° roomId ì‚¬ìš©, ê·¸ ì™¸ì—ëŠ” roomName ì‚¬ìš©
                    const roomId = (roomData && roomData.type === 'dm' && roomData.roomId) ? roomData.roomId : currentRoom;
                    
                    const response = await fetch(`/api/chat/messages/${encodeURIComponent(roomId)}`);
                    const result = await response.json();
                    
                    if (result.success && result.messages) {
                        const anonProfile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
                        const myNickname = anonProfile ? anonProfile.nickname : 'ìµëª…';
                        
                        // í•´ë‹¹ ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ ID ì¶”ì  Setì´ ì—†ìœ¼ë©´ ìƒì„±
                        if (!displayedMessageIds[currentRoom]) {
                            displayedMessageIds[currentRoom] = new Set();
                        }
                        
                        // ì•„ì§ í‘œì‹œë˜ì§€ ì•Šì€ ìƒˆ ë©”ì‹œì§€ë§Œ í•„í„°ë§
                        const newMessages = result.messages.filter(msg => !displayedMessageIds[currentRoom].has(msg.id));
                        
                        if (newMessages.length > 0) {
                            console.log(`[í´ë§] ${currentRoom} ë°©ì—ì„œ ${newMessages.length}ê°œì˜ ìƒˆ ë©”ì‹œì§€ ë°œê²¬`);
                            
                            newMessages.forEach(msg => {
                                console.log(`[í´ë§] ë©”ì‹œì§€ í‘œì‹œ: ${msg.sender} - ${msg.content.substring(0, 20)}... (íƒ€ì…: ${msg.type || 'text'})`);
                                addMessageFromServer(msg);
                                displayedMessageIds[currentRoom].add(msg.id);
                            });
                        }
                    }
                } catch (error) {
                    console.error('[í´ë§] ë©”ì‹œì§€ í´ë§ ì˜¤ë¥˜:', error);
                }
            }
        }, 2000);
    }
    
    // ë©”ì‹œì§€ í´ë§ ì¤‘ì§€
    function stopMessagePolling() {
        if (messagePollingInterval) {
            clearInterval(messagePollingInterval);
            messagePollingInterval = null;
            console.log('[í´ë§] ë©”ì‹œì§€ í´ë§ ì¤‘ì§€');
        }
    }

    // ëœë¤ ë§¤ì¹­ í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
    function backToHome() {
      stopMessagePolling();
      currentRoom = null;
      document.getElementById('chatHeader').textContent = 'ëœë¤ ë§¤ì¹­';
      document.getElementById('chatContent').style.display = 'block';
      document.getElementById('chatRoom').style.display = 'none';
      
      // ì°¸ì—¬ì ìˆ˜ì™€ ë²„íŠ¼ë“¤ ìˆ¨ê¸°ê¸°
      document.getElementById('participantCount').style.display = 'none';
      document.getElementById('backToHome').style.display = 'none';
      document.getElementById('chatOptions').style.display = 'none';
      document.getElementById('chatOptionsDropdown').style.display = 'none';
      
      // í™œì„± ì±„íŒ…ë°© ì„ íƒ í•´ì œ
      document.querySelectorAll('.room-list li, #dmList li, #interestList li').forEach(li => {
        li.classList.remove('active');
      });
        }

        // ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ ì¶”ê°€ (ì‹œìŠ¤í…œ ë©”ì‹œì§€ í¬í•¨)
        function addMessageFromServer(msg) {
            if (!currentRoom) return;
            
            const messages = document.getElementById('messages');
            const anonProfile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
            const myNickname = anonProfile ? anonProfile.nickname : 'ìµëª…';
            
            // ì‹œê°„ ë¬¸ìì—´ ìƒì„±
            let timeString = '';
            if (msg.timestamp) {
                const date = new Date(msg.timestamp * 1000);
                timeString = date.toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                });
            }
            
            const messageWrapper = document.createElement('div');
            
            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì²˜ë¦¬
            if (msg.type === 'wait' || msg.type === 'enter' || msg.type === 'leave') {
                messageWrapper.className = 'msg-wrapper system';
                messageWrapper.style.justifyContent = 'center';
                messageWrapper.style.margin = '8px 0';
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'msg system';
                
                // ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ì„¤ì •
                if (msg.type === 'enter') {
                    messageDiv.style.background = 'linear-gradient(135deg, #dcfce7, #bbf7d0)';
                    messageDiv.style.color = '#166534';
                    messageDiv.style.border = '1px solid #86efac';
                } else if (msg.type === 'wait') {
                    messageDiv.style.background = 'linear-gradient(135deg, #fef3c7, #fde68a)';
                    messageDiv.style.color = '#92400e';
                    messageDiv.style.border = '1px solid #fbbf24';
                } else {
                    // leave
                    messageDiv.style.background = 'linear-gradient(135deg, #f3f4f6, #e5e7eb)';
                    messageDiv.style.color = '#6b7280';
                    messageDiv.style.border = '1px solid #d1d5db';
                }
                
                messageDiv.style.fontSize = '12px';
                messageDiv.style.fontStyle = 'italic';
                messageDiv.style.maxWidth = 'auto';
                messageDiv.style.padding = '6px 12px';
                messageDiv.style.borderRadius = '12px';
                
                messageDiv.innerHTML = `
                    <div class="msg-content">${msg.content}</div>
                    <div class="msg-time" style="font-size: 10px; margin-top: 2px; opacity: 0.7;">${timeString}</div>
                `;
                
                messageWrapper.appendChild(messageDiv);
            } else {
                // ì¼ë°˜ ë©”ì‹œì§€
                const isMyMessage = msg.sender === myNickname;
                messageWrapper.className = `msg-wrapper ${isMyMessage ? 'me' : ''}`;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `msg ${isMyMessage ? 'me' : ''}`;
                
                if (isMyMessage) {
                    // ë‚´ ë©”ì‹œì§€
                    messageDiv.innerHTML = `
                        <div class="msg-content">${msg.content}</div>
                        <div class="msg-time">${timeString}</div>
                    `;
                } else {
                    // ìƒëŒ€ë°© ë©”ì‹œì§€
                    messageDiv.innerHTML = `
                        <div class="msg-nickname">${msg.sender}</div>
                        <div class="msg-content">${msg.content}</div>
                        <div class="msg-time">${timeString}</div>
                    `;
                }
                
                messageWrapper.appendChild(messageDiv);
            }
            
            messages.appendChild(messageWrapper);
            messages.scrollTop = messages.scrollHeight;
        }

        // ë©”ì‹œì§€ ì¶”ê°€ (ë¡œì»¬ ì „ìš©)
        function addMessage(text, isMe, nickname = null) {
            if (!currentRoom) return;
            
            const messages = document.getElementById('messages');
            
            // í˜„ì¬ ì‹œê°„ ìƒì„±
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            
            // ë©”ì‹œì§€ ë°ì´í„° ìƒì„±
            const messageData = {
                text: text,
                isMe: isMe,
                nickname: isMe ? (JSON.parse(localStorage.getItem('anonProfile') || '{}').nickname || 'ë‚˜') : (nickname || getRandomNickname()),
                timestamp: now.toISOString(),
                timeString: timeString
            };
            
            // ì±„íŒ… ë°ì´í„°ì— ì €ì¥
            if (!chatData.rooms[currentRoom]) {
                chatData.rooms[currentRoom] = [];
            }
            chatData.rooms[currentRoom].push(messageData);
            saveChatData();
            
            // ë©”ì‹œì§€ ë˜í¼ ìƒì„±
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `msg-wrapper ${isMe ? 'me' : ''}`;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `msg ${isMe ? 'me' : ''}`;
            
            if (isMe) {
                // ë‚´ ë©”ì‹œì§€
                messageDiv.innerHTML = `
                    <div class="msg-content">${text}</div>
                    <div class="msg-time">${timeString}</div>
                `;
            } else {
                // ìƒëŒ€ë°© ë©”ì‹œì§€ (ë‹‰ë„¤ì„ í¬í•¨)
                messageDiv.innerHTML = `
                    <div class="msg-nickname">${messageData.nickname}</div>
                    <div class="msg-content">${text}</div>
                    <div class="msg-time">${timeString}</div>
                `;
            }
            
            messageWrapper.appendChild(messageDiv);
            messages.appendChild(messageWrapper);
            messages.scrollTop = messages.scrollHeight;
        }

        // ë‚˜ê°€ê¸° ë©”ì‹œì§€ ì¶”ê°€
        function addLeaveMessage(nickname) {
            if (!currentRoom) return;
            
            const messages = document.getElementById('messages');
            
            // í˜„ì¬ ì‹œê°„ ìƒì„±
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            
            // ë‚˜ê°€ê¸° ë©”ì‹œì§€ ë°ì´í„° ìƒì„±
            const leaveMessageData = {
                text: `${nickname}ë‹˜ì´ ì±„íŒ…ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.`,
                isMe: false,
                nickname: 'ì‹œìŠ¤í…œ',
                timestamp: now.toISOString(),
                timeString: timeString,
                type: 'leave'
            };
            
            // ì±„íŒ… ë°ì´í„°ì— ì €ì¥
            if (!chatData.rooms[currentRoom]) {
                chatData.rooms[currentRoom] = [];
            }
            chatData.rooms[currentRoom].push(leaveMessageData);
            saveChatData();
            
            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ë˜í¼ ìƒì„±
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'msg-wrapper system';
            messageWrapper.style.justifyContent = 'center';
            messageWrapper.style.margin = '8px 0';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'msg system';
            messageDiv.style.background = 'linear-gradient(135deg, #f3f4f6, #e5e7eb)';
            messageDiv.style.color = '#6b7280';
            messageDiv.style.fontSize = '12px';
            messageDiv.style.fontStyle = 'italic';
            messageDiv.style.maxWidth = 'auto';
            messageDiv.style.padding = '6px 12px';
            messageDiv.style.borderRadius = '12px';
            messageDiv.style.border = '1px solid #d1d5db';
            
            messageDiv.innerHTML = `
                <div class="msg-content">${leaveMessageData.text}</div>
                <div class="msg-time" style="font-size: 10px; margin-top: 2px; opacity: 0.7;">${timeString}</div>
            `;
            
            messageWrapper.appendChild(messageDiv);
            messages.appendChild(messageWrapper);
            messages.scrollTop = messages.scrollHeight;
        }

        // ëœë¤ ë‹‰ë„¤ì„ ìƒì„±
        function getRandomNickname() {
            // 1:1 ì±„íŒ…ë°©ì¸ ê²½ìš° ì±„íŒ…ë°© ì´ë¦„ì„ ë‹‰ë„¤ì„ìœ¼ë¡œ ì‚¬ìš©
            const roomData = chatData.roomList.find(room => room.name === currentRoom);
            if (roomData && roomData.type === 'dm') {
                return currentRoom;
            }
            
            // ê·¸ë£¹ ì±„íŒ…ë°©ì´ë‚˜ ê´€ì‹¬ë¶„ì•¼ ë°©ì¸ ê²½ìš°
            if (currentRoom && roomParticipants[currentRoom] && roomParticipants[currentRoom].users.length > 0) {
                const users = roomParticipants[currentRoom].users;
                // í˜„ì¬ ì‚¬ìš©ìì˜ ë‹‰ë„¤ì„ ì œì™¸
                const currentUserNickname = JSON.parse(localStorage.getItem('anonProfile') || '{}').nickname || 'ë‚˜';
                const otherUsers = users.filter(u => u !== currentUserNickname);
                
                if (otherUsers.length > 0) {
                    // ë‹¤ë¥¸ ì‚¬ìš©ì ë‹‰ë„¤ì„ ì¤‘ì—ì„œ ëœë¤ ì„ íƒ
                    return otherUsers[Math.floor(Math.random() * otherUsers.length)];
                }
                
                // ë³¸ì¸ë§Œ ìˆëŠ” ê²½ìš°
                return users[Math.floor(Math.random() * users.length)];
            }
            
            // ê¸°ë³¸ê°’ (ì°¸ì—¬ìê°€ ì—†ëŠ” ê²½ìš°)
            return 'ìµëª…' + Math.floor(Math.random() * 100);
        }

    // ì±„íŒ… ì˜µì…˜ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function toggleChatOptions() {
      const dropdown = document.getElementById('chatOptionsDropdown');
      const optionsBtn = document.getElementById('chatOptions');
      
      if (dropdown.style.display === 'none' || dropdown.style.display === '') {
        // ë“œë¡­ë‹¤ìš´ ìœ„ì¹˜ ê³„ì‚°
        const btnRect = optionsBtn.getBoundingClientRect();
        dropdown.style.top = (btnRect.bottom + 8) + 'px';
        dropdown.style.right = (window.innerWidth - btnRect.right) + 'px';
        dropdown.style.display = 'block';
      } else {
        dropdown.style.display = 'none';
      }
    }
    
    function showParticipants() {
      const participantsList = document.getElementById('participantsList');
      participantsList.innerHTML = '';
      
      // í˜„ì¬ ì‚¬ìš©ì ë‹‰ë„¤ì„
      const currentUserNickname = localStorage.getItem('anonProfile') ? 
        JSON.parse(localStorage.getItem('anonProfile')).nickname : 'ìµëª…ì˜ì¹œêµ¬';
      
      if (currentRoom && roomParticipants[currentRoom] && roomParticipants[currentRoom].users.length > 0) {
        // ê·¸ë£¹ ì±„íŒ…ë°© ë˜ëŠ” ê´€ì‹¬ë¶„ì•¼ ë°©ì¸ ê²½ìš°
        const users = roomParticipants[currentRoom].users;
        
        users.forEach((user, index) => {
          const participantItem = document.createElement('div');
          participantItem.className = 'participant-item';
          participantItem.onclick = () => showParticipantProfile(user);
          
          const isMe = user === currentUserNickname;
          
          participantItem.innerHTML = `
            <div class="participant-avatar">ğŸ‘¤</div>
            <div class="participant-info">
              <div class="participant-name">${user}${isMe ? ' (ë‚˜)' : ''}</div>
              <div class="participant-status">ì˜¨ë¼ì¸</div>
            </div>
            <div class="participant-profile">í”„ë¡œí•„ ë³´ê¸°</div>
          `;
          
          participantsList.appendChild(participantItem);
        });
      } else {
        // 1:1 ì±„íŒ…ë°©ì¸ ê²½ìš° (ìƒëŒ€ë°©ê³¼ ë‚˜)
        const opponentName = currentRoom; // 1:1 ì±„íŒ…ì—ì„œëŠ” ë°© ì´ë¦„ì´ ìƒëŒ€ë°© ì´ë¦„
        
        // ìƒëŒ€ë°© í”„ë¡œí•„
        const opponentItem = document.createElement('div');
        opponentItem.className = 'participant-item';
        opponentItem.onclick = () => showParticipantProfile(opponentName);
        
        opponentItem.innerHTML = `
          <div class="participant-avatar">ğŸ‘¤</div>
          <div class="participant-info">
            <div class="participant-name">${opponentName}</div>
            <div class="participant-status">ì˜¨ë¼ì¸</div>
          </div>
          <div class="participant-profile">í”„ë¡œí•„ ë³´ê¸°</div>
        `;
        participantsList.appendChild(opponentItem);
        
        // ë‚´ í”„ë¡œí•„
        const myItem = document.createElement('div');
        myItem.className = 'participant-item';
        myItem.onclick = () => showParticipantProfile(currentUserNickname);
        
        myItem.innerHTML = `
          <div class="participant-avatar">ğŸ‘¤</div>
          <div class="participant-info">
            <div class="participant-name">${currentUserNickname} (ë‚˜)</div>
            <div class="participant-status">ì˜¨ë¼ì¸</div>
          </div>
          <div class="participant-profile">í”„ë¡œí•„ ë³´ê¸°</div>
        `;
        participantsList.appendChild(myItem);
      }
      
      document.getElementById('participantsModal').style.display = 'flex';
      document.getElementById('chatOptionsDropdown').style.display = 'none';
    }
    
    function closeParticipantsModal() {
      document.getElementById('participantsModal').style.display = 'none';
    }
    
    function showParticipantProfile(nickname) {
      // ë‚´ í”„ë¡œí•„ì¸ì§€ í™•ì¸
      const currentUser = localStorage.getItem('anonProfile') ? 
        JSON.parse(localStorage.getItem('anonProfile')).nickname : 'ìµëª…ì˜ì¹œêµ¬';
      
      let profile;
      
      if (nickname === currentUser || nickname.includes('(ë‚˜)')) {
        // ë‚´ í”„ë¡œí•„ì¸ ê²½ìš°
        const myProfile = localStorage.getItem('anonProfile') ? 
          JSON.parse(localStorage.getItem('anonProfile')) : null;
        
        profile = myProfile ? {
          year: myProfile.year,
          gender: myProfile.gender,
          bio: myProfile.bio,
          interests: myProfile.interests
        } : {
          year: '2024',
          gender: 'ë‚¨ì',
          bio: 'ìƒˆë¡œìš´ ì¹œêµ¬ë¥¼ ë§Œë‚˜ê³  ì‹¶ì–´ìš”!',
          interests: ['ìš´ë™', 'ìŒì•…']
        };
      } else {
        // ë‹¤ë¥¸ ì‚¬ìš©ì í”„ë¡œí•„ì¸ ê²½ìš° - randomProfilesì—ì„œ ì°¾ê¸°
        const foundProfile = randomProfiles.find(p => p.nickname === nickname);
        
        if (foundProfile) {
          profile = foundProfile;
        } else {
          // ê¸°ë³¸ í”„ë¡œí•„ (ì°¾ì§€ ëª»í•œ ê²½ìš°)
          profile = {
            year: 'ìµëª…',
            gender: 'ë¹„ê³µê°œ',
            bio: 'í”„ë¡œí•„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.',
            interests: []
          };
        }
      }
      
      const profileContent = document.getElementById('participantProfileContent');
      profileContent.innerHTML = `
        <div class="profile-avatar-large">ğŸ‘¤</div>
        <h4 style="margin: 0 0 8px 0; color: #374151;">${nickname}</h4>
        <div class="profile-details">
          <div class="profile-detail-item">
            <span class="profile-detail-label">í•™ë²ˆ</span>
            <span class="profile-detail-value">${profile.year}</span>
          </div>
          <div class="profile-detail-item">
            <span class="profile-detail-label">ì„±ë³„</span>
            <span class="profile-detail-value">${profile.gender}</span>
          </div>
          <div class="profile-detail-item">
            <span class="profile-detail-label">ì†Œê°œ</span>
            <span class="profile-detail-value">${profile.bio}</span>
          </div>
          <div class="profile-detail-item">
            <span class="profile-detail-label">ê´€ì‹¬ì‚¬</span>
            <span class="profile-detail-value">${profile.interests.join(', ')}</span>
          </div>
        </div>
      `;
      
      document.getElementById('participantProfileModal').style.display = 'flex';
      closeParticipantsModal();
    }
    
    function closeParticipantProfileModal() {
      document.getElementById('participantProfileModal').style.display = 'none';
    }
    
    
    async function leaveChatRoom() {
      if (confirm('ì •ë§ë¡œ ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        if (!currentRoom) return;
        
        const roomToLeave = currentRoom;
        console.log(`[ë‚˜ê°€ê¸° ì‹œì‘] ${roomToLeave} ì±„íŒ…ë°©`);
        
        // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const currentUser = localStorage.getItem('anonProfile') ? 
          JSON.parse(localStorage.getItem('anonProfile')).nickname : 'ìµëª…ì˜ì¹œêµ¬';
        
        // ì„œë²„ì— ë‚˜ê°€ê¸° ë©”ì‹œì§€ ì „ì†¡
        try {
          const leaveResponse = await fetch(`/api/chat/leave/${encodeURIComponent(roomToLeave)}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              nickname: currentUser
            })
          });
          
          if (leaveResponse.ok) {
            console.log(`[ë‚˜ê°€ê¸° ë©”ì‹œì§€] ì„œë²„ì— ë‚˜ê°€ê¸° ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ: ${roomToLeave}`);
          }
        } catch (error) {
          console.error('[ë‚˜ê°€ê¸° ë©”ì‹œì§€] ì„œë²„ ì „ì†¡ ì‹¤íŒ¨:', error);
        }
        
        // 1:1 ì±„íŒ…ë°©ì¸ ê²½ìš° ì„œë²„ì— ë°© ë¹„í™œì„±í™” ìš”ì²­
        const roomData = chatData.roomList.find(room => room.name === roomToLeave);
        if (roomData && roomData.type === 'dm' && roomData.roomId) {
          try {
            const roomLeaveResponse = await fetch(`/api/room/${encodeURIComponent(roomData.roomId)}/leave`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            if (roomLeaveResponse.ok) {
              console.log(`[ë°© ë¹„í™œì„±í™”] ${roomToLeave} ë°©ì„ ì„œë²„ì—ì„œ ë¹„í™œì„±í™” ì™„ë£Œ`);
            }
          } catch (error) {
            console.error('[ë°© ë¹„í™œì„±í™”] ì„œë²„ ìš”ì²­ ì‹¤íŒ¨:', error);
          }
        }
        // ê·¸ë£¹ ì±„íŒ…ë°©ì¸ ê²½ìš° ì„œë²„ì— ê·¸ë£¹ ë‚˜ê°€ê¸° ìš”ì²­
        else if (roomData && roomData.type === 'group' && roomData.roomId) {
          try {
            const groupLeaveResponse = await fetch(`/api/group/${encodeURIComponent(roomData.roomId)}/leave`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            if (groupLeaveResponse.ok) {
              console.log(`[ê·¸ë£¹ ë‚˜ê°€ê¸°] ${roomToLeave} ê·¸ë£¹ì—ì„œ ì„œë²„ ë‚˜ê°€ê¸° ì™„ë£Œ`);
            }
          } catch (error) {
            console.error('[ê·¸ë£¹ ë‚˜ê°€ê¸°] ì„œë²„ ìš”ì²­ ì‹¤íŒ¨:', error);
          }
        }
        
        // ë‚˜ê°€ê¸° ë©”ì‹œì§€ ì¶”ê°€
        addLeaveMessage(currentUser);
        
        // 1. ë‚˜ê°„ ì±„íŒ…ë°© ëª©ë¡ì— ì¶”ê°€ (ìµœìš°ì„ )
        let leftRooms = JSON.parse(localStorage.getItem('leftRooms') || '[]');
        if (!leftRooms.includes(roomToLeave)) {
          leftRooms.push(roomToLeave);
          localStorage.setItem('leftRooms', JSON.stringify(leftRooms));
          console.log(`[ë‚˜ê°€ê¸° 1/5] ${roomToLeave}ì„ ë‚˜ê°„ ë°© ëª©ë¡ì— ì¶”ê°€ (í˜„ì¬ ë‚˜ê°„ ë°©: ${leftRooms.length}ê°œ)`);
        }
        
        // 2. ê´€ì‹¬ë¶„ì•¼ ë°©ì¸ ê²½ìš° ì„œë²„ì—ì„œ ì°¸ì—¬ì ìˆ˜ ì—…ë°ì´íŠ¸ ë° í”„ë¡œí•„ì—ì„œ ì œê±°
        try {
          const anonProfile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
          if (anonProfile && anonProfile.interests && anonProfile.interests.includes(roomToLeave)) {
            // ì„œë²„ì— ê´€ì‹¬ë¶„ì•¼ ë°© ë‚˜ê°€ê¸° ìš”ì²­
            const interestLeaveResponse = await fetch(`/api/interest/${encodeURIComponent(roomToLeave)}/leave`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            if (interestLeaveResponse.ok) {
              const result = await interestLeaveResponse.json();
              if (result.success) {
                // ë¡œì»¬ í”„ë¡œí•„ì—ì„œë„ ì œê±°
                const interestIndex = anonProfile.interests.indexOf(roomToLeave);
                if (interestIndex > -1) {
                  anonProfile.interests.splice(interestIndex, 1);
                  localStorage.setItem('anonProfile', JSON.stringify(anonProfile));
                  console.log(`[ë‚˜ê°€ê¸° 2/5] ê´€ì‹¬ë¶„ì•¼ ë°© ${roomToLeave}ì—ì„œ ë‚˜ê°€ê¸° ì™„ë£Œ (ë‚¨ì€ ê´€ì‹¬ì‚¬: ${anonProfile.interests.length}ê°œ)`);
                  
                  // ì°¸ì—¬ì ìˆ˜ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ê´€ì‹¬ë¶„ì•¼ ì¹´ìš´íŠ¸ ë‹¤ì‹œ ë¡œë“œ
                  await loadInterestCounts();
                }
              } else {
                console.error(`[ë‚˜ê°€ê¸° 2/5] ì„œë²„ ê´€ì‹¬ë¶„ì•¼ ë‚˜ê°€ê¸° ì‹¤íŒ¨:`, result.message);
              }
            } else {
              console.error(`[ë‚˜ê°€ê¸° 2/5] ì„œë²„ ê´€ì‹¬ë¶„ì•¼ ë‚˜ê°€ê¸° ìš”ì²­ ì‹¤íŒ¨`);
            }
          }
        } catch (e) {
          console.error(`[ë‚˜ê°€ê¸° 2/5] ê´€ì‹¬ë¶„ì•¼ ë‚˜ê°€ê¸° ì²˜ë¦¬ ì‹¤íŒ¨:`, e);
        }
        
        // 3. ì±„íŒ…ë°© ëª©ë¡ì—ì„œ ì œê±° (ì¦‰ì‹œ)
        const beforeCount = chatData.roomList.length;
        chatData.roomList = chatData.roomList.filter(room => room.name !== roomToLeave);
        console.log(`[ë‚˜ê°€ê¸° 3/5] ì±„íŒ…ë°© ëª©ë¡ì—ì„œ ì œê±°: ${roomToLeave} (${beforeCount}ê°œ â†’ ${chatData.roomList.length}ê°œ)`);
        
        // 4. ì±„íŒ… ê¸°ë¡ ì‚­ì œ
        if (chatData.rooms[roomToLeave]) {
            delete chatData.rooms[roomToLeave];
            console.log(`[ë‚˜ê°€ê¸° 4/5] ${roomToLeave}ì˜ ì±„íŒ… ê¸°ë¡ ì‚­ì œ`);
        }
        
        // 5. ê·¸ë£¹ ì±„íŒ…ë°©ì¸ ê²½ìš° ì°¸ì—¬ì ìˆ˜ ê°ì†Œ
        if (roomParticipants[roomToLeave]) {
          roomParticipants[roomToLeave].count = Math.max(0, roomParticipants[roomToLeave].count - 1);
          
          // ì°¸ì—¬ì ëª©ë¡ì—ì„œ í˜„ì¬ ì‚¬ìš©ì ì œê±°
          const userIndex = roomParticipants[roomToLeave].users.indexOf(currentUser);
          if (userIndex > -1) {
            roomParticipants[roomToLeave].users.splice(userIndex, 1);
          }
        }
        
        // 6. ë°ì´í„° ì €ì¥ (í•„í„°ë§ í¬í•¨)
        saveChatData();
        console.log(`[ë‚˜ê°€ê¸° 5/5] ë°ì´í„° ì €ì¥ ì™„ë£Œ`);
        
        // 7. UI ì—…ë°ì´íŠ¸
        updateRoomListUI();
        
        // 8. ê´€ì‹¬ë¶„ì•¼ ëª©ë¡ë„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ìƒˆë¡œê³ ì¹¨ ì—†ì´)
        const profile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
        if (profile && profile.interests) {
          updateInterestList(profile.interests);
          console.log(`[ë‚˜ê°€ê¸° ì™„ë£Œ] ê´€ì‹¬ë¶„ì•¼ ëª©ë¡ ì—…ë°ì´íŠ¸: ${profile.interests.length}ê°œ í‘œì‹œ`);
        }
        
        console.log(`[ë‚˜ê°€ê¸° ì™„ë£Œ] ${roomToLeave} ë°© ë‚˜ê°€ê¸° ì™„ë£Œ, UI ì—…ë°ì´íŠ¸ë¨`);
        
        // í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
        backToHome();
        alert('ì±„íŒ…ë°©ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤.');
      }
      document.getElementById('chatOptionsDropdown').style.display = 'none';
    }
    
    // ë°©ë³„ ì°¸ì—¬ì ìˆ˜ ì—…ë°ì´íŠ¸
    function updateRoomParticipantCount(roomName) {
      document.querySelectorAll('.room-list li').forEach(li => {
        const roomInfo = li.querySelector('.room-info');
        if (roomInfo) {
          const roomNameSpan = roomInfo.querySelector('.room-name');
          if (roomNameSpan && roomNameSpan.textContent === roomName) {
            const countSpan = roomInfo.querySelector('.participant-count');
            const newCount = roomParticipants[roomName]?.count || 0;
            countSpan.textContent = `${newCount}ëª…`;
          }
        }
      });
    }
    
    // ë°©ë³„ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì—…ë°ì´íŠ¸
    function updateRoomUnreadCount(roomName) {
      document.querySelectorAll('.room-list li').forEach(li => {
        const roomInfo = li.querySelector('.room-info');
        if (roomInfo) {
          const roomNameSpan = roomInfo.querySelector('.room-name');
          if (roomNameSpan && roomNameSpan.textContent === roomName) {
            const roomNameWrapper = roomInfo.querySelector('.room-name-wrapper');
            const unreadCount = roomParticipants[roomName]?.unreadCount || 0;
            
            // ê¸°ì¡´ ë°°ì§€ ì œê±°
            const existingBadge = roomNameWrapper.querySelector('.unread-badge');
            if (existingBadge) {
              existingBadge.remove();
            }
            
            // ìƒˆ ë°°ì§€ ì¶”ê°€ (ì½ì§€ ì•Šì€ ë©”ì‹œì§€ê°€ ìˆì„ ë•Œë§Œ)
            if (unreadCount > 0) {
              const badge = document.createElement('span');
              badge.className = 'unread-badge';
              badge.textContent = unreadCount;
              roomNameWrapper.appendChild(badge);
            }
          }
        }
      });
    }
    
    // ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì¦ê°€ (ìƒëŒ€ë°© ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ)
    function incrementUnreadCount(roomName) {
      if (roomName !== currentRoom && roomParticipants[roomName]) {
        roomParticipants[roomName].unreadCount++;
        updateRoomUnreadCount(roomName);
      }
    }
    
    // ì„œë²„ì—ì„œ ìµëª… í”„ë¡œí•„ ê°€ì ¸ì˜¤ê¸°
    async function loadRandomProfiles() {
      try {
        const response = await fetch("{{ url_for('get_anon_profiles') }}");
        const result = await response.json();
        
        if (result.success && result.profiles) {
          // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
          randomProfiles.length = 0; // ë°°ì—´ ì´ˆê¸°í™”
          randomProfiles.push(...result.profiles);
          
          // UI ì—…ë°ì´íŠ¸
          generateRandomProfiles();
        } else {
          console.error('í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', result.message);
        }
      } catch (error) {
        console.error('í”„ë¡œí•„ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }
    
    // ëœë¤ ë§¤ì¹­ í”„ë¡œí•„ ìƒì„±
    function generateRandomProfiles() {
      const container = document.getElementById('profileCardsContainer');
      container.innerHTML = '';
      
      if (randomProfiles.length === 0) {
        container.innerHTML = '<div style="padding: 40px; text-align: center; color: #999; width: 100%;">í˜„ì¬ ë§¤ì¹­ ê°€ëŠ¥í•œ í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      randomProfiles.forEach(profile => {
        const card = document.createElement('div');
        card.className = 'random-profile-card';
        card.innerHTML = `
          <div class="random-profile-avatar">${profile.avatar}</div>
          <div class="random-profile-name">${profile.nickname}</div>
          <div class="random-profile-details">${profile.year} Â· ${profile.gender}</div>
          <div class="random-profile-bio">${profile.bio || 'ì•ˆë…•í•˜ì„¸ìš”!'}</div>
          <button class="random-profile-btn" onclick="viewProfile('${profile.nickname}')">í”„ë¡œí•„ ë³´ê¸°</button>
        `;
        container.appendChild(card);
      });
    }
    
    // í”„ë¡œí•„ ë³´ê¸°
    function viewProfile(profileNickname) {
      const profile = randomProfiles.find(p => p.nickname === profileNickname);
      if (profile) {
        const modalContent = document.getElementById('profileDetailContent');
        
        // ê´€ì‹¬ì‚¬ íƒœê·¸ ìƒì„±
        const interestsHtml = profile.interests.map(interest => 
          `<span class="profile-detail-interest-tag">${interest}</span>`
        ).join('');
        
        modalContent.innerHTML = `
          <div class="profile-detail-avatar">${profile.avatar}</div>
          <div class="profile-detail-name">${profile.nickname}</div>
          <div class="profile-detail-info">${profile.year} Â· ${profile.gender}</div>
          <div class="profile-detail-bio">${profile.bio || 'ì•ˆë…•í•˜ì„¸ìš”!'}</div>
          <div class="profile-detail-interests">
            <div class="profile-detail-interests-title">ê´€ì‹¬ì‚¬</div>
            <div class="profile-detail-interests-list">
              ${interestsHtml}
            </div>
          </div>
          <div class="profile-detail-actions">
            <button class="profile-detail-btn secondary" onclick="closeProfileDetailModal()">ë‹«ê¸°</button>
          </div>
        `;
        
        document.getElementById('profileDetailModal').style.display = 'flex';
      }
    }
    
    // í”„ë¡œí•„ ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
    function closeProfileDetailModal() {
      document.getElementById('profileDetailModal').style.display = 'none';
    }
    
    
    // í”„ë¡œí•„ ìºëŸ¬ì…€ ìŠ¤í¬ë¡¤
    function scrollProfiles(direction) {
      const container = document.getElementById('profileCardsContainer');
      const scrollAmount = 220; // ì¹´ë“œ ë„ˆë¹„ + ê°„ê²©
      container.scrollBy({
        left: direction * scrollAmount,
        behavior: 'smooth'
      });
    }

    // ìµëª… í”„ë¡œí•„ ì²´í¬ í•¨ìˆ˜
    function checkAnonProfile() {
      try {
        const profile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
        
        // í”„ë¡œí•„ì´ ì—†ê±°ë‚˜ í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ëœ ê²½ìš°
        if (!profile || !profile.year || !profile.gender || !profile.interests || profile.interests.length === 0) {
          // í”„ë¡œí•„ ì„¤ì • í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
          alert('ëœë¤ ë§¤ì¹­ì„ ì´ìš©í•˜ë ¤ë©´ ë¨¼ì € ìµëª… í”„ë¡œí•„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”!');
          window.spaRouter.navigateTo('/profile-setup');
          return false;
        }
        return true;
      } catch (e) {
        console.error('í”„ë¡œí•„ ì²´í¬ ì‹¤íŒ¨:', e);
        alert('ëœë¤ ë§¤ì¹­ì„ ì´ìš©í•˜ë ¤ë©´ ë¨¼ì € ìµëª… í”„ë¡œí•„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”!');
        window.spaRouter.navigateTo('/profile-setup');
        return false;
      }
    }

    // ì„œë²„ì—ì„œ ì‚¬ìš©ìì˜ ë°© ëª©ë¡ ë¡œë“œ
    async function loadUserRoomsFromServer() {
      try {
        const response = await fetch('/api/rooms');
        const result = await response.json();
        
        if (result.success && result.rooms) {
          // ì„œë²„ì—ì„œ ë°›ì€ ë°© ëª©ë¡ê³¼ ë¡œì»¬ ë°© ëª©ë¡ ë¹„êµ
          const serverRooms = result.rooms;
          const currentRoomNames = chatData.roomList.map(room => room.name);
          
          for (const serverRoom of serverRooms) {
            if (!currentRoomNames.includes(serverRoom.room_name)) {
              // ìƒˆë¡œìš´ ë°©ì„ ë¡œì»¬ì— ì¶”ê°€
              const newRoom = {
                name: serverRoom.room_name,
                type: serverRoom.type,
                roomId: serverRoom.room_id,
                unreadCount: 0,
                createdAt: serverRoom.created_at
              };
              
              chatData.roomList.push(newRoom);
              
              // roomParticipantsì— ì¶”ê°€
              if (serverRoom.type === 'dm') {
                roomParticipants[serverRoom.room_name] = {
                  count: 2,
                  users: [serverRoom.room_name],
                  unreadCount: 0
                };
              }
              
              // ì±„íŒ…ë°© ë°ì´í„° ì´ˆê¸°í™”
              if (!chatData.rooms[serverRoom.room_name]) {
                chatData.rooms[serverRoom.room_name] = [];
              }
              
              console.log(`[ì„œë²„ ë™ê¸°í™”] ìƒˆë¡œìš´ ë°© ë°œê²¬: ${serverRoom.room_name} (${serverRoom.type})`);
            }
          }
          
          if (serverRooms.length > 0) {
            saveChatData();
            updateRoomListUI();
            console.log(`[ì„œë²„ ë™ê¸°í™”] ${serverRooms.length}ê°œ ë°© ë™ê¸°í™” ì™„ë£Œ`);
          }
        }
      } catch (error) {
        console.error('ì„œë²„ ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.addEventListener('DOMContentLoaded', function() {
      // ìµëª… í”„ë¡œí•„ ì²´í¬
      if (!checkAnonProfile()) {
        return; // í”„ë¡œí•„ì´ ì—†ìœ¼ë©´ ì´ˆê¸°í™” ì¤‘ë‹¨
      }
      
      // ë…„ë„ ì„¤ì •
      document.getElementById('year').textContent = new Date().getFullYear();
      
      // ì±„íŒ… ë°ì´í„° ë¡œë“œ
      loadChatData();
      
      // ì„œë²„ì—ì„œ ì‚¬ìš©ìì˜ ë°© ëª©ë¡ ë™ê¸°í™”
      loadUserRoomsFromServer();
      
      // ë‚˜ê°„ ì±„íŒ…ë°© í™•ì‹¤íˆ ì œê±° (í˜ì´ì§€ ë¡œë“œ ì‹œ)
      const leftRooms = JSON.parse(localStorage.getItem('leftRooms') || '[]');
      if (leftRooms.length > 0) {
        console.log(`[í˜ì´ì§€ ë¡œë“œ] ë‚˜ê°„ ë°© ${leftRooms.length}ê°œ í™•ì¸:`, leftRooms);
        const beforeCount = chatData.roomList.length;
        chatData.roomList = chatData.roomList.filter(room => !leftRooms.includes(room.name));
        const afterCount = chatData.roomList.length;
        if (beforeCount !== afterCount) {
          console.log(`[í˜ì´ì§€ ë¡œë“œ] ${beforeCount - afterCount}ê°œ ì±„íŒ…ë°© ì œê±°ë¨ (${beforeCount} â†’ ${afterCount})`);
          saveChatData();
        }
      }
      
      updateRoomListUI();
      
      // ê´€ì‹¬ë¶„ì•¼ ëª©ë¡ ë‹¤ì‹œ ë Œë”ë§ (ë‚˜ê°„ ë°©ê³¼ ê´€ê³„ì—†ì´ í•­ìƒ í‘œì‹œ)
      const profile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
      if (profile && profile.interests) {
        updateInterestList(profile.interests);
        console.log(`[í˜ì´ì§€ ë¡œë“œ] ê´€ì‹¬ë¶„ì•¼ ëª©ë¡ ${profile.interests.length}ê°œ ë‹¤ì‹œ ë Œë”ë§`);
      }
      
      // ì±„íŒ… ì˜µì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById('chatOptions').addEventListener('click', toggleChatOptions);
      
      // ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('chatOptionsDropdown');
        const optionsBtn = document.getElementById('chatOptions');
        
        if (!dropdown.contains(e.target) && !optionsBtn.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });
      
      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      document.addEventListener('click', function(e) {
        const participantsModal = document.getElementById('participantsModal');
        const participantProfileModal = document.getElementById('participantProfileModal');
        const profileDetailModal = document.getElementById('profileDetailModal');
        
        if (e.target === participantsModal) {
          closeParticipantsModal();
        }
        
        if (e.target === participantProfileModal) {
          closeParticipantProfileModal();
        }
        
        if (e.target === profileDetailModal) {
          closeProfileDetailModal();
        }
      });
      
      // ì„œë²„ì—ì„œ ë°›ì€ í”„ë¡œí•„ì´ ìˆìœ¼ë©´ localStorageì— ì €ì¥
      {% if anon_profile %}
      const serverProfile = {{ anon_profile|tojson|safe }};
      if (serverProfile && Object.keys(serverProfile).length > 0) {
        localStorage.setItem('anonProfile', JSON.stringify(serverProfile));
        console.log('ì„œë²„ í”„ë¡œí•„ì„ localStorageì— ì €ì¥:', serverProfile);
      } else {
        // ì„œë²„ì— í”„ë¡œí•„ì´ ì—†ìœ¼ë©´ localStorageì˜ ì´ì „ í”„ë¡œí•„ ì‚­ì œ
        localStorage.removeItem('anonProfile');
        console.log('ì„œë²„ì— ìµëª… í”„ë¡œí•„ì´ ì—†ì–´ localStorageì—ì„œ ì‚­ì œ');
      }
      {% else %}
      // ì„œë²„ì— í”„ë¡œí•„ì´ ì—†ìœ¼ë©´ localStorageì˜ ì´ì „ í”„ë¡œí•„ ì‚­ì œ
      localStorage.removeItem('anonProfile');
      console.log('ì„œë²„ì— ìµëª… í”„ë¡œí•„ì´ ì—†ì–´ localStorageì—ì„œ ì‚­ì œ');
      {% endif %}
      
      loadAnonProfile();
      
      // ì„œë²„ì—ì„œ ê´€ì‹¬ì‚¬ë³„ ì°¸ì—¬ì ìˆ˜ ë¡œë“œ
      loadInterestCounts();
      
      // ì„œë²„ì—ì„œ ëœë¤ ë§¤ì¹­ í”„ë¡œí•„ ë¡œë“œ
      loadRandomProfiles();
      
      // ê¸°ë³¸ ê´€ì‹¬ë¶„ì•¼ ë°©ë“¤ì„ ì±„íŒ…ë°© ëª©ë¡ì— ì¶”ê°€
      initializeDefaultInterestRooms();
      
      // ë§¤ì¹­ ë²„íŠ¼
      document.getElementById('startRandom').addEventListener('click', startRandomMatching);
      document.getElementById('startGroup').addEventListener('click', startGroupMatching);
      document.getElementById('cancelRandom').addEventListener('click', cancelRandomMatching);
      document.getElementById('cancelGroup').addEventListener('click', cancelGroupMatching);
      
      // ë©”ì‹œì§€ ì „ì†¡
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

      // ëœë¤ ë§¤ì¹­ í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
      document.getElementById('backToHome').addEventListener('click', backToHome);
      
      // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ ê´€ì‹¬ë¶„ì•¼ ëª©ë¡ ì—…ë°ì´íŠ¸ (ë§ˆì´í˜ì´ì§€ì—ì„œ ìˆ˜ì • í›„ ëŒì•„ì™”ì„ ë•Œ)
      window.addEventListener('focus', function() {
        const profile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
        if (profile && profile.interests) {
          updateInterestList(profile.interests);
          console.log(`[í˜ì´ì§€ í¬ì»¤ìŠ¤] ê´€ì‹¬ë¶„ì•¼ ëª©ë¡ ì—…ë°ì´íŠ¸: ${profile.interests.length}ê°œ`);
        }
      });
      
      // í˜ì´ì§€ ë³´ì´ê¸° ì´ë²¤íŠ¸ (íƒ­ ì „í™˜ ì‹œ)
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
          const profile = JSON.parse(localStorage.getItem('anonProfile') || 'null');
          if (profile && profile.interests) {
            updateInterestList(profile.interests);
            console.log(`[í˜ì´ì§€ ê°€ì‹œí™”] ê´€ì‹¬ë¶„ì•¼ ëª©ë¡ ì—…ë°ì´íŠ¸: ${profile.interests.length}ê°œ`);
          }
        }
      });

      // ëª¨ë°”ì¼ ë©”ë‰´ëŠ” navigation.jsì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤
    });
    </script>
    <script src="{{ url_for("static", filename="js/script.js") }}"></script>
    <script src="{{ url_for("static", filename="js/navigation.js") }}"></script>
    <script src="{{ url_for("static", filename="js/router.js") }}"></script>
</body>
</html>